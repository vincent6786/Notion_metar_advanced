<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot EFB V45</title>
    <style>
        :root {
            --bg: #000000; --card-bg: #1c1c1e; --text: #ffffff; --sub-text: #8e8e93;
            --border: #38383a; --accent: #0a84ff; 
            --danger: #ff453a; --warn: #ff9f0a; --success: #32d74b;
            --mvfr: #0a84ff; --lifr: #bf5af2; --strip-bg: #2c2c2e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 12px; font-size: 14px; line-height: 1.4;
            display: flex; flex-direction: column; gap: 12px;
            max-width: 100vw; overflow-x: hidden;
        }

        /* HEADER */
        .top-bar { display: flex; align-items: center; gap: 8px; height: 40px; }
        .search-box {
            flex-grow: 1; background: var(--card-bg); border-radius: 8px; 
            display: flex; align-items: center; border: 1px solid var(--border);
            padding-left: 8px; transition: border-color 0.2s;
        }
        .search-box:focus-within { border-color: var(--accent); }
        #icao {
            flex-grow: 1; background: transparent; border: none; color: #fff; 
            padding: 8px 4px; text-transform: uppercase; font-weight: 700; 
            font-size: 16px; outline: none; width: 100%;
        }
        .icon-btn { 
            background: var(--card-bg); border: 1px solid var(--border); color: var(--accent); 
            width: 40px; height: 100%; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px;
        }
        .badge { height: 100%; display: flex; align-items: center; justify-content: center; padding: 0 12px; border-radius: 8px; font-weight: 700; font-size: 15px; min-width: 60px; }
        .badge-cat { background: var(--card-bg); color: var(--sub-text); }
        .cat-vfr { background-color: var(--success) !important; color: #000 !important; }
        .cat-mvfr { background-color: var(--mvfr) !important; color: #fff !important; }
        .cat-ifr { background-color: var(--danger) !important; color: #fff !important; }
        .cat-lifr { background-color: var(--lifr) !important; color: #fff !important; }

        /* TABS */
        .tabs { display: flex; border-bottom: 1px solid var(--border); gap: 20px; padding: 0 4px; overflow-x: auto; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { padding: 10px 0; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--sub-text); border-bottom: 2px solid transparent; text-transform: uppercase; white-space: nowrap; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* CONTENT */
        .view-section { display: none; animation: fadeIn 0.2s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .info-card { background: var(--card-bg); padding: 10px; border-radius: 8px; border: 1px solid #2c2c2e; }
        .ic-lbl { font-size: 10px; color: var(--sub-text); text-transform: uppercase; font-weight: 700; }
        .ic-val { font-size: 15px; font-weight: 600; color: #fff; margin-top: 2px; }
        .section-title { font-weight:700; color:var(--sub-text); margin: 20px 0 8px 0; font-size:11px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* FREQUENCIES */
        .freq-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; }
        .freq-card { background: var(--card-bg); border-radius: 8px; padding: 10px; text-align: center; border: 1px solid #2c2c2e; }
        .freq-val { font-size: 15px; font-weight: 700; color: var(--accent); font-family: 'SF Mono', monospace; }

        /* RUNWAY & WIND */
        .wind-vis-container { background: var(--card-bg); border-radius: 8px; padding: 12px; display: flex; gap: 15px; align-items: center; border: 1px solid #2c2c2e; }
        .rc-strip { height: 44px; background: var(--strip-bg); border-radius: 8px; display: flex; align-items: center; justify-content: space-between; padding: 0 6px; position: relative; margin-bottom: 16px; }
        .rc-id-v { font-size: 12px; font-weight: 700; writing-mode: vertical-rl; transform: rotate(180deg); }
        
        /* WORLD CLOCK */
        .world-grid { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; }
        .clock-card { background: var(--card-bg); border-radius: 8px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #2c2c2e; }
        .clock-time { font-family: 'SF Mono', monospace; font-size: 26px; font-weight: 400; color: #fff; letter-spacing: -0.5px; }
        .clock-utc { color: var(--success); font-weight: 600; }

        /* TOOLS & UTILS */
        .metar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .metar-card { background: var(--card-bg); border-radius: 8px; padding: 10px; border: 1px solid #2c2c2e; }
        .raw-text { font-family: 'SF Mono', monospace; font-size: 11px; color: #d0d0d0; margin-top: 6px; line-height: 1.4; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; word-break: break-all; }
        
        /* SPINNER */
        .spinner {
            width: 16px; height: 16px; border: 2px solid var(--sub-text); border-top: 2px solid var(--accent);
            border-radius: 50%; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading .spinner { display: block; }
        .loading .search-icon { display: none; }

        .hidden { display: none !important; }
        .btn-act { background: var(--accent); color: #fff; border:none; padding: 4px 12px; border-radius:4px; cursor:pointer; font-weight:600; }
        input, select, button { outline: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="search-box" id="searchContainer">
            <span class="search-icon">üîç</span>
            <div class="spinner"></div>
            <input type="text" id="icao" list="airports" placeholder="Search..." onkeydown="if(event.key==='Enter') loadData()">
            <span style="color:#888; padding:0 8px; cursor:pointer;" onclick="document.getElementById('icao').value='';document.getElementById('icao').focus()">‚úñ</span>
        </div>
        <datalist id="airports"><option value="RCTP"><option value="RCSS"><option value="KMCC"><option value="RJAA"><option value="VHHH"></datalist>
        
        <div id="headerCat" class="badge badge-cat">--</div>
        <button class="icon-btn" onclick="loadData()" title="Refresh">‚ü≥</button>
        <a id="linkSkyVector" href="#" target="_blank" class="icon-btn" title="Map">üó∫Ô∏è</a>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setTab('metar')">METAR</div>
        <div class="tab" onclick="setTab('taf')">TAF</div>
        <div class="tab" onclick="setTab('info')">INFO</div>
        <div class="tab" onclick="setTab('atc')">ATC</div>
        <div class="tab" onclick="setTab('world')">WORLD</div>
        <div class="tab" onclick="setTab('tools')">TOOLS</div>
    </div>

    <div id="tab-metar" class="view-section active">
        <div class="wind-vis-container">
            <canvas id="windRose" width="140" height="140" style="width:140px; height:140px;"></canvas>
            <div style="flex-grow:1; display:flex; flex-direction:column; gap:8px;">
                <div class="ic-lbl">Selected Runway</div>
                <select id="rwySelect" style="background:#2c2c2e; color:#fff; border:1px solid #38383a; padding:6px; border-radius:6px; width:100%;" onchange="drawWindRose()"></select>
                <div style="font-family:'SF Mono',monospace; font-size:13px; margin-top:4px;">
                    <div style="display:flex; justify-content:space-between;"><span style="color:#8e8e93">Headwind</span> <span id="valHW">--</span></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:#8e8e93">Crosswind</span> <span id="valXW">--</span></div>
                </div>
            </div>
        </div>
        <div class="raw-text" id="rawMetar">Enter an airport code above.</div>
        <div class="metar-grid">
            <div class="metar-card"><div class="ic-lbl">WIND</div><div class="ic-val" id="mWind">--</div></div>
            <div class="metar-card"><div class="ic-lbl">VISIBILITY</div><div class="ic-val" id="mVis">--</div></div>
            <div class="metar-card"><div class="ic-lbl">CEILING</div><div class="ic-val" id="mCeil">--</div></div>
            <div class="metar-card"><div class="ic-lbl">ALTIMETER</div><div class="ic-val" id="mAlt">--</div></div>
            <div class="metar-card" style="grid-column:span 2"><div class="ic-lbl">TEMP / DEW</div><div class="ic-val"><span id="mTempC">--</span> <span id="mTempF" style="font-size:13px; color:#888;">--</span></div></div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:8px; color:#888; font-size:11px;"><span id="mAge">--</span><span id="mSpread">Spread: --</span></div>
    </div>

    <div id="tab-taf" class="view-section">
        <div style="display:flex; justify-content:space-between; color:#888; font-size:11px; margin-bottom:8px;"><span>Forecast</span><span id="tafIssued">--</span></div>
        <div style="background:#2c2c2e; height:32px; border-radius:6px; display:flex; overflow:hidden;" id="tafBar"></div>
        <div style="display:flex; margin-top:4px; font-family:'SF Mono'; font-size:10px; color:#888;" id="tafAxis"></div>
        <div id="tafDetail" class="info-card hidden" style="margin-top:10px; border-left:4px solid #888;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span id="tdTime" style="font-weight:700;">--</span><span id="tdType" style="background:#444; padding:2px 6px; border-radius:4px; font-size:10px;">--</span></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div><div class="ic-lbl">Wind</div><div id="tdWind" style="font-weight:600;">--</div></div>
                <div><div class="ic-lbl">Vis</div><div id="tdVis" style="font-weight:600;">--</div></div>
                <div><div class="ic-lbl">Wx</div><div id="tdWx" style="font-weight:600;">--</div></div>
                <div><div class="ic-lbl">Clouds</div><div id="tdCloud" style="font-weight:600;">--</div></div>
            </div>
        </div>
        <div class="section-title">Raw Text</div>
        <div class="raw-text" id="rawTaf">Loading...</div>
        <div class="section-title">NOTAMs</div>
        <div id="notamList" class="raw-text" style="max-height:200px; overflow-y:auto;">Loading...</div>
    </div>

    <div id="tab-info" class="view-section">
        <div style="font-size:20px; font-weight:700;" id="infoName">Unknown</div>
        <div style="font-size:12px; color:#888; margin-bottom:12px;" id="infoLoc">--</div>
        
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">ICAO / IATA</div><div class="ic-val" id="infoCodes">--</div></div>
            <div class="info-card"><div class="ic-lbl">Elevation</div><div class="ic-val" id="infoElev">--</div></div>
        </div>

        <div class="section-title">FREQUENCIES</div>
        <div id="freqContainer" class="freq-grid"></div>

        <div class="section-title">ATMOSPHERE</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">Pressure Alt</div><div class="ic-val" id="calcPA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Density Alt</div><div class="ic-val" id="calcDA">--</div></div>
            <div class="info-card"><div class="ic-lbl">ISA Dev</div><div class="ic-val" id="calcISA">--</div></div>
            <div class="info-card"><div class="ic-lbl">UTC Offset</div><div class="ic-val" id="calcOffset">--</div></div>
        </div>

        <div class="section-title">RUNWAYS</div>
        <div id="runwayListComplex"></div>
    </div>

    <div id="tab-atc" class="view-section">
        <div class="info-card" style="margin-bottom:20px;">
            <div class="ic-lbl" style="margin-bottom:8px;">RCTP ATIS (Live Stream)</div>
            <audio controls style="width:100%; height:32px; filter:invert(0.9);"><source src="https://stream.twatc.net/RCTP_ATIS" type="audio/mpeg"></audio>
        </div>
        <div class="section-title">LINKS</div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <a href="https://beta.twatc.net/" target="_blank" class="info-card" style="text-decoration:none; color:#fff; display:flex; justify-content:space-between;"><b>üáπüáº Virtual ATC</b><span>‚Üó</span></a>
            <a href="https://www.liveatc.net/" target="_blank" class="info-card" style="text-decoration:none; color:#fff; display:flex; justify-content:space-between;"><b>üì° LiveATC.net</b><span>‚Üó</span></a>
        </div>
    </div>

    <div id="tab-world" class="view-section">
        <div style="display:flex; gap:8px; margin-bottom:10px;">
            <input type="text" id="newCityInput" list="cityData" placeholder="Add City..." style="flex:1; padding:8px; border-radius:6px; border:1px solid #38383a; background:#1c1c1e; color:#fff;">
            <datalist id="cityData"></datalist>
            <button class="btn-act" onclick="addCustomCity()">+</button>
        </div>
        <div id="worldContainer" class="world-grid"></div>
    </div>

    <div id="tab-tools" class="view-section">
        <div class="section-title" style="margin-top:0;">METAR Helper</div>
        <input type="text" placeholder="Code (e.g. +TSRA)" style="width:100%; padding:8px; border-radius:6px; border:1px solid #38383a; background:#1c1c1e; color:#fff;" oninput="decode(this.value)">
        <div id="decodeOut" style="color:var(--accent); font-weight:700; margin-top:4px; min-height:20px;">...</div>
        
        <div class="section-title">Timer</div>
        <div class="info-card">
            <div id="timerDisplay" style="font-family:'SF Mono'; font-size:32px; text-align:center; font-weight:700;">00:00:00</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:8px;">
                <button class="btn-act" style="background:var(--success); color:#000;" onclick="startTimer()">Start</button>
                <button class="btn-act" onclick="lapTimer()">Lap</button>
                <button class="btn-act" style="background:var(--danger);" onclick="stopTimer()">Stop</button>
            </div>
            <div id="lapList" style="max-height:80px; overflow-y:auto; margin-top:8px; font-size:12px; font-family:'SF Mono';"></div>
        </div>
        
        <div class="section-title">ISA Calc</div>
        <div class="info-card" style="display:flex; gap:8px;">
            <div style="flex:1"><div class="ic-lbl">Alt (ft)</div><input type="number" id="isaInput" oninput="calcIsaTool()" style="width:100%; background:transparent; border:none; color:#fff; border-bottom:1px solid #555;"></div>
            <div style="flex:1"><div class="ic-lbl">Temp</div><div id="isaTempOut" class="ic-val">--</div></div>
        </div>
    </div>

    <script>
        const TOKEN = 'dMzS0-M9_ku1bYySTtsq4pZE8fEEiTUJaNtvqSDEgUs';
        
        // --- STATE ---
        let currentWind = { dir:0, spd:0 }, currentMetar = { temp: 15, alt: 1013, altUnit: 'hPa' };
        let stationData = null, useMetric = true, tafDataCache = null;
        let cityList = [], timerInterval = null, startTime = 0, elapsed = 0, running = false;

        // --- CORE FUNCTIONS ---
        function setTab(name) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+name).classList.add('active');
            event.target.classList.add('active');
            if(name==='info' && stationData) renderRunwaysComplex();
        }

        async function loadData() {
            const icao = document.getElementById('icao').value.toUpperCase();
            if(!icao) return;
            document.getElementById('icao').blur();
            document.getElementById('linkSkyVector').href = `https://skyvector.com/airport/${icao}`;
            
            // Loading UI
            document.getElementById('searchContainer').classList.add('loading');
            updateHeaderCat('Load', 'cat-vfr');

            const headers = { 'Authorization': `Bearer ${TOKEN}` };
            try {
                // Parallel Fetch
                const [station, metar, taf, notam] = await Promise.all([
                    fetch(`https://avwx.rest/api/station/${icao}`, {headers}).then(r=>r.ok?r.json():null),
                    fetch(`https://avwx.rest/api/metar/${icao}`, {headers}).then(r=>r.ok?r.json():null),
                    fetch(`https://avwx.rest/api/taf/${icao}`, {headers}).then(r=>r.ok?r.json():null),
                    fetch(`https://avwx.rest/api/notam/${icao}`, {headers}).then(r=>r.ok?r.json():null)
                ]);

                if(station) {
                    stationData = station;
                    renderInfo(station);
                    const sel = document.getElementById('rwySelect'); sel.innerHTML = '';
                    (station.runways||[]).forEach(r => { sel.add(new Option(`RWY ${r.ident1}`, r.ident1)); sel.add(new Option(`RWY ${r.ident2}`, r.ident2)); });
                    if(station.runways.length>0) sel.value = station.runways[0].ident1;
                }
                
                if(metar) {
                    currentWind = { dir: metar.wind_direction?.value||0, spd: metar.wind_speed?.value||0 };
                    let altVal = metar.altimeter?.value || 1013, altUnit = altVal < 200 ? 'inHg' : 'hPa';
                    currentMetar = { temp: metar.temperature?.value||15, alt: altVal, altUnit: altUnit };
                    renderMetar(metar);
                    drawWindRose();
                }

                if(taf) renderTaf(taf);
                if(notam) document.getElementById('notamList').innerHTML = notam.map(n => `<div style="margin-bottom:8px; border-left:3px solid var(--warn); padding-left:6px;">${n.raw}</div>`).join('');

            } catch(e) { console.error(e); updateHeaderCat('Err', 'cat-ifr'); }
            document.getElementById('searchContainer').classList.remove('loading');
        }

        // --- RENDERERS ---
        function updateHeaderCat(status, colorClass) {
            const badge = document.getElementById('headerCat'); badge.innerText = status; badge.className = 'badge badge-cat ' + colorClass;
        }

        function renderMetar(d) {
            document.getElementById('rawMetar').innerText = d.raw;
            const rules = d.flight_rules; 
            let css = 'cat-vfr'; if(rules==='MVFR') css='cat-mvfr'; if(rules==='IFR') css='cat-ifr'; if(rules==='LIFR') css='cat-lifr';
            updateHeaderCat(rules, css);
            
            document.getElementById('mWind').innerText = `${currentWind.dir.toString().padStart(3,'0')}¬∞ / ${currentWind.spd}kt`;
            document.getElementById('mVis').innerText = `${d.visibility?.value} sm`;
            const c = d.clouds?.[0]; document.getElementById('mCeil').innerText = c ? `${c.type} ${c.altitude.toString().padStart(3,'0')}` : "CLR";
            
            // Altimeter
            const alt = d.altimeter?.value;
            if(currentMetar.altUnit === 'hPa') document.getElementById('mAlt').innerText = `Q${alt} / A${(alt*0.02953).toFixed(2)}`;
            else document.getElementById('mAlt').innerText = `Q${Math.round(alt*33.8639)} / A${alt.toFixed(2)}`;

            const t = d.temperature?.value, dew = d.dewpoint?.value;
            if(t!=null) {
                document.getElementById('mTempC').innerText = `${t}¬∞C / ${dew!=null?dew:'--'}¬∞C`;
                document.getElementById('mTempF').innerText = `(${Math.round(t*1.8+32)}¬∞F)`;
            }
            const minAgo = Math.floor((new Date() - new Date(d.time.dt)) / 60000);
            document.getElementById('mAge').innerText = `${minAgo}m ago`;
        }

        function renderInfo(d) {
            document.getElementById('infoName').innerText = d.name;
            document.getElementById('infoLoc').innerText = `${d.city||''}, ${d.country||''} (${d.icao})`;
            document.getElementById('infoCodes').innerText = `${d.icao} / ${d.iata||'--'}`;
            document.getElementById('infoElev').innerText = `${d.elevation_ft} ft`;
            
            // Frequencies
            const fContainer = document.getElementById('freqContainer'); fContainer.innerHTML = '';
            if(d.frequencies && d.frequencies.length > 0) {
                const priority = { "ATIS":1, "TWR":2, "GND":3, "APP":4, "DEP":5 };
                d.frequencies.sort((a,b) => {
                    let pa=99, pb=99; for(let k in priority) if(a.type.includes(k)) pa=priority[k]; for(let k in priority) if(b.type.includes(k)) pb=priority[k]; return pa-pb;
                }).slice(0,6).forEach(f => {
                    fContainer.innerHTML += `<div class="freq-card"><div style="font-size:10px; color:#888;">${f.type}</div><div class="freq-val">${f.frequency}</div></div>`;
                });
            } else fContainer.innerHTML = `<div style="grid-column:span 3; text-align:center; color:#555;">No Data</div>`;

            // Calcs
            const pa = Math.round(d.elevation_ft + (1013.25 - (currentMetar.altUnit==='inHg'?currentMetar.alt*33.8639:currentMetar.alt)) * 30);
            const isaDev = Math.round(currentMetar.temp - (15 - (2*pa/1000)));
            const da = Math.round(pa + 120 * (currentMetar.temp - (15 - (2*pa/1000))));
            document.getElementById('calcPA').innerText = pa + ' ft';
            document.getElementById('calcDA').innerText = da + ' ft';
            document.getElementById('calcISA').innerText = (isaDev>=0?'+':'') + isaDev + '¬∞C';
            document.getElementById('calcOffset').innerText = `UTC ${Math.round(d.longitude/15)>=0?'+':''}${Math.round(d.longitude/15)}`;
            
            renderRunwaysComplex();
        }

        function renderRunwaysComplex() {
            const container = document.getElementById('runwayListComplex'); container.innerHTML = '';
            const d = stationData; if(!d || !d.runways) return;
            d.runways.forEach((r, idx) => {
                let dim = useMetric ? `${Math.round(r.length_ft*0.3048)}m` : `${r.length_ft}'`;
                const magVar = d.magnetic_variation || 0;
                const windMag = currentWind.dir - magVar;
                const rwyHdg = parseInt(r.ident1.replace(/\D/g,'')) * 10;
                const diff = (windMag - rwyHdg) * (Math.PI/180);
                const hw = Math.round(Math.cos(diff) * currentWind.spd);
                const xw = Math.round(Math.sin(diff) * currentWind.spd);
                const c1 = hw>=0?'var(--success)':'var(--danger)', c2 = hw<0?'var(--success)':'var(--danger)';
                const arrow = hw>=0?'‚¨Ü':'‚¨á';
                
                container.innerHTML += `
                <div class="rwy-complex">
                    <div class="rc-header"><div><span style="color:${c1}">${r.ident1}</span> / <span style="color:${c2}">${r.ident2}</span></div><div class="rc-dims">${dim}</div></div>
                    <div class="rc-strip"><div class="rc-id-v">${r.ident1}</div>
                    <div class="rc-data"><div class="wind-comp"><span>${Math.abs(hw)}kt</span><span style="color:${c1}">${arrow}</span></div>
                    <div class="wind-comp"><span>${Math.abs(xw)}kt</span><span style="color:#0a84ff">${xw>=0?'‚¨Ö':'‚û°'}</span></div>
                    <canvas id="miniRose_${idx}" class="rc-rose" width="36" height="36"></canvas></div>
                    <div class="rc-id-v" style="transform:rotate(0deg);">${r.ident2}</div></div>
                </div>`;
                setTimeout(()=>drawMiniRose(`miniRose_${idx}`, windMag - rwyHdg), 0);
            });
        }

        // --- DRAWING ---
        function drawWindRose() {
            const c = document.getElementById('windRose'), ctx = c.getContext('2d');
            ctx.clearRect(0,0,140,140); ctx.beginPath(); ctx.arc(70,70,60,0,2*Math.PI); ctx.strokeStyle='#555'; ctx.lineWidth=2; ctx.stroke();
            ctx.fillStyle='#888'; ctx.font='10px sans-serif'; ctx.textAlign='center'; 
            ctx.fillText('N',70,20); ctx.fillText('E',120,74); ctx.fillText('S',70,128); ctx.fillText('W',20,74);
            
            const rwyIdent = document.getElementById('rwySelect').value;
            if(rwyIdent) {
                const hdg = parseInt(rwyIdent.replace(/\D/g,'')) * 10;
                ctx.save(); ctx.translate(70,70); ctx.rotate((hdg-90)*Math.PI/180);
                ctx.fillStyle='#333'; ctx.fillRect(-45,-6,90,12); ctx.strokeStyle='#fff'; ctx.lineWidth=1; ctx.strokeRect(-45,-6,90,12);
                ctx.restore();
                
                // Update Calc Text
                const mv = stationData?.magnetic_variation||0;
                const diff = (currentWind.dir - mv - hdg) * (Math.PI/180);
                const hw = Math.round(Math.cos(diff)*currentWind.spd), xw = Math.round(Math.sin(diff)*currentWind.spd);
                document.getElementById('valHW').innerText = `${Math.abs(hw)}kt ${hw>=0?'Head':'Tail'}`;
                document.getElementById('valXW').innerText = `${Math.abs(xw)}kt ${xw>=0?'L':'R'}`;
            }
            if(currentWind.spd > 0) {
                const mv = stationData?.magnetic_variation||0;
                ctx.save(); ctx.translate(70,70); ctx.rotate((currentWind.dir-mv-90)*Math.PI/180);
                ctx.beginPath(); ctx.moveTo(55,0); ctx.lineTo(10,0); ctx.strokeStyle='#0a84ff'; ctx.lineWidth=3; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(15,-5); ctx.lineTo(5,0); ctx.lineTo(15,5); ctx.fillStyle='#0a84ff'; ctx.fill(); ctx.restore();
            }
        }
        function drawMiniRose(id, relDeg) {
            const c = document.getElementById(id); if(!c) return; const ctx = c.getContext('2d');
            ctx.clearRect(0,0,36,36); ctx.beginPath(); ctx.arc(18,18,14,0,2*Math.PI); ctx.strokeStyle='#555'; ctx.lineWidth=2; ctx.setLineDash([2,3]); ctx.stroke(); ctx.setLineDash([]);
            if(currentWind.spd>0) {
                ctx.save(); ctx.translate(18,18); ctx.rotate((relDeg-90)*Math.PI/180);
                ctx.beginPath(); ctx.moveTo(14,0); ctx.lineTo(4,0); ctx.strokeStyle='#0a84ff'; ctx.lineWidth=2; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(8,-3); ctx.lineTo(2,0); ctx.lineTo(8,3); ctx.fillStyle='#0a84ff'; ctx.fill(); ctx.restore();
            }
        }

        // --- WORLD CLOCK ---
        const AVIATION_CITIES = [{n:"Taipei",z:"Asia/Taipei",c:"RCTP"},{n:"New York",z:"America/New_York",c:"KJFK"},{n:"London",z:"Europe/London",c:"EGLL"},{n:"Tokyo",z:"Asia/Tokyo",c:"RJAA"},{n:"Los Angeles",z:"America/Los_Angeles",c:"KLAX"},{n:"Dubai",z:"Asia/Dubai",c:"OMDB"},{n:"Sydney",z:"Australia/Sydney",c:"YSSY"},{n:"Singapore",z:"Asia/Singapore",c:"WSSS"},{n:"Paris",z:"Europe/Paris",c:"LFPG"},{n:"Frankfurt",z:"Europe/Berlin",c:"EDDF"}];
        let cityList = [];
        
        function initWorld() {
            const dl = document.getElementById('cityData'); AVIATION_CITIES.forEach(c => { const o = document.createElement('option'); o.value = c.n; dl.appendChild(o); });
            const saved = localStorage.getItem('efb_cities_v45');
            cityList = saved ? JSON.parse(saved) : [{n:"UTC",z:"UTC",c:"ZULU",id:1}, {n:"Taipei",z:"Asia/Taipei",c:"RCTP",id:2}, {n:"New York",z:"America/New_York",c:"KJFK",id:3}];
            updateClock();
        }
        function addCustomCity() {
            const val = document.getElementById('newCityInput').value;
            const found = AVIATION_CITIES.find(c => c.n === val);
            if(found) { cityList.push({...found, id:Date.now()}); localStorage.setItem('efb_cities_v45', JSON.stringify(cityList)); updateClock(); }
            document.getElementById('newCityInput').value='';
        }
        function removeCity(id) { cityList = cityList.filter(c => c.id !== id); localStorage.setItem('efb_cities_v45', JSON.stringify(cityList)); updateClock(); }
        function updateClock() {
            const now = new Date();
            if(document.getElementById('tab-world').classList.contains('active')) {
                const con = document.getElementById('worldContainer'); con.innerHTML = '';
                cityList.forEach(c => {
                    const timeStr = now.toLocaleTimeString('en-US',{timeZone:c.z,hour:'2-digit',minute:'2-digit',hour12:false});
                    const div = document.createElement('div'); div.className = 'clock-card';
                    div.innerHTML = `<div class="clock-left"><div><span class="clock-city">${c.n}</span><span class="clock-codes">${c.c}</span></div></div><div style="display:flex;align-items:center;"><div class="clock-time ${c.z==='UTC'?'clock-utc':''}">${timeStr}</div>${c.id!==1?`<span class="del-btn" onclick="removeCity(${c.id})">√ó</span>`:''}</div>`;
                    con.appendChild(div);
                });
            }
        }
        setInterval(updateClock, 1000);

        // --- TOOLS ---
        const WX_DATA = {"BR":"Mist","FG":"Fog","TS":"Storm","HZ":"Haze","RA":"Rain","SN":"Snow","DZ":"Drizzle"};
        function decode(i) { i=i.trim().toUpperCase(); if(WX_DATA[i])document.getElementById('decodeOut').innerText=WX_DATA[i]; else document.getElementById('decodeOut').innerText="..."; }
        function calcIsaTool() { const a=parseFloat(document.getElementById('isaInput').value)||0; document.getElementById('isaTempOut').innerText=(15-(1.98*a/1000)).toFixed(1)+"¬∞C"; }
        
        // --- INIT ---
        document.getElementById('icao').value = 'RCTP'; initWorld(); loadData();
    </script>
</body>
</html>
