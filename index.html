<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>METAR GO</title>
    <meta name="apple-mobile-web-app-title" content="METAR GO">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/app-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* ============================================================
           1. CORE THEME & LAYOUT
        ============================================================ */
        :root {
            --bg:        #000000;
            --card-bg:   #1c1c1e;
            --text:      #ffffff;
            --sub-text:  #8e8e93;
            --border:    #38383a;
            --accent:    #0a84ff;
            --danger:    #ff453a;
            --warn:      #ff9f0a;
            --success:   #32d74b;
            --mvfr:      #0a84ff;
            --lifr:      #bf5af2;
            --sky-bg:    #131d2e;
            --strip-bg:  #3a3a3c;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 12px;
            font-size: 14px;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: max(40px, env(safe-area-inset-bottom));
            padding-top: max(12px, env(safe-area-inset-top));
            overscroll-behavior-y: none;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ============================================================
           2. MODAL (FLOATING SHEET STYLE)
        ============================================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(4px);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: max(40px, env(safe-area-inset-top) + 20px);
            padding-bottom: max(20px, env(safe-area-inset-bottom) + 20px);
            padding-left: 20px;
            padding-right: 20px;
        }
        .modal-overlay.active { display: flex; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px;
            background: #2c2c2e;
            padding: 12px 16px;
            border-radius: 12px 12px 0 0;
            border: 1px solid var(--border);
            border-bottom: none;
            color: #fff;
            margin-bottom: 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        .modal-close {
            background: #444;
            border: 1px solid #666;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }

        .browser-frame {
            width: 100%;
            max-width: 600px;
            flex-grow: 1;
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* ============================================================
           3. ANIMATIONS
        ============================================================ */
        @keyframes slideUpFade {
            0%   { opacity: 0; transform: translateY(20px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .view-section.active > * {
            animation: slideUpFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) both;
        }

        /* ============================================================
           4. LIQUID GLASS MODE (iOS Home Screen Only)
        ============================================================ */
        @media all and (display-mode: standalone) {
            body {
                background: linear-gradient(160deg, #1a1a2e 0%, #000000 100%);
                background-attachment: fixed;
            }
            .metar-card, .info-card, .freq-card, .search-box,
            .wind-vis-container, .taf-detail-card, .fr-bar-container,
            .atc-btn, .nearby-btn, .tabs, .sky-section,
            .meteogram-container, .quick-chip, .craft-pad {
                background: rgba(35, 35, 40, 0.65) !important;
                backdrop-filter: blur(25px);
                -webkit-backdrop-filter: blur(25px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            }
            .search-box { background: rgba(60, 60, 65, 0.5) !important; }
            .tabs {
                background: rgba(0, 0, 0, 0.3) !important;
                border-radius: 12px;
                margin-top: 4px;
                padding: 4px;
                border: 1px solid rgba(255,255,255,0.05);
            }
            .tab.active { color: #fff; text-shadow: 0 0 10px rgba(10, 132, 255, 0.8); }
        }

        /* ============================================================
           5. COCKPIT NIGHT MODE
        ============================================================ */
        body.cockpit-dark {
            --bg:       #000000 !important;
            --card-bg:  #000000 !important;
            --text:     #ff3333 !important;
            --sub-text: #881111 !important;
            --border:   #550000 !important;
            --accent:   #ff0000 !important;
            --success:  #ff0000 !important;
            --warn:     #cc3300 !important;
            --danger:   #ff0000 !important;
            --mvfr:     #aa0000 !important;
            --lifr:     #770000 !important;
            --sky-bg:   #000000 !important;
            --strip-bg: #220000 !important;
        }
        body.cockpit-dark * {
            backdrop-filter: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
            border-color: #440000 !important;
        }
        body.cockpit-dark .sky-section,
        body.cockpit-dark canvas,
        body.cockpit-dark .icon-btn,
        body.cockpit-dark .fr-track-modern,
        body.cockpit-dark .taf-sky-strip,
        body.cockpit-dark .meteogram-container,
        body.cockpit-dark .quick-chip,
        body.cockpit-dark .craft-pad {
            filter: grayscale(100%) sepia(100%) saturate(1000%) hue-rotate(-50deg) contrast(1.5);
        }
        body.cockpit-dark .badge-cat {
            color: #000 !important;
            background: #ff0000 !important;
            font-weight: 900;
        }
        body.cockpit-dark .tab.active {
            border-bottom-color: #ff0000;
            color: #ff0000;
        }
        body.cockpit-dark input,
        body.cockpit-dark select,
        body.cockpit-dark textarea {
            background: #110000 !important;
            color: #ff3333 !important;
        }

        /* NOTAM Highlighter Styles */
        .n-crit  { color: #ff453a; font-weight: 800; background: rgba(255, 69, 58, 0.15); padding: 0 4px; border-radius: 3px; }
        .n-warn  { color: #ff9f0a; font-weight: 700; }
        .n-bold  { color: #ffffff; font-weight: 700; text-decoration: underline; text-decoration-color: #555; }
        body.cockpit-dark .n-crit { color: #ff0000; background: #330000; }
        body.cockpit-dark .n-warn { color: #cc3300; }
        body.cockpit-dark .n-bold { color: #ff3333; }

        /* ============================================================
           6. UI ELEMENTS — TOP BAR & SEARCH
        ============================================================ */
        .top-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 40px;
        }
        .search-wrapper {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-box {
            width: 100%;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            border: 1px solid var(--border);
            padding-left: 8px;
            transition: border-color 0.2s;
        }
        .search-box:focus-within { border-color: var(--accent); }
        #icao {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: inherit;
            padding: 8px 4px;
            text-transform: uppercase;
            font-weight: 700;
            font-size: 16px;
            outline: none;
            width: 100%;
        }
        .clear-btn {
            color: var(--sub-text);
            cursor: pointer;
            padding: 0 8px;
            font-size: 14px;
            display: none;
        }
        .icon-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--accent);
            width: 40px;
            height: 100%;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 18px;
        }
        .badge {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 15px;
            min-width: 60px;
        }
        .badge-time {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'SF Mono', monospace;
            letter-spacing: -0.5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 12px;
            gap: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .badge-time:hover {
            border-color: var(--accent);
            background: rgba(10,132,255,0.1);
        }
        .badge-time-main {
            font-size: 15px;
            font-weight: 700;
        }
        .badge-time-offset {
            font-size: 9px;
            color: var(--sub-text);
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: color 0.2s ease;
        }
        .badge-cat {
            background: var(--card-bg);
            color: var(--sub-text);
            transition: background 0.3s, color 0.3s;
        }
        .cat-vfr  { background-color: var(--success) !important; color: #000 !important; }
        .cat-mvfr { background-color: var(--mvfr)    !important; color: #fff !important; }
        .cat-ifr  { background-color: var(--danger)  !important; color: #fff !important; }
        .cat-lifr { background-color: var(--lifr)    !important; color: #fff !important; }

        /* ============================================================
           7. TABS
        ============================================================ */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            gap: 15px;
            padding: 0 4px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .tab {
            padding: 10px 0;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--sub-text);
            border-bottom: 2px solid transparent;
            text-transform: uppercase;
            white-space: nowrap;
            position: relative;
            transition: color 0.2s ease;
        }
        .tab::after {
            content: '';
            position: absolute;
            bottom: -2px; left: 50%;
            width: 0; height: 2px;
            background: var(--accent);
            transform: translateX(-50%);
            transition: width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-radius: 2px;
        }
        .tab.active::after  { width: 100%; }
        .tab.active { border-bottom-color: transparent !important; color: var(--accent); }

        /* ============================================================
           8. VIEW SECTIONS & LAYOUT HELPERS
        ============================================================ */
        .view-section {
            display: none;
            opacity: 0;
            transform: translateY(8px);
        }
        .view-section.active {
            display: block;
            animation: tabReveal 0.35s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        @keyframes tabReveal {
            0%   { opacity: 0; transform: translateY(10px) scale(0.99); }
            100% { opacity: 1; transform: translateY(0px)  scale(1); }
        }
        .hidden { display: none !important; }
        .section-title {
            font-weight: 700;
            color: var(--sub-text);
            margin: 20px 0 8px 0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .raw-text {
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            color: #d0d0d0;
            margin-top: 6px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 6px;
        }

        /* ============================================================
           9. QUICK SELECT CHIPS & FAVORITES
        ============================================================ */
        .quick-select-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            overflow-x: auto;
            scrollbar-width: none;
            min-height: 32px;
        }
        .quick-chip {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .quick-chip:active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .quick-chip.fav {
            border-color: #ff9f0a;
            color: #ff9f0a;
            background: rgba(255, 159, 10, 0.1);
        }
        .chip-del {
            margin-left: 6px;
            color: var(--danger);
            font-weight: 900;
            cursor: pointer;
            opacity: 0.7;
        }
        .chip-del:hover { opacity: 1; }

        /* ============================================================
           10. GLASSMORPHISM CARDS
        ============================================================ */
        .metar-card, .info-card, .freq-card,
        .taf-detail-card, .fr-bar-container,
        .wind-vis-container, .meteogram-container {
            background: rgba(28, 28, 30, 0.75) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.06) !important;
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        .metar-card:active, .info-card:active {
            transform: scale(0.99);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
        }

        /* Ambient background glow */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(10, 132, 255, 0.04) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 80%, rgba(50, 215, 75, 0.03) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }
        body > * { position: relative; z-index: 1; }

        /* ============================================================
           11. METAR GRID & VALUE CARDS
        ============================================================ */
        .metar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        .metar-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .metar-card.full-width { grid-column: span 2; }
        .m-label  { font-size: 11px; color: var(--sub-text); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .m-value  { font-size: 16px; font-weight: 600; color: var(--text); }
        .m-sub    { font-size: 12px; color: var(--sub-text); font-weight: 400; margin-left: 4px; }
        .metar-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding: 0 4px;
            font-size: 12px;
            color: var(--sub-text);
        }

        /* ============================================================
           12. SKY SECTION
        ============================================================ */
        .sky-section {
            grid-column: span 2;
            background: var(--sky-bg);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }
        .sky-header {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            font-weight: 700;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        .sky-layer        { display: flex; flex-direction: column; margin-bottom: 14px; }
        .sky-icons-row    { display: flex; gap: 12px; margin-bottom: 4px; align-items: flex-end; }
        .sky-icon         { width: 32px; height: 20px; fill: #d1d5db; opacity: 0.9; }
        .sky-layer-text   { font-size: 15px; font-weight: 500; color: #fff; }
        .sky-no-data      { text-align: center; color: rgba(255,255,255,0.3); padding: 20px; font-style: italic; }

        /* ============================================================
           13. FLIGHT RULE GAUGES
        ============================================================ */
        .fr-bar-container {
            grid-column: span 2;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            margin-top: 4px;
        }
        .fr-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .fr-title      { font-size: 11px; color: var(--sub-text); font-weight: 700; text-transform: uppercase; }
        .fr-gauge-group { display: flex; flex-direction: column; gap: 14px; }
        .fr-row-label  {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 700;
            color: var(--sub-text);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        .fr-val-text { color: var(--text); font-family: 'SF Mono', monospace; font-size: 12px; }
        .fr-track-modern {
            position: relative;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
        }
        .fr-sec {
            height: 100%;
            border-right: 1px solid rgba(0,0,0,0.3);
            position: relative;
            background: rgba(255,255,255,0.02);
        }
        .fr-sec span {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 7px;
            color: rgba(255,255,255,0.2);
            font-weight: 800;
            pointer-events: none;
            z-index: 1;
            letter-spacing: 0.5px;
        }
        .fr-fill-bar {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            background: var(--accent);
            border-right: 2px solid #fff;
            box-shadow: 2px 0 8px rgba(0,0,0,0.5);
            transition: width 1s cubic-bezier(0.1, 1.2, 0.3, 1), background-color 0.3s;
            z-index: 2;
            opacity: 0.9;
            border-radius: 5px 0 0 5px;
        }
        .fr-msg {
            margin-top: 12px;
            font-size: 13px;
            color: var(--text);
            font-weight: 500;
            border-top: 1px solid var(--border);
            padding-top: 8px;
        }

        /* ============================================================
           14. METEOGRAM
        ============================================================ */
        .meteogram-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            border: 1px solid var(--border);
            overflow-x: auto;
        }
        #meteoCanvas { width: 100%; height: 150px; display: block; }

        /* ============================================================
           15. WIND ROSE & VISIBILITY
        ============================================================ */
        .wind-vis-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .wind-controls { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .wind-stats {
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            color: var(--text);
            margin-top: 5px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }
        select.stealth-select {
            background: #2c2c2e;
            border: 1px solid var(--border);
            color: #fff;
            padding: 6px;
            border-radius: 6px;
            width: 100%;
            font-weight: 600;
            outline: none;
        }

        /* ============================================================
           16. TAF VISUALIZATION
        ============================================================ */
        .taf-viz-container { margin-top: 10px; position: relative; }
        .taf-bar {
            display: flex;
            height: 32px;
            width: 100%;
            background: #2c2c2e;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
            position: relative;
            z-index: 2;
        }
        .taf-sky-strip {
            height: 6px;
            width: 100%;
            margin-top: 2px;
            border-radius: 3px;
            background: #333;
            overflow: hidden;
            position: relative;
        }
        .taf-axis { display: flex; width: 100%; margin-top: 4px; margin-bottom: 12px; }
        .taf-block {
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 800;
            color: rgba(0,0,0,0.6);
            border-right: 1px solid rgba(0,0,0,0.1);
            transition: opacity 0.2s;
            text-transform: uppercase;
        }
        .taf-block:hover { opacity: 0.8; }
        .taf-detail-card {
            position: relative;
            z-index: 10;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid var(--sub-text);
            animation: slideUpFade 0.2s ease-out;
        }
        #tafNeedle {
            position: absolute;
            top: -4px;
            height: 40px;
            width: 2px;
            background: #ff453a;
            z-index: 5;
            pointer-events: none;
            box-shadow: 0 0 8px #ff453a;
            transition: left 0.5s ease-out;
            display: none;
        }
        /* TAF Needle Tooltip */
        #tafNeedleTooltip {
            position: absolute;
            top: -52px;
            transform: translateX(-50%);
            background: rgba(28,28,30,0.95);
            border: 1px solid rgba(255,69,58,0.5);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 11px;
            font-family: 'SF Mono', monospace;
            color: #fff;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        #tafNeedleTooltip::after {
            content: '';
            position: absolute;
            bottom: -5px; left: 50%;
            width: 8px; height: 8px;
            background: rgba(28,28,30,0.95);
            border-right: 1px solid rgba(255,69,58,0.5);
            border-bottom: 1px solid rgba(255,69,58,0.5);
            transform: translateX(-50%) rotate(45deg);
        }
        #tafNeedleTooltip.visible { opacity: 1; }
        #tafNeedle::after {
            content: '';
            position: absolute;
            top: -4px; left: -4px;
            width: 10px; height: 10px;
            background: #ff453a;
            border-radius: 50%;
            border: 2px solid #000;
        }

        /* ============================================================
           17. RUNWAYS
        ============================================================ */
        .rwy-complex { margin-bottom: 16px; }
        .rc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 4px;
            padding: 0 4px;
        }
        .rc-idents { font-size: 16px; font-weight: 800; font-family: 'SF Mono', monospace; }
        .rc-strip {
            height: 44px;
            background: var(--strip-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 6px;
            overflow: hidden;
            position: relative;
        }
        .rc-id-v {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            padding: 0 4px;
        }
        .rc-data {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .wind-comp {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        /* ============================================================
           18. ATC & EXTERNAL LINKS
        ============================================================ */
        .atc-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 14px 16px;
            border-radius: 10px;
            text-decoration: none;
            color: var(--text);
            font-weight: 600;
            font-size: 15px;
            border: 1px solid var(--border);
            transition: background 0.2s;
            margin-bottom: 10px;
        }
        .atc-btn:hover { background: #2c2c2e; border-color: var(--accent); }
        .tool-btn {
            background: #333;
            border: 1px solid var(--border);
            color: #fff;
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 4px;
            font-weight: 600;
        }

        /* ============================================================
           19. NEARBY STATIONS
        ============================================================ */
        .nearby-container { grid-column: span 2; display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
        .nearby-header    { font-size: 11px; color: var(--sub-text); font-weight: 700; }
        .nearby-list      { display: flex; gap: 6px; flex-wrap: wrap; }
        .nearby-btn {
            background: #2c2c2e;
            border: 1px solid var(--border);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ============================================================
           20. INFO / FREQ CARDS
        ============================================================ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .info-card { background: var(--card-bg); padding: 10px; border-radius: 8px; }
        .ic-lbl    { font-size: 11px; color: var(--sub-text); text-transform: uppercase; }
        .ic-val    { font-size: 15px; font-weight: 600; color: var(--text); margin-top: 2px; }
        .freq-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; }
        .freq-card { background: var(--card-bg); border-radius: 8px; padding: 10px; text-align: center; }
        .freq-type { font-size: 11px; color: var(--sub-text); text-transform: uppercase; margin-bottom: 4px; }
        .freq-val  { font-size: 16px; font-weight: 700; color: var(--accent); font-family: 'SF Mono', monospace; }

        /* ============================================================
           21. WORLD CLOCK (iOS-style)
        ============================================================ */
        .clock-card {
            background: #000;
            padding: 16px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            margin-bottom: 0;
        }
        .clock-left  { display: flex; flex-direction: column; gap: 2px; }
        .clock-city  { font-size: 24px; font-weight: 400; color: #fff; }
        .clock-diff  { font-size: 13px; color: #8e8e93; font-weight: 500; }
        .clock-time  { font-family: -apple-system, sans-serif; font-size: 48px; font-weight: 300; color: #fff; letter-spacing: -1px; }
        .clock-del-btn {
            background: transparent;
            color: #ff453a;
            border: 1px solid #ff453a;
            border-radius: 50%;
            width: 24px; height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            margin-left: 12px;
            cursor: pointer;
            opacity: 0.6;
        }
        .clock-del-btn:hover { opacity: 1; background: rgba(255, 69, 58, 0.2); }

        /* ============================================================
           22. CONVERTER / E6B INPUTS
        ============================================================ */
        .conv-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .conv-lbl { font-size: 10px; color: var(--sub-text); margin-bottom: 4px; text-transform: uppercase; }
        .conv-inp {
            width: 100%;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 8px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
        }

        /* ============================================================
           23. CRAFT PAD
        ============================================================ */
        .craft-pad {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border);
            font-family: 'SF Mono', monospace;
            font-size: 14px;
            color: #fff;
            width: 100%;
            min-height: 120px;
            resize: vertical;
            outline: none;
        }

        /* ============================================================
           24. STORAGE SETUP & PIN PAD
        ============================================================ */
        .setup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .setup-card {
            width: 100%;
            max-width: 320px;
            background: #1c1c1e;
            border: 1px solid #38383a;
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .setup-card:hover    { border-color: var(--accent); }
        .setup-card.highlighted { border-color: var(--accent); }
        .pin-dot {
            width: 16px; height: 16px;
            border-radius: 50%;
            border: 2px solid #555;
            background: transparent;
            transition: background 0.2s, border-color 0.2s;
        }
        .pin-dot.filled { background: var(--accent); border-color: var(--accent); }
        .pin-btn {
            width: 72px; height: 72px;
            background: #1c1c1e;
            border: 1px solid #38383a;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pin-btn:active  { background: #333; }
        .pin-btn.empty   { background: transparent; border: none; pointer-events: none; }
        .pin-btn.delete  { font-size: 20px; }

        /* ============================================================
           25. TOAST & OFFLINE BANNER
        ============================================================ */
        .toast-msg {
            position: fixed;
            bottom: max(30px, env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: #1c1c1e;
            border: 1px solid #38383a;
            color: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 9999;
            white-space: nowrap;
            animation: slideUpFade 0.3s ease-out;
        }
        .offline-banner {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 4px;
            background: linear-gradient(135deg, #7c3300, #4a2000);
            border: 1px solid #ff9f0a;
            border-radius: 8px;
            color: #ff9f0a;
            text-align: center;
            padding: 8px 12px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
            animation: slideUpFade 0.3s ease-out;
        }
        .offline-banner:hover { background: linear-gradient(135deg, #9a4000, #622b00); }

        /* ============================================================
           26. SAFETY FOOTER & MISC
        ============================================================ */
        .safety-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 10px;
            color: #555;
            padding: 10px;
            border-top: 1px solid #222;
            order: 999;
        }
        .active-fuel {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: #ffffff !important;
            color: #ffffff !important;
        }

        /* ============================================================
           27. LAUNCH SCREEN
        ============================================================ */
        #launchScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #launchScreen.fade-out {
            animation: launchFadeOut 0.8s ease-in forwards;
        }
        @keyframes launchFadeOut {
            0%   { opacity: 1; }
            100% { opacity: 0; pointer-events: none; }
        }

        /* Aircraft wrap */
        .launch-aircraft-wrap {
            position: relative;
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .launch-aircraft-img {
            position: absolute;
            width: 200px;
            height: auto;
            top: 58%;
            opacity: 0;
            transform: translateY(-50%) translateZ(0);
            animation: aircraftSlide 3.0s cubic-bezier(0.25, 0.1, 0.25, 1) 0.4s forwards;
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
            perspective: 1000px;
            -webkit-perspective: 1000px;
        }

        @keyframes aircraftSlide {

            /* ── PHASE 1: FADE IN & FIRST ROLL (0–8%) ── */
            0%   { transform: translateX(-240px) translateY(-50%) scale(0.960) rotate(0deg) translateZ(0); opacity: 0;     }
            1%   { transform: translateX(-238px) translateY(-50%) scale(0.960) rotate(0deg) translateZ(0); opacity: 0.10;  }
            2%   { transform: translateX(-235px) translateY(-50%) scale(0.960) rotate(0deg) translateZ(0); opacity: 0.20;  }
            3%   { transform: translateX(-232px) translateY(-50%) scale(0.965) rotate(0deg) translateZ(0); opacity: 0.35;  }
            4%   { transform: translateX(-228px) translateY(-50%) scale(0.970) rotate(0deg) translateZ(0); opacity: 0.50;  }
            5%   { transform: translateX(-223px) translateY(-50%) scale(0.970) rotate(0deg) translateZ(0); opacity: 0.625; }
            6%   { transform: translateX(-218px) translateY(-50%) scale(0.970) rotate(0deg) translateZ(0); opacity: 0.75;  }
            7%   { transform: translateX(-212px) translateY(-50%) scale(0.975) rotate(0deg) translateZ(0); opacity: 0.875; }
            8%   { transform: translateX(-205px) translateY(-50%) scale(0.980) rotate(0deg) translateZ(0); opacity: 1;     }

            /* ── PHASE 2: TAXI ACCELERATION (9–16%) ── */
            9%   { transform: translateX(-197px) translateY(-50%) scale(0.980) rotate(0deg) translateZ(0); opacity: 1; }
            10%  { transform: translateX(-188px) translateY(-50%) scale(0.980) rotate(0deg) translateZ(0); opacity: 1; }
            11%  { transform: translateX(-177px) translateY(-50%) scale(0.983) rotate(0deg) translateZ(0); opacity: 1; }
            12%  { transform: translateX(-165px) translateY(-50%) scale(0.987) rotate(0deg) translateZ(0); opacity: 1; }
            13%  { transform: translateX(-154px) translateY(-50%) scale(0.990) rotate(0deg) translateZ(0); opacity: 1; }
            14%  { transform: translateX(-143px) translateY(-50%) scale(0.993) rotate(0deg) translateZ(0); opacity: 1; }
            15%  { transform: translateX(-131px) translateY(-50%) scale(0.997) rotate(0deg) translateZ(0); opacity: 1; }
            16%  { transform: translateX(-120px) translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }

            /* ── PHASE 3: FULL SPEED TAXI (17–32%) ── */
            17%  { transform: translateX(-105px) translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            18%  { transform: translateX(-90px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            19%  { transform: translateX(-75px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            20%  { transform: translateX(-60px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            21%  { transform: translateX(-45px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            22%  { transform: translateX(-30px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            23%  { transform: translateX(-15px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            24%  { transform: translateX(0px)    translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            25%  { transform: translateX(19px)   translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            26%  { transform: translateX(38px)   translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            27%  { transform: translateX(56px)   translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            28%  { transform: translateX(75px)   translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            29%  { transform: translateX(94px)   translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            30%  { transform: translateX(113px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            31%  { transform: translateX(131px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            32%  { transform: translateX(150px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }

            /* ── PHASE 4: APPROACH TO V1 (33–44%) ── */
            33%  { transform: translateX(166px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            34%  { transform: translateX(182px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            35%  { transform: translateX(198px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            36%  { transform: translateX(214px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            37%  { transform: translateX(230px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            38%  { transform: translateX(246px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            39%  { transform: translateX(262px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            40%  { transform: translateX(278px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            41%  { transform: translateX(288px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            42%  { transform: translateX(299px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            43%  { transform: translateX(309px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            44%  { transform: translateX(320px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }

            /* ── PHASE 5: V1 HOLD & COAST (45–53%) ── */
            45%  { transform: translateX(330px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            46%  { transform: translateX(334px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            47%  { transform: translateX(337px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            48%  { transform: translateX(341px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            49%  { transform: translateX(344px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            50%  { transform: translateX(348px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            51%  { transform: translateX(351px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            52%  { transform: translateX(354px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }
            53%  { transform: translateX(358px)  translateY(-50%) scale(1.000) rotate(0deg) translateZ(0); opacity: 1; }

            /* ── PHASE 6: VR — NOSE ROTATION BEGINS (54–62%) ── */
            54%  { transform: translateX(362px)  translateY(-50.17%) scale(1.000)  rotate(-0.33deg) translateZ(0); opacity: 1; }
            55%  { transform: translateX(366px)  translateY(-50.33%) scale(1.000)  rotate(-0.67deg) translateZ(0); opacity: 1; }
            56%  { transform: translateX(370px)  translateY(-50.50%) scale(1.000)  rotate(-1.00deg) translateZ(0); opacity: 1; }
            57%  { transform: translateX(377px)  translateY(-50.83%) scale(0.9975) rotate(-1.25deg) translateZ(0); opacity: 1; }
            58%  { transform: translateX(384px)  translateY(-51.15%) scale(0.9950) rotate(-1.50deg) translateZ(0); opacity: 1; }
            59%  { transform: translateX(391px)  translateY(-51.48%) scale(0.9925) rotate(-1.75deg) translateZ(0); opacity: 1; }
            60%  { transform: translateX(398px)  translateY(-51.80%) scale(0.9900) rotate(-2.00deg) translateZ(0); opacity: 1; }
            61%  { transform: translateX(408px)  translateY(-52.30%) scale(0.9875) rotate(-2.25deg) translateZ(0); opacity: 1; }
            62%  { transform: translateX(418px)  translateY(-52.80%) scale(0.9850) rotate(-2.50deg) translateZ(0); opacity: 1; }

            /* ── PHASE 7: LIFTOFF — INITIAL CLIMB (63–70%) ── */
            63%  { transform: translateX(431px)  translateY(-53.48%) scale(0.9825) rotate(-2.75deg) translateZ(0); opacity: 0.995; }
            64%  { transform: translateX(444px)  translateY(-54.15%) scale(0.9800) rotate(-3.00deg) translateZ(0); opacity: 0.990; }
            65%  { transform: translateX(457px)  translateY(-54.83%) scale(0.9775) rotate(-3.25deg) translateZ(0); opacity: 0.985; }
            66%  { transform: translateX(470px)  translateY(-55.50%) scale(0.9750) rotate(-3.50deg) translateZ(0); opacity: 0.980; }
            67%  { transform: translateX(487px)  translateY(-56.43%) scale(0.9725) rotate(-3.75deg) translateZ(0); opacity: 0.968; }
            68%  { transform: translateX(504px)  translateY(-57.35%) scale(0.9700) rotate(-4.00deg) translateZ(0); opacity: 0.955; }
            69%  { transform: translateX(521px)  translateY(-58.28%) scale(0.9675) rotate(-4.25deg) translateZ(0); opacity: 0.943; }
            70%  { transform: translateX(538px)  translateY(-59.20%) scale(0.9650) rotate(-4.50deg) translateZ(0); opacity: 0.930; }

            /* ── PHASE 8: CLIMB & RECEDE (71–78%) ── */
            71%  { transform: translateX(559px)  translateY(-60.40%) scale(0.9613) rotate(-4.70deg) translateZ(0); opacity: 0.910; }
            72%  { transform: translateX(580px)  translateY(-61.60%) scale(0.9575) rotate(-4.90deg) translateZ(0); opacity: 0.890; }
            73%  { transform: translateX(601px)  translateY(-62.80%) scale(0.9538) rotate(-5.10deg) translateZ(0); opacity: 0.870; }
            74%  { transform: translateX(622px)  translateY(-64.00%) scale(0.9500) rotate(-5.30deg) translateZ(0); opacity: 0.850; }
            75%  { transform: translateX(647px)  translateY(-65.63%) scale(0.9450) rotate(-5.48deg) translateZ(0); opacity: 0.813; }
            76%  { transform: translateX(672px)  translateY(-67.25%) scale(0.9400) rotate(-5.65deg) translateZ(0); opacity: 0.775; }
            77%  { transform: translateX(697px)  translateY(-68.88%) scale(0.9350) rotate(-5.83deg) translateZ(0); opacity: 0.738; }
            78%  { transform: translateX(722px)  translateY(-70.50%) scale(0.9300) rotate(-6.00deg) translateZ(0); opacity: 0.700; }

            /* ── PHASE 9: HIGH CLIMB & FADE (79–86%) ── */
            79%  { transform: translateX(751px)  translateY(-72.58%) scale(0.9225) rotate(-6.10deg) translateZ(0); opacity: 0.650; }
            80%  { transform: translateX(780px)  translateY(-74.65%) scale(0.9150) rotate(-6.20deg) translateZ(0); opacity: 0.600; }
            81%  { transform: translateX(809px)  translateY(-76.73%) scale(0.9075) rotate(-6.30deg) translateZ(0); opacity: 0.550; }
            82%  { transform: translateX(838px)  translateY(-78.80%) scale(0.9000) rotate(-6.40deg) translateZ(0); opacity: 0.500; }
            83%  { transform: translateX(871px)  translateY(-81.23%) scale(0.8925) rotate(-6.48deg) translateZ(0); opacity: 0.450; }
            84%  { transform: translateX(904px)  translateY(-83.65%) scale(0.8850) rotate(-6.55deg) translateZ(0); opacity: 0.400; }
            85%  { transform: translateX(937px)  translateY(-86.08%) scale(0.8775) rotate(-6.63deg) translateZ(0); opacity: 0.350; }
            86%  { transform: translateX(970px)  translateY(-88.50%) scale(0.8700) rotate(-6.70deg) translateZ(0); opacity: 0.300; }

            /* ── PHASE 10: VANISH INTO DISTANCE (87–100%) ── */
            87%  { transform: translateX(1007px) translateY(-91.38%) scale(0.8625) rotate(-6.75deg) translateZ(0); opacity: 0.263; }
            88%  { transform: translateX(1044px) translateY(-94.25%) scale(0.8550) rotate(-6.80deg) translateZ(0); opacity: 0.225; }
            89%  { transform: translateX(1081px) translateY(-97.13%) scale(0.8475) rotate(-6.85deg) translateZ(0); opacity: 0.188; }
            90%  { transform: translateX(1118px) translateY(-100.0%) scale(0.8400) rotate(-6.90deg) translateZ(0); opacity: 0.150; }
            91%  { transform: translateX(1159px) translateY(-103.4%) scale(0.8325) rotate(-6.93deg) translateZ(0); opacity: 0.128; }
            92%  { transform: translateX(1200px) translateY(-106.8%) scale(0.8250) rotate(-6.95deg) translateZ(0); opacity: 0.105; }
            93%  { transform: translateX(1241px) translateY(-110.1%) scale(0.8175) rotate(-6.98deg) translateZ(0); opacity: 0.083; }
            94%  { transform: translateX(1282px) translateY(-113.5%) scale(0.8100) rotate(-7.00deg) translateZ(0); opacity: 0.060; }
            95%  { transform: translateX(1328px) translateY(-117.6%) scale(0.8025) rotate(-7.00deg) translateZ(0); opacity: 0.050; }
            96%  { transform: translateX(1374px) translateY(-121.7%) scale(0.7950) rotate(-7.00deg) translateZ(0); opacity: 0.040; }
            97%  { transform: translateX(1420px) translateY(-125.8%) scale(0.7875) rotate(-7.00deg) translateZ(0); opacity: 0.030; }
            98%  { transform: translateX(1466px) translateY(-129.8%) scale(0.7800) rotate(-7.00deg) translateZ(0); opacity: 0.020; }
            99%  { transform: translateX(1512px) translateY(-133.9%) scale(0.7725) rotate(-7.00deg) translateZ(0); opacity: 0.010; }
            100% { transform: translateX(1558px) translateY(-138.0%) scale(0.7650) rotate(-7.00deg) translateZ(0); opacity: 0;     }
        }
        /* Runway / Ground elements */
        .launch-ground {
            position: absolute;
            bottom: 40px; left: 10%; right: 10%;
            height: 1px;
            background: linear-gradient(
                to right,
                transparent,
                rgba(255,255,255,0.08) 20%,
                rgba(255,255,255,0.15) 50%,
                rgba(255,255,255,0.08) 80%,
                transparent
            );
        }
        /* Runway centerline — auto-fills full screen width with repeating dashes */
        .launch-dashes {
            position: absolute;
            bottom: 32px;
            left: 5%;
            right: 5%;
            height: 2px;
            background: repeating-linear-gradient(
                to right,
                rgba(255, 255, 255, 0.55) 0px,
                rgba(255, 255, 255, 0.55) 28px,   /* dash length */
                transparent 28px,
                transparent 46px                   /* gap length */
            );
            border-radius: 2px;
            opacity: 0;
            animation: fadeIn 0.4s ease 0.2s forwards;
        }
        /* .launch-dash divs are no longer needed — kept for backwards compat */
        .launch-dash { display: none; }
        .launch-lights {
            position: absolute;
            bottom: 27px; left: 5%; right: 5%;
            display: flex;
            justify-content: space-between;
            opacity: 0;
            animation: fadeIn 0.4s ease 0.2s forwards;
        }
        .launch-light {
            width: 4px; height: 4px;
            background: #ff9f0a;
            border-radius: 50%;
            box-shadow: 0 0 6px #ff9f0a, 0 0 12px rgba(255,159,10,0.4);
            animation: lightPulse 1.5s ease-in-out infinite;
        }
        .launch-light:nth-child(2) { animation-delay: 0.2s; }
        .launch-light:nth-child(3) { animation-delay: 0.4s; }
        .launch-light:nth-child(4) { animation-delay: 0.6s; }
        .launch-light:nth-child(5) { animation-delay: 0.8s; }
        .launch-light:nth-child(6) { animation-delay: 1.0s; }
        .launch-light:nth-child(7) { animation-delay: 1.2s; }
        .launch-glow {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: radial-gradient(ellipse at 50% 100%, rgba(100,200,255,0.04) 0%, transparent 70%);
            pointer-events: none;
        }

        /* Branding text */
        .launch-title {
            font-size: 30px; font-weight: 800; color: #fff;
            letter-spacing: 5px; text-transform: uppercase;
            opacity: 0;
            animation: titleReveal 0.6s ease 1.8s forwards;
            text-align: center;
        }
        .launch-sub {
            font-size: 11px; color: #0a84ff;
            letter-spacing: 3px; text-transform: uppercase;
            margin-top: 8px;
            opacity: 0;
            animation: titleReveal 0.6s ease 2.1s forwards;
            text-align: center;
        }
        .launch-version {
            font-size: 10px; color: #2a2a2a;
            margin-top: 20px;
            opacity: 0;
            animation: titleReveal 0.4s ease 2.3s forwards;
            font-family: 'SF Mono', monospace;
            letter-spacing: 2px;
            text-align: center;
        }

        @keyframes titleReveal {
            0%   { opacity: 0; transform: translateY(6px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn    { to { opacity: 1; } }
        @keyframes lightPulse {
            0%, 100% { opacity: 0.3; }
            50%       { opacity: 1;   }
        }

        /* ============================================================
           HELP / USER MANUAL STYLES
        ============================================================ */
        .help-section {
            background: rgba(28, 28, 30, 0.75);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 14px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .help-section-title {
            font-size: 13px;
            font-weight: 800;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .help-item {
            margin-bottom: 12px;
        }
        .help-item:last-child { margin-bottom: 0; }
        .help-q {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 3px;
        }
        .help-a {
            font-size: 12px;
            color: var(--sub-text);
            line-height: 1.6;
        }
        .help-a b { color: var(--text); }

        /* ============================================================
           28. RESPONSIVE LAYOUT — TABLET & DESKTOP
           820px  = iPad landscape
           1100px = Desktop
           1400px = Wide desktop
        ============================================================ */

        /* ── 820px+: Sidebar nav + 2-panel METAR tab ── */
        @media (min-width: 820px) {

            /* ─── Body: CSS Named Grid ─── */
            body {
                max-width: 1280px;
                margin: 0 auto;
                padding: 16px 28px;
                display: grid;
                grid-template-areas:
                    "topbar   topbar"
                    "chips    chips"
                    "banner   banner"
                    "sidenav  content"
                    "sidenav  sfooter";
                grid-template-columns: 138px 1fr;
                grid-template-rows: auto auto auto 1fr auto;
                column-gap: 20px;
                row-gap: 10px;
                align-items: start;
            }

            .top-bar          { grid-area: topbar;  }
            .quick-select-row { grid-area: chips;   }
            #minBanner        { grid-area: banner;  }
            #offlineBanner    { grid-area: banner;  }
            .tabs             { grid-area: sidenav; }
            .view-section     { grid-area: content; }
            .safety-footer    { grid-area: sfooter; }

            /* ─── Vertical sidebar tab pill ─── */
            .tabs {
                flex-direction: column;
                gap: 2px;
                padding: 4px;
                border-bottom: none;
                overflow: visible;
                position: sticky;
                top: 16px;
                align-self: start;
                background: rgba(28,28,30,0.78);
                border-radius: 10px;
                border: 1px solid var(--border);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
            }
            .tab {
                padding: 10px 12px;
                text-align: left;
                font-size: 11px;
                letter-spacing: 0.3px;
                border-radius: 7px;
                border-bottom: none;
                border-right: 3px solid transparent;
                white-space: nowrap;
                width: 100%;
            }
            .tab:hover:not(.active) {
                background: rgba(255,255,255,0.06);
                color: var(--text);
            }
            .tab.active {
                background: rgba(10,132,255,0.14);
                border-right-color: var(--accent);
                color: var(--accent);
            }
            .tab::after { display: none; }


            /* ═══════════════════════════════════════════════════
               METAR TAB: 2-column explicit grid
               Col 1 (220px): wind rose → AWOS btn → raw METAR → footer
               Col 2 (1fr):   metar-grid (sky+fr side-by-side + value cards)
               Row 5 (full):  nearby stations
            ═══════════════════════════════════════════════════ */
            #tab-metar {
                display: grid;
                grid-template-columns: 220px 1fr;
                /* 5 explicit rows:
                   1 = rose + grid top
                   2 = awos + grid mid
                   3 = rawmetar + grid (continues)
                   4 = footer + grid bottom
                   5 = nearby (full width)       */
                grid-template-rows: auto auto 1fr auto auto;
                column-gap: 16px;
                row-gap: 0;
                align-items: start;
            }

            /* ── Col 1, Row 1: Wind rose ── */
            #tab-metar > .wind-vis-container {
                grid-column: 1;
                grid-row: 1;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                margin-top: 0;
                padding: 16px 14px 12px;
                gap: 12px;
            }
            #tab-metar #windRose {
                width: 150px !important;
                height: 150px !important;
            }
            #tab-metar .wind-controls {
                width: 100%;
            }

            /* ── Col 1, Row 2: AWOS button (KMHR only) ── */
            #tab-metar > #btnFetchLive {
                grid-column: 1;
                grid-row: 2;
                margin: 8px 0 4px;
                font-size: 11px;
                padding: 9px 8px;
                line-height: 1.3;
                align-self: start;
            }

            /* ── Col 1, Row 3: Raw METAR text ── */
            #tab-metar > .raw-text {
                grid-column: 1;
                grid-row: 3;
                font-size: 11px;
                line-height: 1.6;
                margin-top: 8px;
                padding: 10px;
                overflow-wrap: break-word;
                word-break: break-all;
                align-self: start;
                max-height: 300px;
                overflow-y: auto;
            }

            /* ── Col 1, Row 4: Age + spread footer ── */
            #tab-metar > .metar-footer {
                grid-column: 1;
                grid-row: 4;
                font-size: 11px;
                margin-top: 6px;
                padding: 0 4px;
                flex-direction: column;
                gap: 2px;
                align-items: flex-start;
                align-self: start;
            }

            /* ── Col 2, Rows 1-4: metar-grid ── */
            #tab-metar > .metar-grid {
                grid-column: 2;
                grid-row: 1 / 5;
                /* 2-column sub-grid inside: sky | flight-cat side by side,
                   then value cards fill 2 cols each              */
                grid-template-columns: 1fr 1fr;
                align-self: start;
                gap: 8px;
            }

            /* Sky Cover + Flight Category: each takes ONE col → side by side */
            #tab-metar .sky-section     { grid-column: span 1 !important; }
            #tab-metar .fr-bar-container { grid-column: span 1 !important; }

            /* Value cards: each 1 col (2 per row: WIND|VIS then CEIL|ALT) */
            #tab-metar .metar-card { grid-column: span 1; }

            /* TEMP/DEWPOINT: full width of the 2-col grid */
            #tab-metar .metar-card.full-width { grid-column: span 2 !important; }

            /* ── Row 5: Nearby stations — full width ── */
            #tab-metar > .nearby-container {
                grid-column: 1 / -1;
                grid-row: 5;
                margin-top: 10px;
            }


            /* ─── Other tabs: standard 3-col grids ─── */
            .info-grid  { grid-template-columns: 1fr 1fr 1fr; }
            .freq-grid  { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }

            /* Meteogram taller */
            #meteoCanvas { height: 175px; }
        }


        /* ── 1100px+: Desktop ── */
        @media (min-width: 1100px) {

            body {
                padding: 20px 40px;
                grid-template-columns: 152px 1fr;
                column-gap: 28px;
            }

            .tab { font-size: 12px; padding: 11px 15px; }

            /* Wider wind rose column */
            #tab-metar {
                grid-template-columns: 240px 1fr;
                column-gap: 20px;
            }

            #tab-metar > .wind-vis-container {
                padding: 18px 16px 14px;
            }

            #tab-metar #windRose {
                width: 160px !important;
                height: 160px !important;
            }

            /* Keep 2-col for metar-grid panel (sky+fr side by side looks better) */
            #tab-metar > .metar-grid {
                grid-template-columns: 1fr 1fr;
            }

            /* Value cards: 4 per row on wide screens inside the 2-col grid
               we can bump to a 4-col layout here since the right panel is wide */
            #tab-metar > .metar-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
            /* Sky and FR still span 2 cols each → side by side in 4-col */
            #tab-metar .sky-section      { grid-column: span 2 !important; }
            #tab-metar .fr-bar-container { grid-column: span 2 !important; }
            /* Value cards: 1 col each (4 per row) */
            #tab-metar .metar-card { grid-column: span 1; }
            /* Temp/dewpoint: span 4 */
            #tab-metar .metar-card.full-width { grid-column: span 4 !important; }

            /* Taller meteogram */
            #meteoCanvas { height: 200px; }

            /* Nearby buttons larger */
            .nearby-btn { padding: 8px 14px; font-size: 13px; }

            /* Other tab grids */
            .info-grid { grid-template-columns: 1fr 1fr 1fr 1fr; }
        }


        /* ── 1400px+: Wide desktop ── */
        @media (min-width: 1400px) {

            body {
                max-width: 1440px;
                padding: 24px 48px;
                grid-template-columns: 160px 1fr;
            }

            .tab { font-size: 12px; padding: 12px 18px; }

            #tab-metar {
                grid-template-columns: 260px 1fr;
            }

            #tab-metar > .wind-vis-container {
                padding: 20px 18px 16px;
            }

            #tab-metar #windRose {
                width: 170px !important;
                height: 170px !important;
            }

            /* 5-col metar-grid: sky(2)+fr(2)+extra, then 4+1 value cards */
            #tab-metar > .metar-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }

            .info-grid { grid-template-columns: repeat(5, 1fr); }
        }

        /* ============================================================
           29. SKELETON LOADING SCREENS
        ============================================================ */
        @keyframes shimmer {
            0%   { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(28,28,30,0.8) 0%,
                rgba(60,60,60,0.8) 50%,
                rgba(28,28,30,0.8) 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s ease-in-out infinite;
            border-radius: 8px;
            min-height: 20px;
        }
        
        .skeleton-text {
            height: 14px;
            margin: 6px 0;
            background: linear-gradient(
                90deg,
                rgba(28,28,30,0.8) 0%,
                rgba(60,60,60,0.8) 50%,
                rgba(28,28,30,0.8) 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s ease-in-out infinite;
            border-radius: 4px;
        }
        
        .skeleton-card {
            background: rgba(28,28,30,0.75);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 10px;
        }

        /* ============================================================
           30. WEATHER TREND INDICATORS
        ============================================================ */
        .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            text-transform: uppercase;
        }
        .trend-improving {
            background: rgba(50, 215, 75, 0.15);
            color: var(--success);
        }
        .trend-worsening {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }
        .trend-steady {
            background: rgba(255, 159, 10, 0.15);
            color: var(--warn);
        }

        /* ============================================================
           31. COPY BUTTONS
        ============================================================ */
        .copy-btn {
            background: rgba(10,132,255,0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .copy-btn:hover {
            background: var(--accent);
            color: #fff;
        }
        .copy-btn:active {
            transform: scale(0.95);
        }
        
        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        /* ============================================================
           32. PHONE NUMBER CARDS
        ============================================================ */
        .phone-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .phone-label {
            font-size: 10px;
            color: var(--sub-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        .phone-number {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
            font-family: 'SF Mono', monospace;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .phone-number:active {
            transform: scale(0.98);
        }

        /* ============================================================
           33. MULTI-AIRPORT DASHBOARD
        ============================================================ */
        .multi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .multi-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .multi-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(10,132,255,0.2);
        }
        .multi-card:active {
            transform: translateY(0);
        }
        
        .multi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .multi-icao {
            font-size: 20px;
            font-weight: 800;
            font-family: 'SF Mono', monospace;
            color: var(--text);
        }
        .multi-remove {
            background: rgba(255,69,58,0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .multi-remove:hover {
            background: var(--danger);
            color: #fff;
        }
        
        .multi-name {
            font-size: 11px;
            color: var(--sub-text);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .multi-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            font-size: 11px;
        }
        .multi-data-item {
            background: rgba(255,255,255,0.03);
            padding: 6px 8px;
            border-radius: 6px;
        }
        .multi-data-label {
            color: var(--sub-text);
            font-size: 9px;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .multi-data-value {
            font-weight: 700;
            font-family: 'SF Mono', monospace;
        }
        
        .multi-age {
            text-align: center;
            margin-top: 8px;
            font-size: 9px;
            color: var(--sub-text);
        }
        
        .multi-loading {
            color: var(--sub-text);
            text-align: center;
            padding: 20px;
            font-size: 12px;
        }
        
        .multi-add-form {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .multi-add-input {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            outline: none;
        }
        .multi-add-input:focus {
            border-color: var(--accent);
        }
        .multi-add-btn {
            background: var(--accent);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }
        .multi-add-btn:active {
            transform: scale(0.98);
        }
        
        @media (min-width: 820px) {
            .multi-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
        }
        @media (min-width: 1100px) {
            .multi-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: 0.3s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* ============================================================
           WEATHER TAB PILL TOGGLE
        ============================================================ */
        .weather-pill-row {
            display: flex;
            background: rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 3px;
            gap: 3px;
            margin-bottom: 14px;
            border: 1px solid var(--border);
        }
        .pill-btn {
            flex: 1;
            padding: 9px 0;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--sub-text);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.2s, color 0.2s;
        }
        .pill-btn.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 2px 8px rgba(10,132,255,0.35);
        }
        body.cockpit-dark .pill-btn.active {
            background: #ff0000;
            box-shadow: none;
        }
        
    </style>
</head>


<body>

    <!-- ================================================================
         LAUNCH SCREEN
    ================================================================ -->
    <div id="launchScreen">
        <div class="launch-aircraft-wrap">
            <div class="launch-glow"></div>
            <div class="launch-ground"></div>
            <div class="launch-dashes"></div>

            <div class="launch-lights">
                <div class="launch-light"></div>
                <div class="launch-light"></div>
                <div class="launch-light"></div>
                <div class="launch-light"></div>
                <div class="launch-light"></div>
                <div class="launch-light"></div>
                <div class="launch-light"></div>
            </div>
            <img class="launch-aircraft-img"
                 src="https://raw.githubusercontent.com/vincent6786/Notion_metar_advanced/main/plane.png"
                 alt="Aircraft">
        </div>
        <div class="launch-title">METAR GO</div>
        <div class="launch-sub">Weather &amp; EFB</div>
        <div class="launch-version">CLOUD EDITION · v2.0</div>
    </div>

    <!-- ================================================================
         TOP BAR
    ================================================================ -->
    <div class="top-bar">
        <div class="search-wrapper">
            <div class="search-box">
                <span style="padding-left:4px">🔍</span>
                <input type="text" id="icao"
                       placeholder="Search (e.g. KJFK)"
                       onkeydown="if(event.key==='Enter') loadData()"
                       oninput="toggleClearBtn()"
                       autocapitalize="characters"
                       autocomplete="off"
                       autocorrect="off"
                       spellcheck="false">
                <span id="clearBtn" class="clear-btn" onclick="clearSearch()">✖</span>
                <button class="icon-btn" onclick="locateUser()" title="Near Me (GPS)"
                        style="border:none; background:transparent; width:30px; font-size:16px;">📍</button>
            </div>
        </div>
        <button class="icon-btn" onclick="loadData(true)" title="Force Refresh">↻</button>
        <div id="headerCat" class="badge badge-cat" onclick="toggleLegend(true)"
             style="cursor:pointer;" title="Tap for Legend">--</div>
        <div id="zuluTime" class="badge badge-time" onclick="toggleTimeDisplay()">
            <span id="zuluTimeMain" class="badge-time-main">--:--Z</span>
            <span id="zuluTimeOffset" class="badge-time-offset">UTC</span>
        </div>
        <a id="linkSkyVector" href="#" target="_blank" class="icon-btn" title="Charts">🗺️</a>
    </div>

    <!-- Quick-select / Recent History -->
    <div class="quick-select-row" id="recentHistoryRow"></div>

    <!-- No-Go Banner -->
    <div id="minBanner" class="hidden"
         style="padding:8px; text-align:center; font-weight:800; font-size:14px; margin-bottom:8px; border-radius:6px; cursor:pointer; background:var(--danger);"
         onclick="setTab('tools')">
        ⚠️ NO-GO CHECK TOOLS
    </div>

    <!-- Offline mode banner: pre-created for CSS Grid placement -->
    <div id="offlineBanner" class="offline-banner hidden" onclick="retryOnline()"></div>
    
    <!-- ================================================================
         TABS
    ================================================================ -->
    <div class="tabs" id="mainTabs">
        <!-- Default state (toggle OFF): METAR + TAF separate, no dashboard -->
        <div id="tabMetar"     class="tab active" onclick="setTab('metar')">METAR</div>
        <div id="tabTaf"       class="tab"        onclick="setTab('taf')">TAF</div>
        <!-- Enhanced state (toggle ON): combined WEATHER + DASHBOARD -->
        <div id="tabDashboard" class="tab hidden" onclick="setTab('dashboard')">DASHBOARD</div>
        <div id="tabWeather"   class="tab hidden" onclick="setTab('weather')">WEATHER</div>
        <!-- Always visible -->
        <div class="tab" onclick="setTab('info')">INFO</div>
        <div class="tab" onclick="setTab('atc')">ATC</div>
        <div class="tab" onclick="setTab('world')">WORLD</div>
        <div class="tab" onclick="setTab('tools')">TOOLS</div>
        <div class="tab" onclick="setTab('settings')">SETTINGS</div>
        <div class="tab" onclick="setTab('help')">HELP</div>
    </div>

    <!-- ================================================================
         TAB: METAR (original, shown when toggle OFF)
    ================================================================ -->
    <div id="tab-metar" class="view-section active">
    
        <!-- Wind Rose -->
        <div class="wind-vis-container">
            <canvas id="windRose" width="140" height="140" style="width:140px; height:140px;"></canvas>
            <div class="wind-controls">
                <div class="m-label">Selected Runway</div>
                <select id="rwySelect" class="stealth-select" onchange="drawWindRose()">
                    <option value="">Loading...</option>
                </select>
                <div class="wind-stats">
                    <div class="stat-row"><span class="info-label">Headwind</span> <span id="valHW">--</span></div>
                    <div class="stat-row"><span class="info-label">Crosswind</span> <span id="valXW">--</span></div>
                </div>
            </div>
        </div>
    
        <!-- AWOS Button (KMHR only) -->
        <button id="btnFetchLive" class="tool-btn hidden"
                style="margin-top:10px; margin-bottom:10px; background:#1c1c1e; border:1px solid #ff453a; color:#ff453a;"
                onclick="openAwosModal()">
            📡 Open Live Sensor View (KMHR)
        </button>
    
        <!-- METAR Data Grid -->
        <div class="metar-grid">
            <div id="skyVisuals" class="sky-section">
                <div class="sky-header">Sky Cover (AGL)</div>
                <div id="skyLayersContainer">
                    <div class="sky-no-data">Scanning Sky...</div>
                </div>
            </div>
            <div class="fr-bar-container">
                <div class="fr-header-row">
                    <div class="fr-header-row">
                        <div class="fr-title">Flight Category Breakdown</div>
                        <div onclick="toggleLegend(true)"
                             style="cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--sub-text);">?</div>
                    </div>
                </div>
                <div class="fr-gauge-group">
                    <div>
                        <div class="fr-row-label">
                            <span>Ceiling</span>
                            <span id="labelCeilVal" class="fr-val-text">--</span>
                        </div>
                        <div class="fr-track-modern">
                            <div class="fr-sec" style="width:25%"><span>LIFR</span></div>
                            <div class="fr-sec" style="width:25%"><span>IFR</span></div>
                            <div class="fr-sec" style="width:25%"><span>MVFR</span></div>
                            <div class="fr-sec" style="width:25%; border:none;"><span>VFR</span></div>
                            <div id="gaugeCeil" class="fr-fill-bar" style="width:0%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="fr-row-label">
                            <span>Visibility</span>
                            <span id="labelVisVal" class="fr-val-text">--</span>
                        </div>
                        <div class="fr-track-modern">
                            <div class="fr-sec" style="width:25%"><span>LIFR</span></div>
                            <div class="fr-sec" style="width:25%"><span>IFR</span></div>
                            <div class="fr-sec" style="width:25%"><span>MVFR</span></div>
                            <div class="fr-sec" style="width:25%; border:none;"><span>VFR</span></div>
                            <div id="gaugeVis" class="fr-fill-bar" style="width:0%;"></div>
                        </div>
                    </div>
                </div>
                <div id="frMessage" class="fr-msg">--</div>
            </div>
            <div class="metar-card"><div class="m-label">WIND</div><div class="m-value" id="mWind">--</div></div>
            <div class="metar-card"><div class="m-label">VISIBILITY</div><div class="m-value" id="mVis">--</div></div>
            <div class="metar-card"><div class="m-label">CEILING</div><div class="m-value" id="mCeil">--</div></div>
            <div class="metar-card"><div class="m-label">ALTIMETER</div><div class="m-value" id="mAlt">--</div></div>
            <div class="metar-card full-width">
                <div class="m-label">TEMP / DEWPOINT</div>
                <div class="m-value">
                    <span id="mTempC">--</span>
                    <span id="mTempF" class="m-sub">--</span>
                </div>
            </div>
        </div>
    
        <div class="section-header-row">
            <div class="section-title" style="margin:0;">RAW METAR</div>
            <button class="copy-btn" onclick="copyMetar()">📋 Copy</button>
        </div>
        <div class="raw-text" id="rawMetar">Select an airport above.</div>
        <div class="metar-footer">
            <span id="mAge">--</span>
            <span id="mSpread">Spread: --</span>
            <span id="mHumidity">RH: --%</span>
        </div>
    
        <div id="nearbyContainer" class="nearby-container">
            <div class="nearby-header">NEARBY STATIONS</div>
            <div id="nearList" class="nearby-list">
                <span style="color:var(--sub-text); font-size:12px;">--</span>
            </div>
        </div>
    </div>

    <!-- ================================================================
         TAB: TAF (original, shown when toggle OFF)
    ================================================================ -->
    <div id="tab-taf" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; color:var(--sub-text); font-size:12px; margin-bottom:8px;">
            <span>24H Trend (Open-Meteo)</span>
            <span style="background:var(--warn); color:#000; padding:2px 6px; border-radius:4px; font-weight:800; font-size:10px;">⚠️ ADVISORY only</span>
        </div>
        <div class="meteogram-container">
            <canvas id="meteoCanvas" height="150"></canvas>
            <div id="meteoLoading" class="sky-no-data"
                 style="position:absolute; top:50%; left:0; right:0; text-align:center;">Select Airport</div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; color:var(--sub-text); font-size:12px; margin-bottom:8px; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <div style="display:flex; align-items:center; gap:6px;">
                <span>Official Forecast Visualization</span>
                <span onclick="toggleLegend(true)" style="cursor:pointer; opacity:0.6;">ⓘ</span>
            </div>
            <span id="tafIssued">--</span>
        </div>
        <div class="taf-viz-container">
            <div id="tafNeedle" onclick="toggleTafNeedleTooltip()">
                <div id="tafNeedleTooltip"></div>
            </div>
            <div id="tafBar" class="taf-bar"></div>
            <div id="tafSkyStrip" class="taf-sky-strip"></div>
            <div id="tafAxis" class="taf-axis"></div>
            <div id="tafDetail" class="taf-detail-card hidden">
                <div class="td-header" style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <span id="tdTime" style="font-weight:700;">--</span>
                    <span id="tdType" style="background:#444; padding:2px 6px; border-radius:4px; color:#fff;">--</span>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div><span class="m-label">WIND</span><div id="tdWind" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">VISIBILITY</span><div id="tdVis" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">WEATHER</span><div id="tdWx" style="font-weight:600;">--</div></div>
                    <div><span class="m-label">CLOUDS</span><div id="tdCloud" style="font-weight:600;">--</div></div>
                </div>
            </div>
        </div>
        <div class="section-header-row">
            <div class="section-title" style="margin:0;">RAW TAF</div>
            <button class="copy-btn" onclick="copyTaf()">📋 Copy</button>
        </div>
        <div class="raw-text" id="rawTaf">--</div>
        <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">NOTAMs</div>
        <div id="notamList" class="raw-text"
             style="max-height:300px; overflow-y:auto; font-size:11px; background:transparent; padding:0;">Loading...</div>
    </div>
    
    <!-- ================================================================
         TAB: WEATHER (combined METAR+TAF, shown when toggle ON)
    ================================================================ -->
    <div id="tab-weather" class="view-section hidden">
    
        <!-- Pill toggle -->
        <div class="weather-pill-row">
            <button id="pillMetar" class="pill-btn active" onclick="switchWeatherPane('metar')">METAR</button>
            <button id="pillTaf"   class="pill-btn"        onclick="switchWeatherPane('taf')">TAF</button>
        </div>
    
        <!-- METAR pane -->
        <div id="weather-metar-pane">
            <div class="wind-vis-container">
                <canvas id="windRose2" width="140" height="140" style="width:140px; height:140px;"></canvas>
                <div class="wind-controls">
                    <div class="m-label">Selected Runway</div>
                    <select id="rwySelect2" class="stealth-select" onchange="drawWindRose()">
                        <option value="">Loading...</option>
                    </select>
                    <div class="wind-stats">
                        <div class="stat-row"><span class="info-label">Headwind</span> <span id="valHW2">--</span></div>
                        <div class="stat-row"><span class="info-label">Crosswind</span> <span id="valXW2">--</span></div>
                    </div>
                </div>
            </div>
            <button id="btnFetchLive2" class="tool-btn hidden"
                    style="margin-top:10px; margin-bottom:10px; background:#1c1c1e; border:1px solid #ff453a; color:#ff453a;"
                    onclick="openAwosModal()">
                📡 Open Live Sensor View (KMHR)
            </button>
            <div class="metar-grid">
                <div id="skyVisuals2" class="sky-section">
                    <div class="sky-header">Sky Cover (AGL)</div>
                    <div id="skyLayersContainer2"><div class="sky-no-data">Scanning Sky...</div></div>
                </div>
                <div class="fr-bar-container">
                    <div class="fr-header-row">
                        <div class="fr-title">Flight Category Breakdown</div>
                        <div onclick="toggleLegend(true)"
                             style="cursor:pointer; background:rgba(255,255,255,0.1); border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--sub-text);">?</div>
                    </div>
                    <div class="fr-gauge-group">
                        <div>
                            <div class="fr-row-label">
                                <span>Ceiling</span><span id="labelCeilVal2" class="fr-val-text">--</span>
                            </div>
                            <div class="fr-track-modern">
                                <div class="fr-sec" style="width:25%"><span>LIFR</span></div>
                                <div class="fr-sec" style="width:25%"><span>IFR</span></div>
                                <div class="fr-sec" style="width:25%"><span>MVFR</span></div>
                                <div class="fr-sec" style="width:25%; border:none;"><span>VFR</span></div>
                                <div id="gaugeCeil2" class="fr-fill-bar" style="width:0%;"></div>
                            </div>
                        </div>
                        <div>
                            <div class="fr-row-label">
                                <span>Visibility</span><span id="labelVisVal2" class="fr-val-text">--</span>
                            </div>
                            <div class="fr-track-modern">
                                <div class="fr-sec" style="width:25%"><span>LIFR</span></div>
                                <div class="fr-sec" style="width:25%"><span>IFR</span></div>
                                <div class="fr-sec" style="width:25%"><span>MVFR</span></div>
                                <div class="fr-sec" style="width:25%; border:none;"><span>VFR</span></div>
                                <div id="gaugeVis2" class="fr-fill-bar" style="width:0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="frMessage2" class="fr-msg">--</div>
                </div>
                <div class="metar-card"><div class="m-label">WIND</div><div class="m-value" id="mWind2">--</div></div>
                <div class="metar-card"><div class="m-label">VISIBILITY</div><div class="m-value" id="mVis2">--</div></div>
                <div class="metar-card"><div class="m-label">CEILING</div><div class="m-value" id="mCeil2">--</div></div>
                <div class="metar-card"><div class="m-label">ALTIMETER</div><div class="m-value" id="mAlt2">--</div></div>
                <div class="metar-card full-width">
                    <div class="m-label">TEMP / DEWPOINT</div>
                    <div class="m-value">
                        <span id="mTempC2">--</span>
                        <span id="mTempF2" class="m-sub">--</span>
                    </div>
                </div>
            </div>
            <div class="section-header-row">
                <div class="section-title" style="margin:0;">RAW METAR</div>
                <button class="copy-btn" onclick="copyMetar()">📋 Copy</button>
            </div>
            <div class="raw-text" id="rawMetar2">Select an airport above.</div>
            <div class="metar-footer">
                <span id="mAge2">--</span>
                <span id="mSpread2">Spread: --</span>
                <span id="mHumidity2">RH: --%</span>
            </div>
            <div id="nearbyContainer2" class="nearby-container">
                <div class="nearby-header">NEARBY STATIONS</div>
                <div id="nearList2" class="nearby-list">
                    <span style="color:var(--sub-text); font-size:12px;">--</span>
                </div>
            </div>
        </div><!-- /weather-metar-pane -->
    
        <!-- TAF pane -->
        <div id="weather-taf-pane" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; color:var(--sub-text); font-size:12px; margin-bottom:8px;">
                <span>24H Trend (Open-Meteo)</span>
                <span style="background:var(--warn); color:#000; padding:2px 6px; border-radius:4px; font-weight:800; font-size:10px;">⚠️ ADVISORY only</span>
            </div>
            <div class="meteogram-container">
                <canvas id="meteoCanvas2" height="150"></canvas>
                <div id="meteoLoading2" class="sky-no-data"
                     style="position:absolute; top:50%; left:0; right:0; text-align:center;">Select Airport</div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; color:var(--sub-text); font-size:12px; margin-bottom:8px; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
                <div style="display:flex; align-items:center; gap:6px;">
                    <span>Official Forecast Visualization</span>
                    <span onclick="toggleLegend(true)" style="cursor:pointer; opacity:0.6;">ⓘ</span>
                </div>
                <span id="tafIssued2">--</span>
            </div>
            <div class="taf-viz-container">
                <div id="tafNeedle2" onclick="toggleTafNeedleTooltip()">
                    <div id="tafNeedleTooltip2"></div>
                </div>
                <div id="tafBar2" class="taf-bar"></div>
                <div id="tafSkyStrip2" class="taf-sky-strip"></div>
                <div id="tafAxis2" class="taf-axis"></div>
                <div id="tafDetail2" class="taf-detail-card hidden">
                    <div class="td-header" style="display:flex; justify-content:space-between; margin-bottom:12px;">
                        <span id="tdTime2" style="font-weight:700;">--</span>
                        <span id="tdType2" style="background:#444; padding:2px 6px; border-radius:4px; color:#fff;">--</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div><span class="m-label">WIND</span><div id="tdWind2" style="font-weight:600;">--</div></div>
                        <div><span class="m-label">VISIBILITY</span><div id="tdVis2" style="font-weight:600;">--</div></div>
                        <div><span class="m-label">WEATHER</span><div id="tdWx2" style="font-weight:600;">--</div></div>
                        <div><span class="m-label">CLOUDS</span><div id="tdCloud2" style="font-weight:600;">--</div></div>
                    </div>
                </div>
            </div>
            <div class="section-header-row">
                <div class="section-title" style="margin:0;">RAW TAF</div>
                <button class="copy-btn" onclick="copyTaf()">📋 Copy</button>
            </div>
            <div class="raw-text" id="rawTaf2">--</div>
            <div style="margin-top:20px; font-weight:700; color:var(--sub-text);">NOTAMs</div>
            <div id="notamList2" class="raw-text"
                 style="max-height:300px; overflow-y:auto; font-size:11px; background:transparent; padding:0;">Loading...</div>
        </div><!-- /weather-taf-pane -->
    
    </div><!-- /tab-weather -->

    <!-- ================================================================
         TAB: INFO
    ================================================================ -->
    <div id="tab-info" class="view-section">
        <div style="font-size:20px; font-weight:700; margin-bottom:4px;" id="infoName">Unknown</div>
        <div style="font-size:12px; color:var(--sub-text); margin-bottom:12px;" id="infoLoc">--</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">ICAO / IATA</div><div class="ic-val" id="infoCodes">--</div></div>
            <div class="info-card"><div class="ic-lbl">Elevation</div><div class="ic-val" id="infoElev">--</div></div>
            <div class="info-card" style="grid-column:span 2;"><div class="ic-lbl">Coordinates</div><div class="ic-val" style="font-size:13px;" id="infoCoords">--</div></div>
        </div>
        <div class="section-title">ATMOSPHERE & TIME</div>
        <div class="info-grid">
            <div class="info-card"><div class="ic-lbl">Pressure Alt</div><div class="ic-val" id="calcPA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Density Alt</div><div class="ic-val" id="calcDA">--</div></div>
            <div class="info-card"><div class="ic-lbl">ISA Dev</div><div class="ic-val" id="calcISA">--</div></div>
            <div class="info-card"><div class="ic-lbl">Sunrise/Set</div><div class="ic-val" style="font-size:13px;" id="infoSun">--</div></div>
        </div>
        <div class="section-title">RUNWAYS & FREQ</div>
        <div id="freqContainer" class="freq-grid"></div>
        <!-- ATIS/AWOS Phone Numbers -->
        <div class="section-title">ATIS / AWOS PHONE</div>
        <div id="atisPhones" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-bottom:16px;">
            <div style="color:#555;font-size:12px;">Loading...</div>
        </div>
        <div class="section-title">RUNWAY WIND COMPONENTS</div>
        <div style="display:flex; gap:16px; margin-bottom:8px; font-size:10px; color:var(--sub-text); padding:0 4px;">
            <div style="display:flex; align-items:center; gap:6px;">
                <div style="width:10px; height:10px; background:var(--success); border-radius:2px;"></div>
                <span>HEADWIND</span>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <div style="width:10px; height:10px; background:#0a84ff; border-radius:2px;"></div>
                <span style="color:#0a84ff">CROSSWIND</span>
            </div>
        </div>
        <div id="runwayListComplex"></div>
    </div>

    <!-- ================================================================
         TAB: ATC
    ================================================================ -->
    <div id="tab-atc" class="view-section">
        <div class="section-title" style="margin-top:0;">CRAFT Clearance Recorder</div>
        <textarea id="craftPad" class="craft-pad"
                  placeholder="C - Clearance Limit&#10;R - Route&#10;A - Altitude&#10;F - Frequency&#10;T - Transponder"></textarea>

        <div class="info-card" style="margin-bottom:20px; margin-top:20px;">
            <div class="ic-lbl" style="margin-bottom:8px;" id="audioLabel">AUDIO STREAMS</div>
            <div id="audioPlayerTarget">
                <div style="color:var(--sub-text); font-style:italic; padding:10px; text-align:center;">
                    Select an airport to check for streams.
                </div>
            </div>
        </div>
        <div class="section-title">EXTERNAL RESOURCES</div>
        <a id="btnMetarTaf" href="https://metar-taf.com/" target="_blank" class="atc-btn"><span>☁️ Metar-Taf.com</span><span>↗</span></a>
        <a href="https://beta.twatc.net/" target="_blank" class="atc-btn"><span>🇹🇼 Taiwan Virtual ATC</span><span>↗</span></a>
        <a id="btnLiveAtc" href="https://www.liveatc.net/" target="_blank" class="atc-btn"><span>📡 LiveATC.net</span><span>↗</span></a>
    </div>

    <!-- ================================================================
         TAB: WORLD CLOCK
    ================================================================ -->
    <div id="tab-world" class="view-section">
        <div style="display:flex; gap:8px; margin-bottom:12px; background:var(--card-bg); padding:8px; border-radius:8px;">
            <input type="text" id="newCityInput" class="conv-inp"
                   placeholder="City Name (e.g. Paris) or ICAO (LFPG)..."
                   style="margin:0;">
            <button id="btnAddCity" class="tool-btn"
                    style="width:auto; margin:0; background:var(--accent); border:none;"
                    onclick="addCustomCity()">Add</button>
        </div>
        <div id="worldContainer" style="display:flex; flex-direction:column; gap:2px;"></div>
    </div>

    <!-- ================================================================
         TAB: TOOLS
    ================================================================ -->
    <div id="tab-tools" class="view-section">

        <!-- Cockpit Timer -->
        <div class="section-title" style="margin-top:0;">Cockpit Timer / Fuel</div>
        <div class="info-card" id="fuelCard" style="text-align:center; transition:background 0.3s;">
            <div style="font-size:11px; color:var(--sub-text); margin-bottom:4px; text-transform:uppercase;">COUNTDOWN TIMER</div>
            <div id="fuelDisplay"
                 style="font-size:48px; font-weight:800; font-family:'SF Mono', monospace; letter-spacing:-2px; margin:5px 0; font-variant-numeric:tabular-nums;">
                30:00
            </div>
            <div class="quick-select-row" style="justify-content:center; margin-bottom:15px; gap:8px;">
                <div id="btnFuel15" class="quick-chip" onclick="setFuelTime(15)">15m</div>
                <div id="btnFuel30" class="quick-chip active-fuel" onclick="setFuelTime(30)">30m</div>
                <div id="btnFuel45" class="quick-chip" onclick="setFuelTime(45)">45m</div>
                <div id="btnFuel60" class="quick-chip" onclick="setFuelTime(60)">60m</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btnFuelStart" class="tool-btn"
                        style="background:var(--success); border:none; color:#000;"
                        onclick="toggleFuelTimer()">START</button>
                <button class="tool-btn" style="background:#333; border:1px solid #555;"
                        onclick="resetFuelTimer()">RESET</button>
            </div>
        </div>

        <!-- Personal Minimums -->
        <div class="section-title" style="margin-top:0;">Personal Minimums</div>
        <div class="info-card" style="border-left:4px solid #555;" id="minsCard">
            <div class="conv-row">
                <div style="flex:1">
                    <div class="conv-lbl">Max X-Wind (kt)</div>
                    <input type="number" id="minXW" class="conv-inp" placeholder="e.g. 15"
                           oninput="checkMins()" autocomplete="off">
                </div>
                <div style="flex:1">
                    <div class="conv-lbl">Min Ceiling (ft)</div>
                    <input type="number" id="minCeil" class="conv-inp" placeholder="e.g. 1000"
                           oninput="checkMins()" autocomplete="off">
                </div>
            </div>
            <div id="minsResult"
                 style="margin-top:10px; font-weight:800; font-size:18px; text-align:center; padding:10px; border-radius:6px; background:#333; color:#aaa;">
                SET LIMITS
            </div>
        </div>

        <!-- E6B Flight Computer -->
        <div class="section-title">E6B Flight Computer</div>
        <div class="info-card">
            <div class="conv-row">
                <div style="flex:1">
                    <div class="conv-lbl">Indicated Alt (ft)</div>
                    <input type="number" id="e6bAlt" class="conv-inp" placeholder="0" oninput="calcE6B()">
                </div>
                <div style="flex:1">
                    <div class="conv-lbl">CAS / IAS (kts)</div>
                    <input type="number" id="e6bIas" class="conv-inp" placeholder="0" oninput="calcE6B()">
                </div>
            </div>
            <div class="conv-row" style="align-items:flex-end;">
                <div style="flex:1">
                    <div class="conv-lbl">Altimeter (QNH)</div>
                    <input type="number" id="e6bQnh" class="conv-inp" placeholder="1013" oninput="calcE6B()">
                </div>
                <div style="width:80px;">
                    <select id="unitQnh" class="stealth-select" onchange="calcE6B()" style="height:38px; font-size:13px;">
                        <option value="hpa">hPa</option>
                        <option value="inhg">inHg</option>
                    </select>
                </div>
            </div>
            <div class="conv-row" style="align-items:flex-end;">
                <div style="flex:1">
                    <div class="conv-lbl">OAT (Temp)</div>
                    <input type="number" id="e6bTemp" class="conv-inp" placeholder="15" oninput="calcE6B()">
                </div>
                <div style="flex:1">
                    <div class="conv-lbl">Dewpoint</div>
                    <input type="number" id="e6bDew" class="conv-inp" placeholder="10" oninput="calcE6B()">
                </div>
                <div style="width:80px;">
                    <select id="unitTemp" class="stealth-select" onchange="calcE6B()" style="height:38px; font-size:13px;">
                        <option value="c">°C</option>
                        <option value="f">°F</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                <div><div class="ic-lbl">Density Alt</div><div class="ic-val" id="resDA" style="color:var(--accent);">--</div></div>
                <div><div class="ic-lbl">True Airspeed</div><div class="ic-val" id="resTAS" style="color:var(--success);">--</div></div>
                <div><div class="ic-lbl">Cloud Base (AGL)</div><div class="ic-val" id="resCloud">--</div></div>
                <div><div class="ic-lbl">Freezing Lvl</div><div class="ic-val" id="resFrz">--</div></div>
            </div>
        </div>
    </div>

    <!-- ================================================================
         TAB: SETTINGS
    ================================================================ -->
    <div id="tab-settings" class="view-section">
        <div class="section-title" style="margin-top:0;">Startup Preferences</div>

        <!-- Favorite Airports -->
        <div class="section-title">Favorite Airports</div>
        <div class="info-card">
            <div class="conv-row" style="margin-bottom:8px;">
                <input type="text" id="favInput" class="conv-inp" placeholder="ICAO (e.g. RJBB)"
                       style="text-transform:uppercase;" maxlength="4">
                <button class="tool-btn" style="width:auto; margin:0;" onclick="addFavorite()">Add</button>
            </div>
            <div id="favSettingsList" style="display:flex; flex-wrap:wrap; gap:8px; min-height:30px;">
                <span style="color:var(--sub-text); font-size:12px; font-style:italic;">No favorites added.</span>
            </div>
        </div>

        <!-- Default Airport -->
        <div class="info-card">
            <div class="conv-lbl">Default Airport (ICAO)</div>
            <div class="conv-row" style="margin-bottom:0;">
                <input type="text" id="defaultIcaoInput" class="conv-inp" placeholder="e.g. RCTP"
                       style="text-transform:uppercase;" maxlength="4">
                <button class="tool-btn" style="width:auto; margin:0;" onclick="saveDefaultStation()">Save</button>
            </div>
            <div id="saveMsg" style="font-size:12px; color:var(--success); margin-top:8px; height:14px;"></div>
        </div>

        <!-- Visuals -->
        <div class="section-title">Visuals</div>
        <button id="btnNightMode" class="atc-btn" onclick="toggleNightMode()"
                style="justify-content:center; margin-bottom:20px; border:1px solid var(--danger);">
            <span>🔴 Cockpit Night Mode</span>
        </button>

        <!-- Multi-Airport Dashboard Toggle -->
        <div class="section-title">Multi-Airport Dashboard</div>
        <div style="background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-weight:700;margin-bottom:4px;">Enable Dashboard Tab</div>
                    <div style="font-size:12px;color:var(--sub-text);">Track up to 8 airports simultaneously</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleMultiDashboard" onchange="toggleMultiDashboard()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- API Usage Monitor -->
        <div class="section-title">API Usage Monitor</div>
        <div class="info-card" onclick="openApiStatsModal()" style="cursor:pointer;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div class="ic-lbl">AVWX API Status</div>
                    <div class="ic-val" id="apiStatusLabel">Loading...</div>
                </div>
                <div style="font-size:24px;">📊</div>
            </div>
            <div id="apiQuickStats"
                 style="margin-top:8px; padding-top:8px; border-top:1px solid #333; font-size:11px; color:#8e8e93;">
                Tap to view detailed breakdown
            </div>
        </div>

        <!-- Cloud Backup -->
        <div class="section-title">Cloud Backup</div>
        <div class="info-card" id="storageModeCard">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div>
                    <div class="ic-lbl">Backup Status</div>
                    <div class="ic-val" id="storageModeLabel">Loading...</div>
                </div>
                <button class="tool-btn" style="width:auto;" onclick="showStorageSetup()">Change</button>
            </div>
            <div id="cloudPinRow" style="display:none; font-size:12px; color:var(--sub-text); padding-top:8px; border-top:1px solid #333;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span>Backup Code</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="cloudPinDisplay" style="font-family:monospace; letter-spacing:4px; color:#fff;">••••</span>
                        <button onclick="toggleShowCode()" id="showCodeBtn"
                                style="background:transparent; border:1px solid #555; color:#8e8e93; border-radius:6px; padding:2px 8px; font-size:10px; cursor:pointer;">
                            Show
                        </button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span>Sync Status</span>
                    <span id="syncStatus" style="color:var(--success);">✅ Synced</span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span>Last Saved</span>
                    <span id="lastSyncTime" style="color:var(--sub-text);">--</span>
                </div>
                <div style="background:rgba(255,255,255,0.03); border-radius:8px; padding:8px 10px; margin-bottom:10px; font-size:11px; color:#555; line-height:1.5;">
                    ℹ️ Only your airport preferences are stored.<br>No personal information is collected.
                </div>
                <button class="tool-btn"
                        style="background:transparent; border:1px solid var(--danger); color:var(--danger);"
                        onclick="deleteCloudProfile()">
                    🗑️ Delete Cloud Backup Data
                </button>
            </div>
        </div>

        <!-- Data & Storage -->
        <div class="section-title">Data & Storage</div>
        <div class="info-card">
            <div style="font-size:12px; color:var(--sub-text); margin-bottom:8px;">
                Clear all saved data (Minimums, Default Airport, Cities).
            </div>
            <button class="tool-btn"
                    style="background:var(--card-bg); border:1px solid var(--danger); color:var(--danger);"
                    onclick="resetApp()">Factory Reset App</button>
        </div>
    </div>

    <!-- ================================================================
         SAFETY FOOTER
    ================================================================ -->
    <div class="safety-footer">
        NOT FOR NAVIGATION. REFERENCE ONLY. ALWAYS CROSS-CHECK OFFICIAL SOURCES.
    </div>
    

    <!-- ================================================================
         MODALS
    ================================================================ -->

    <!-- NEARBY AIRPORT PREVIEW MODAL -->
    <div id="nearbyModal" class="modal-overlay" onclick="closeNearbyModal()">
        <div class="info-card" style="margin:auto; width:92%; max-width:360px; border:1px solid var(--border); border-radius:16px; padding:0; overflow:hidden;"
             onclick="event.stopPropagation()">

            <!-- Header bar -->
            <div style="background:linear-gradient(135deg,#1c3a5e,#0a2040); padding:16px 16px 12px 16px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px;">
                    <div>
                        <div id="nearModalIcao" style="font-size:26px; font-weight:900; font-family:'SF Mono',monospace; color:#fff; letter-spacing:2px;">----</div>
                        <div id="nearModalName" style="font-size:13px; color:rgba(255,255,255,0.6); margin-top:2px;">Loading...</div>
                    </div>
                    <div id="nearModalCat" class="badge badge-cat" style="font-size:14px; padding:6px 14px; border-radius:8px;">--</div>
                </div>
                <div style="display:flex; gap:16px; margin-top:8px; font-size:11px; color:rgba(255,255,255,0.5);">
                    <span>📍 <span id="nearModalDist">-- nm</span> away</span>
                    <span>⛰ <span id="nearModalElev">-- ft</span> elev</span>
                    <span>🌐 <span id="nearModalCoords">--</span></span>
                </div>
            </div>

            <!-- Weather preview -->
            <div style="padding:14px 16px;">
                <div id="nearModalWeather" style="font-size:12px; color:var(--sub-text); font-style:italic; text-align:center; padding:8px 0;">
                    Fetching weather...
                </div>
            </div>

            <!-- Actions -->
            <div style="display:flex; gap:8px; padding:0 16px 16px 16px;">
                <button onclick="closeNearbyModal()" style="flex:1; background:#333; border:1px solid #555; color:#8e8e93; padding:12px; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer;">
                    Cancel
                </button>
                <button id="nearModalLoadBtn" onclick="loadNearbyFromModal()" style="flex:2; background:var(--accent); border:none; color:#fff; padding:12px; border-radius:10px; font-size:14px; font-weight:800; cursor:pointer;">
                    ✈️ Load Full Data
                </button>
            </div>
        </div>
    </div>
    
    <!-- AWOS Modal -->
    <div id="awosModal" class="modal-overlay">
        <div class="modal-header">
            <div style="font-weight:700;">📡 LIVE SENSOR (KMHR)</div>
            <button class="modal-close" onclick="closeAwosModal()">DONE</button>
        </div>
        <iframe id="awosFrame" class="browser-frame"
                sandbox="allow-same-origin allow-scripts"
                style="border:none; width:100%; height:100%;"></iframe>
    </div>

    <!-- API Stats Modal -->
    <div id="apiStatsModal" class="modal-overlay">
        <div class="modal-header">
            <div style="font-weight:700;">📊 API Usage Statistics</div>
            <button class="modal-close" onclick="closeApiStatsModal()">CLOSE</button>
        </div>
        <div style="padding:20px; overflow-y:auto; height:100%;">
            <div id="apiStatsContent"></div>
        </div>
    </div>

    <!-- Flight Rules Legend Modal -->
    <div id="legendModal" class="modal-overlay" onclick="toggleLegend(false)">
        <div class="info-card" style="margin:auto; width:90%; max-width:320px; border:1px solid var(--border);"
             onclick="event.stopPropagation()">
            <div class="modal-header" style="border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:10px;">
                <span style="font-weight:700;">FLIGHT RULES LEGEND</span>
                <button class="modal-close" onclick="toggleLegend(false)">✕</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center;">
                <div style="width:40px; height:25px; background:var(--success); border-radius:4px;"></div>
                <div>
                    <div style="font-weight:800; color:var(--success);">VFR</div>
                    <div style="font-size:11px; color:var(--sub-text);">Ceiling > 3000' & Vis > 5sm</div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center;">
                <div style="width:40px; height:25px; background:var(--mvfr); border-radius:4px;"></div>
                <div>
                    <div style="font-weight:800; color:var(--mvfr);">MVFR (Marginal)</div>
                    <div style="font-size:11px; color:var(--sub-text);">Ceiling 1000-3000' or Vis 3-5sm</div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center;">
                <div style="width:40px; height:25px; background:var(--danger); border-radius:4px;"></div>
                <div>
                    <div style="font-weight:800; color:var(--danger);">IFR</div>
                    <div style="font-size:11px; color:var(--sub-text);">Ceiling &lt; 1000' or Vis &lt; 3sm</div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:5px; align-items:center;">
                <div style="width:40px; height:25px; background:var(--lifr); border-radius:4px;"></div>
                <div>
                    <div style="font-weight:800; color:var(--lifr);">LIFR (Low IFR)</div>
                    <div style="font-size:11px; color:var(--sub-text);">Ceiling &lt; 500' or Vis &lt; 1sm</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================
         STORAGE MODE SETUP SCREEN
    ================================================================ -->
    <div id="storageSetup" class="setup-overlay" style="display:none;">
        <div style="font-size:40px; margin-bottom:12px;">✈️</div>
        <div style="font-size:22px; font-weight:800; color:#fff; margin-bottom:6px; text-align:center;">METAR PLUS</div>
        <div style="font-size:13px; color:#8e8e93; margin-bottom:32px; text-align:center; max-width:280px; line-height:1.6;">
            Choose how to save your airport preferences.
        </div>
        <div class="setup-card" onclick="chooseStorageMode('local')">
            <div style="font-size:24px; margin-bottom:8px;">📱</div>
            <div style="font-weight:800; font-size:16px; margin-bottom:6px; color:#fff;">This Device Only</div>
            <div style="font-size:12px; color:#8e8e93; line-height:1.6;">
                Your airports and settings stay on this device.<br>No account or code needed.<br>
                <span style="color:#ff9f0a;">⚠️ May reset if iOS clears app data.</span>
            </div>
        </div>
        <div class="setup-card highlighted" onclick="chooseStorageMode('cloud')">
            <div style="font-size:24px; margin-bottom:8px;">☁️</div>
            <div style="font-weight:800; font-size:16px; margin-bottom:6px; color:#fff;">Cloud Backup</div>
            <div style="font-size:12px; color:#8e8e93; line-height:1.6;">
                Backs up your airports and settings online.<br>Restore anytime on any device.<br>
                No account or personal info needed —<br>just a simple 4-6 digit Backup Code.<br>
                <span style="color:#32d74b;">✅ Recommended — survives app resets.</span>
            </div>
        </div>
        <div style="font-size:11px; color:#555; text-align:center; margin-top:12px;">
            You can change this anytime in Settings.
        </div>
    </div>

    <!-- ================================================================
         BACKUP CODE SETUP SCREEN
    ================================================================ -->
    <div id="pinSetup" class="setup-overlay" style="display:none;">
        <div style="font-size:32px; margin-bottom:8px;" id="pinIcon">☁️</div>
        <div style="font-size:20px; font-weight:800; color:#fff; margin-bottom:6px; text-align:center;" id="pinTitle">
            Set Up Cloud Backup
        </div>
        <div style="font-size:13px; color:#8e8e93; margin-bottom:6px; text-align:center; max-width:280px; line-height:1.6;" id="pinSubtitle">
            Create a 4-6 digit Backup Code to save your airports and settings to the cloud.
        </div>
        <div id="privacyNote"
             style="background:rgba(50,215,75,0.08); border:1px solid rgba(50,215,75,0.2); border-radius:10px; padding:10px 14px; margin-bottom:20px; max-width:280px; text-align:center;">
            <div style="font-size:11px; color:#32d74b; line-height:1.6;">
                🔒 Not linked to any account or personal info.<br>We only store your airport preferences.
            </div>
        </div>
        <!-- PIN Dots -->
        <div style="display:flex; gap:12px; justify-content:center; margin-bottom:16px;" id="pinDotsRow">
            <div class="pin-dot" id="dot_0"></div>
            <div class="pin-dot" id="dot_1"></div>
            <div class="pin-dot" id="dot_2"></div>
            <div class="pin-dot" id="dot_3"></div>
            <div class="pin-dot" id="dot_4" style="opacity:0.3;"></div>
            <div class="pin-dot" id="dot_5" style="opacity:0.3;"></div>
        </div>
        <div id="pinMsg" style="font-size:12px; color:#8e8e93; margin-bottom:20px; height:18px; text-align:center; font-weight:600;">
            Enter 4-6 digits
        </div>
        <!-- Number Pad -->
        <div style="display:grid; grid-template-columns:repeat(3, 72px); gap:12px; margin-bottom:20px;">
            <button class="pin-btn" onclick="pinPadPress('1')">1</button>
            <button class="pin-btn" onclick="pinPadPress('2')">2</button>
            <button class="pin-btn" onclick="pinPadPress('3')">3</button>
            <button class="pin-btn" onclick="pinPadPress('4')">4</button>
            <button class="pin-btn" onclick="pinPadPress('5')">5</button>
            <button class="pin-btn" onclick="pinPadPress('6')">6</button>
            <button class="pin-btn" onclick="pinPadPress('7')">7</button>
            <button class="pin-btn" onclick="pinPadPress('8')">8</button>
            <button class="pin-btn" onclick="pinPadPress('9')">9</button>
            <button class="pin-btn empty"></button>
            <button class="pin-btn" onclick="pinPadPress('0')">0</button>
            <button class="pin-btn delete" onclick="pinPadPress('⌫')">⌫</button>
        </div>
        <!-- Confirm Button -->
        <button id="pinConfirmBtn" onclick="submitPinEntry()"
                style="display:none; background:var(--accent); border:none; color:#fff; padding:14px 40px; border-radius:12px; font-size:16px; font-weight:800; cursor:pointer; margin-bottom:16px; width:100%; max-width:250px;">
            Continue →
        </button>
        <!-- Restore Option -->
        <div style="border-top:1px solid #222; padding-top:16px; width:100%; max-width:280px; text-align:center;" id="restoreSection">
            <div style="font-size:12px; color:#555; margin-bottom:10px;">
                Already set up Cloud Backup on another device?
            </div>
            <button onclick="switchToRestoreMode()"
                    style="background:transparent; border:1px solid #38383a; color:#8e8e93; padding:10px 20px; border-radius:8px; font-size:13px; cursor:pointer; width:100%;">
                Restore Using Existing Code
            </button>
        </div>
        <button onclick="backToStorageSetup()"
                style="background:transparent; border:none; color:#555; font-size:13px; cursor:pointer; margin-top:16px;">
            ← Back
        </button>
    </div>

        <!-- ================================================================
             TAB: HELP / USER MANUAL
        ================================================================ -->
            <div id="tab-help" class="view-section">

                <div style="font-size:20px; font-weight:800; margin-bottom:4px;">📖 METAR GO — User Guide</div>
                <div style="font-size:12px; color:var(--sub-text); margin-bottom:16px;">v2.0 · Cloud Edition · Quick reference for all features</div>
                
                <div class="help-section">
                    <div class="help-section-title">🌤 METAR Tab</div>
                    <div class="help-item">
                        <div class="help-q">Wind Rose</div>
                        <div class="help-a">Shows wind direction relative to the selected runway. <b style="color:var(--success);">Green = headwind</b>, <b style="color:var(--danger);">Red = tailwind</b>. The runway selector auto-picks the best runway for current winds. CALM and VRB winds are labelled directly on the rose.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Flight Category Badge (top right)</div>
                        <div class="help-a">
                            <span style="background:var(--success);color:#000;padding:1px 6px;border-radius:4px;font-weight:800;font-size:11px;">VFR</span> Ceiling &gt;3000ft &amp; Vis &gt;5sm &nbsp;
                            <span style="background:var(--mvfr);color:#fff;padding:1px 6px;border-radius:4px;font-weight:800;font-size:11px;">MVFR</span> 1000-3000ft / 3-5sm &nbsp;
                            <span style="background:var(--danger);color:#fff;padding:1px 6px;border-radius:4px;font-weight:800;font-size:11px;">IFR</span> &lt;1000ft / &lt;3sm &nbsp;
                            <span style="background:var(--lifr);color:#fff;padding:1px 6px;border-radius:4px;font-weight:800;font-size:11px;">LIFR</span> &lt;500ft / &lt;1sm<br>
                            <span style="color:var(--sub-text);">Tap the badge to open the legend. Tap the <b>time badge</b> to toggle between Zulu and local airport time.</span>
                        </div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Trend Indicators (↗ ↘ →)</div>
                        <div class="help-a">Appear next to Wind, Visibility, and Ceiling values after loading the same airport at least twice. Compares the current reading against ~1 hour ago. <span style="color:var(--success);">↗ Better</span> · <span style="color:var(--danger);">↘ Worse</span> · <span style="color:var(--warn);">→ Steady</span></div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Relative Humidity (RH)</div>
                        <div class="help-a">Shown in the footer below the raw METAR. <span style="color:var(--warn);">Orange</span> = dry (&lt;30%), <span style="color:var(--accent);">Blue</span> = very humid (&gt;80%). Temp–Dewpoint spread and RH together indicate fog risk.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Nearby Stations</div>
                        <div class="help-a">Tap any chip to open a preview card showing METAR, flight category, distance, and elevation. Tap <b>Load Full Data</b> to switch to that airport. Distance and bearing (e.g. 23nm · 045° NE) are shown from your current station.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Raw METAR Highlights</div>
                        <div class="help-a"><span style="color:var(--danger);font-weight:800;">Red</span> = gusts / low ceiling &nbsp; <span style="color:var(--lifr);font-weight:800;">Purple</span> = low visibility &nbsp; <span style="color:var(--warn);font-weight:800;">Orange</span> = thunderstorm / heavy precip</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">📋 Copy Button</div>
                        <div class="help-a">Copies the raw METAR string to your clipboard for pasting into flight planning tools or dispatch messages.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">📅 TAF Tab</div>
                    <div class="help-item">
                        <div class="help-q">Meteogram (24h Trend)</div>
                        <div class="help-a">Shows temperature (red line), dewpoint (blue line), wind arrows, speed, and weather icons from Open-Meteo. The <span style="color:#0a84ff;font-weight:700;">blue NOW line</span> marks your current time. When the red and blue lines nearly converge, fog risk is elevated. <b>Advisory only — not official aviation data.</b></div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">TAF Timeline Bar</div>
                        <div class="help-a">Each coloured block is a TAF forecast period. Tap a block to expand its details (wind, visibility, weather, clouds). The <span style="color:#ff453a;font-weight:700;">red needle</span> marks current time — tap it to see UTC and local airport time. The thin strip below shows the day/night cycle.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">TAF Expiry Timer</div>
                        <div class="help-a">Shows time remaining on the current TAF. Turns <span style="color:var(--warn);">orange</span> when under 30 minutes remain. An <span style="color:var(--danger);">⚠️ EXPIRED</span> badge appears if the TAF has lapsed.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">NOTAMs</div>
                        <div class="help-a">Colour-coded notices: <span style="color:#ff453a;font-weight:800;">⛔ Critical</span> (closures, unserviceable navaids), <span style="color:#ff9f0a;font-weight:800;">⚠️ Caution</span> (obstacles, work in progress), <span style="color:#8e8e93;">ℹ️ Info</span> (general). Data from FAA aviationweather.gov — updated every 10 minutes.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">📋 Copy Button</div>
                        <div class="help-a">Copies the full raw TAF text to clipboard.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">ℹ️ INFO Tab</div>
                    <div class="help-item">
                        <div class="help-q">Pressure &amp; Density Altitude</div>
                        <div class="help-a"><b>Pressure Alt</b> = ISA-corrected altitude. <b>Density Alt</b> = performance altitude. A <span style="color:var(--warn);">⚠️ warning</span> appears when DA is more than 2000ft above field elevation — expect degraded aircraft performance.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">ISA Deviation</div>
                        <div class="help-a">How far current temperature deviates from standard atmosphere. Positive = warmer (worse performance), Negative = cooler (better performance).</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Sunrise / Sunset</div>
                        <div class="help-a">Calculated from station coordinates using the NOAA algorithm. Defaults to Zulu. <b>Tap the time</b> to toggle UTC ↔ local airport time.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Frequencies</div>
                        <div class="help-a">Loaded from AVWX and supplemented by aviationweather.gov. If no data is available, a link to SkyVector is shown. Up to 9 frequencies are displayed.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">ATIS / AWOS Phone</div>
                        <div class="help-a">Direct-dial phone numbers for Taiwan airports (RCTP, RCSS, RCKH, RCMQ, RCFN, RCBS, RCKU) are built-in. For other airports, a link to AirNav is provided. Tap a number to dial directly.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Runway Wind Components</div>
                        <div class="help-a">Headwind ↑ / tailwind ↓ and crosswind ➡ / ⬅ for every runway. A <span style="color:var(--danger);">⚠️ LIMIT</span> badge appears when crosswind exceeds your personal limit set in Tools.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">📡 ATC Tab</div>
                    <div class="help-item">
                        <div class="help-q">CRAFT Clearance Recorder</div>
                        <div class="help-a">Scratchpad for IFR clearances using the standard format: <b>C</b>learance limit · <b>R</b>oute · <b>A</b>ltitude · <b>F</b>requency · <b>T</b>ransponder. Auto-saves as you type and persists between sessions.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Live Audio Streams</div>
                        <div class="help-a">In-app ATIS and ATC scanner streams for Taiwan airports (RCTP, RCSS, RCKH, RCMQ, RCBS, RCFN) via TWATC.net. For all other airports, the LiveATC button searches by ICAO code.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">External Links</div>
                        <div class="help-a">Metar-Taf.com and LiveATC.net links auto-update to your currently loaded airport's ICAO code.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">🛠 TOOLS Tab</div>
                    <div class="help-item">
                        <div class="help-q">Cockpit Timer</div>
                        <div class="help-a">Countdown timer for fuel burn or holding patterns. Presets: 15 / 30 / 45 / 60 min. The card flashes red and vibrates on expiry. Use PAUSE / RESUME to interrupt without resetting.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Personal Minimums</div>
                        <div class="help-a">Enter your crosswind and ceiling limits. The app checks live METAR data and shows <span style="color:var(--success);font-weight:800;">GO ✅</span> or <span style="color:var(--danger);font-weight:800;">NO-GO ⛔</span>. A red banner also appears at the top of the screen. Limits are saved automatically.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">E6B Flight Computer</div>
                        <div class="help-a">Enter Indicated Alt, IAS, QNH, temp, and dewpoint to calculate: <b>Density Altitude</b>, <b>True Airspeed</b>, <b>Estimated Cloud Base</b>, and <b>Freezing Level</b>. Supports hPa / inHg and °C / °F.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">🌍 WORLD Tab</div>
                    <div class="help-item">
                        <div class="help-q">World Clock</div>
                        <div class="help-a">Live local times with UTC offset. Type any ICAO code (e.g. EGLL, KJFK) and tap <b>Add</b>. Timezone is resolved automatically via coordinates. Tap <b>✕</b> to remove a city.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Cloud Sync of Cities</div>
                        <div class="help-a">When Cloud Backup is active, you'll be asked whether to sync your city list. Once enabled, your world clock restores on any device using your Backup Code.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">🗂 MULTI Tab (Dashboard)</div>
                    <div class="help-item">
                        <div class="help-q">Enabling the Dashboard</div>
                        <div class="help-a">Go to <b>Settings → Multi-Airport Dashboard</b> and toggle it on. The MULTI tab appears in the navigation. Track up to 8 airports at once.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Cards</div>
                        <div class="help-a">Each card shows the raw METAR with colour-coded flight category and data age. Tap any card to load that airport's full data across all other tabs. The × button removes an airport from the dashboard.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Auto-Refresh</div>
                        <div class="help-a">Data refreshes automatically every 5 minutes while the app is open. A ⚠️ badge appears on cards with data older than 60 minutes.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Cloud Sync</div>
                        <div class="help-a">Your airport list is saved to Cloud Backup (if enabled) whenever you add or remove airports. It restores automatically on any device using your Backup Code.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">⚙️ SETTINGS Tab</div>
                    <div class="help-item">
                        <div class="help-q">Favorite Airports ★</div>
                        <div class="help-a">Appear as gold chips above the search bar for one-tap access. Synced to Cloud Backup when enabled. Add via Settings → Favorite Airports.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Default Airport</div>
                        <div class="help-a">Loaded automatically every time the app opens. Set it once in Settings and the app always starts at your home airport.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">🔴 Cockpit Night Mode</div>
                        <div class="help-a">Switches all UI colours to red-on-black to preserve night vision in dark cockpit environments. Tap again (shows "Day Mode") to return to normal. Setting persists between sessions.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">☁️ Cloud Backup</div>
                        <div class="help-a">Saves favorites, default airport, world clock cities, and multi-airport list using a 4–6 digit code. No account or personal data needed. Restore on any device with your code. Choose <b>This Device Only</b> if you prefer local-only storage.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">API Usage Monitor</div>
                        <div class="help-a">Admin-only view showing daily AVWX API call counts across all keys. Requires admin password. Useful for monitoring usage before plan limits are reached.</div>
                    </div>
                </div>
                
                <div class="help-section">
                    <div class="help-section-title">🔍 Search, GPS &amp; Navigation</div>
                    <div class="help-item">
                        <div class="help-q">Search Bar</div>
                        <div class="help-a">Type any ICAO code (4 letters, e.g. RCTP, KJFK, EGLL) and press Enter or tap ↻. The field auto-capitalises. Recent airports appear as chips above the bar for quick re-loading.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">📍 GPS Button</div>
                        <div class="help-a">Uses your device GPS to find and load the nearest aviation weather station within 150nm. Distance and station name are shown in a toast notification. Allow location permission when prompted.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">↻ Force Refresh</div>
                        <div class="help-a">Clears the 10-minute data cache and fetches the latest METAR, TAF, and NOTAM data immediately from all sources.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Swipe Navigation</div>
                        <div class="help-a">On touch devices, swipe left/right anywhere on screen to move between tabs in order. Swiping is intentionally disabled on inputs, buttons, the canvas, and scrollable card areas to avoid conflicts.</div>
                    </div>
                    <div class="help-item">
                        <div class="help-q">Offline Mode</div>
                        <div class="help-a">When no connection is available, the app automatically serves the last cached data and shows an <span style="color:var(--warn);font-weight:700;">⚡ OFFLINE MODE</span> banner with the cache age. Tap the banner to retry when back online.</div>
                    </div>
                </div>
        
            </div>

        <!-- ================================================================
             TAB: MULTI-AIRPORT DASHBOARD (Optional)
        ================================================================ -->
        <div id="tab-dashboard" class="view-section">
            <div style="color:var(--sub-text);font-size:13px;margin-bottom:16px;line-height:1.5;">
                Track multiple airports at once. Tap any card to load full details in other tabs.
            </div>
            
            <div class="multi-add-form">
                <input type="text" 
                       id="multiAddInput" 
                       class="multi-add-input" 
                       placeholder="Enter ICAO (e.g. KJFK)" 
                       maxlength="4"
                       onkeypress="if(event.key==='Enter') addMultiAirport()">
                <button class="multi-add-btn" onclick="addMultiAirport()">+ Add</button>
            </div>
            
            <div id="multiGrid" class="multi-grid">
                <div class="multi-loading">Add airports above to start tracking</div>
            </div>
        </div>
    
</body>

<script>
        // ================================================================
        // 1. INDEXEDDB LAYER
        // ================================================================
        const EFB_DB = {
            db: null,

            async init() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open('efb_storage_v1', 1);
                    req.onupgradeneeded = (e) => {
                        e.target.result.createObjectStore('settings', { keyPath: 'key' });
                    };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                    req.onerror = () => { console.warn('IndexedDB failed, using localStorage'); resolve(); };
                });
            },

            async set(key, value) {
                try { localStorage.setItem(key, JSON.stringify(value)); } catch(e) {}
                if (!this.db) return;
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('settings', 'readwrite');
                    tx.objectStore('settings').put({ key, value: JSON.stringify(value) });
                    tx.oncomplete = resolve;
                    tx.onerror = () => reject(tx.error);
                });
            },

            async get(key, fallback = null) {
                if (this.db) {
                    try {
                        const result = await new Promise((resolve, reject) => {
                            const tx = this.db.transaction('settings', 'readonly');
                            const req = tx.objectStore('settings').get(key);
                            req.onsuccess = () => resolve(req.result);
                            req.onerror = () => reject(req.error);
                        });
                        if (result) return JSON.parse(result.value);
                    } catch(e) {}
                }
                const local = localStorage.getItem(key);
                if (local !== null) { try { return JSON.parse(local); } catch(e) {} }
                return fallback;
            },

            async delete(key) {
                try { localStorage.removeItem(key); } catch(e) {}
                if (!this.db) return;
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('settings', 'readwrite');
                    tx.objectStore('settings').delete(key);
                    tx.oncomplete = resolve;
                    tx.onerror = () => reject(tx.error);
                });
            }
        };

        // ================================================================
        // 2. CLOUD FUNCTIONS
        // ================================================================
        function getPin() { return localStorage.getItem('efb_cloud_pin') || null; }

        function updateSyncStatus(text, color) {
            const el = document.getElementById('syncStatus');
            if (el) { el.innerText = text; el.style.color = color; }
        }

        async function cloudSave(key, value) {
            const pin = getPin();
            if (!pin || !navigator.onLine) return;
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin, key, value })
                });
                if (!res.ok) throw new Error('Save failed');
                updateSyncStatus('✅ Synced', 'var(--success)');
            } catch(e) {
                console.warn('Cloud save failed:', e);
                updateSyncStatus('⚠️ Sync failed', 'var(--warn)');
            }
        }

        async function cloudLoad(key, fallback = null) {
            const pin = getPin();
            if (!pin || !navigator.onLine) return fallback;
            try {
                const res = await fetch(`/api/settings?pin=${pin}&key=${key}`);
                const data = await res.json();
                return data.value ?? fallback;
            } catch(e) { return fallback; }
        }

        async function cloudRestoreAll() {
            const pin = getPin();
            if (!pin || !navigator.onLine) return false;
            try {
                const res = await fetch(`/api/settings?pin=${pin}`);
                const data = await res.json();
                if (!data.found) return false;
                for (const [key, value] of Object.entries(data.settings)) {
                    await EFB_DB.set(key, value);
                }
                console.log('✅ Cloud restore complete');
                return true;
            } catch(e) {
                console.warn('Cloud restore failed:', e);
                return false;
            }
        }

        async function deleteCloudProfile() {
            const pin = localStorage.getItem('efb_cloud_pin');
            if (!pin) return;
            if (!confirm('⚠️ Delete Cloud Backup?\n\nThis removes all your saved airports and\nsettings from the cloud permanently.\n\nYour data on this device is kept.\nYou cannot undo this.')) return;
            try {
                const res = await fetch(`/api/settings?pin=${pin}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('🗑️ Cloud backup deleted');
                    updateSyncStatus('--', '#555');
                    const el = document.getElementById('lastSyncTime');
                    if (el) el.innerText = '--';
                } else { showToast('⚠️ Delete failed. Try again.'); }
            } catch(e) { showToast('⚠️ No connection. Try again.'); }
        }

        // ================================================================
        // 3. UNIFIED STORAGE ROUTER
        // ================================================================
        const Storage = {
            mode: null,

            async init() {
                await EFB_DB.init();

                // 1. Try localStorage first (fast path)
                this.mode = localStorage.getItem('efb_storage_mode');

                // 2. If localStorage was purged by iOS, recover from IndexedDB
                if (!this.mode) {
                    const recovered = await EFB_DB.get('_efb_storage_mode');
                    if (recovered) {
                        this.mode = recovered;
                        // Restore critical keys to localStorage
                        localStorage.setItem('efb_storage_mode', recovered);
                        const pin = await EFB_DB.get('_efb_cloud_pin');
                        if (pin) localStorage.setItem('efb_cloud_pin', pin);
                        console.log('✅ Session recovered from IndexedDB');
                        return true;
                    }
                }

                // 3. Truly first launch — show setup
                if (!this.mode) { showStorageSetup(); return false; }

                // 4. Start keep-alive to prevent future purges
                this._startKeepAlive();
                return true;
            },

            _startKeepAlive() {
                // Re-write critical keys every 23h so iOS never marks them stale
                setInterval(async () => {
                    if (this.mode) {
                        localStorage.setItem('efb_storage_mode', this.mode);
                        await EFB_DB.set('_efb_storage_mode', this.mode);
                        const pin = localStorage.getItem('efb_cloud_pin');
                        if (pin) await EFB_DB.set('_efb_cloud_pin', pin);
                    }
                }, 23 * 60 * 60 * 1000); // 23 hours
            },

            async set(key, value) {
                await EFB_DB.set(key, value);
                if (this.mode === 'cloud' && navigator.onLine) cloudSave(key, value);
            },

            async get(key, fallback = null) { return await EFB_DB.get(key, fallback); },

            async setMode(mode) {
                this.mode = mode;
                localStorage.setItem('efb_storage_mode', mode);
                // Also persist in IndexedDB for iOS resilience
                await EFB_DB.set('_efb_storage_mode', mode);
                this._startKeepAlive();
            }
        };

        function renderStorageModeUI() {
            const mode    = localStorage.getItem('efb_storage_mode');
            const pin     = localStorage.getItem('efb_cloud_pin');
            const label   = document.getElementById('storageModeLabel');
            const pinRow  = document.getElementById('cloudPinRow');
            const pinDisp = document.getElementById('cloudPinDisplay');
            if (!label) return;
            if (mode === 'cloud') {
                label.innerText = '☁️ Cloud Backup — Active';
                label.style.color = 'var(--accent)';
                if (pinRow) pinRow.style.display = 'block';
                if (pinDisp && pin) pinDisp.innerText = '•'.repeat(pin.length);
                updateLastSyncTime();
            } else {
                label.innerText = '📱 This Device Only';
                label.style.color = 'var(--success)';
                if (pinRow) pinRow.style.display = 'none';
            }
        }

        async function updateLastSyncTime() {
            const pin = localStorage.getItem('efb_cloud_pin');
            if (!pin) return;
            try {
                const res  = await fetch(`/api/settings?pin=${pin}&key=_lastUpdated`);
                const data = await res.json();
                const el   = document.getElementById('lastSyncTime');
                if (!el) return;
                if (data.value) {
                    const d = new Date(data.value);
                    el.innerText = d.toLocaleString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
                } else { el.innerText = 'Not yet synced'; }
            } catch(e) {
                const el = document.getElementById('lastSyncTime');
                if (el) el.innerText = 'Unknown';
            }
        }

        // ================================================================
        // 4. BACKUP CODE LOGIC
        // ================================================================
        window._pinEntry = '';
        window._pinStep  = 'create'; // 'create' | 'confirm' | 'restore'
        window._pinFirst = '';

        function showStorageSetup() {
            document.getElementById('storageSetup').style.display = 'flex';
            document.getElementById('pinSetup').style.display    = 'none';
        }
        function backToStorageSetup() {
            document.getElementById('pinSetup').style.display    = 'none';
            document.getElementById('storageSetup').style.display = 'flex';
        }

        async function chooseStorageMode(mode) {
            if (mode === 'local') {
                await Storage.setMode('local');
                document.getElementById('storageSetup').style.display = 'none';
                renderStorageModeUI();
                showToast('📱 Saved to this device only');
                initApp();
                return;
            }
            document.getElementById('storageSetup').style.display = 'none';
            document.getElementById('pinSetup').style.display     = 'flex';
            resetPinUI('create');
        }

        function resetPinUI(step) {
            window._pinEntry = ''; window._pinStep = step; window._pinFirst = '';
            const isRestore = step === 'restore';
            document.getElementById('pinIcon').innerText    = isRestore ? '🔄' : '☁️';
            document.getElementById('pinTitle').innerText   = isRestore ? 'Restore Cloud Backup' : 'Set Up Cloud Backup';
            document.getElementById('pinSubtitle').innerHTML = isRestore
                ? 'Enter the Backup Code you created on your other device.'
                : 'Create a 4-6 digit Backup Code to save your airports and settings to the cloud.';
            document.getElementById('privacyNote').style.display   = isRestore ? 'none' : 'block';
            document.getElementById('restoreSection').style.display = isRestore ? 'none' : 'block';
            document.getElementById('pinMsg').innerText      = isRestore ? 'Enter your Backup Code' : 'Enter 4-6 digits';
            document.getElementById('pinMsg').style.color    = '#8e8e93';
            document.getElementById('pinConfirmBtn').style.display = 'none';
            updatePinDots(0);
        }

        function switchToRestoreMode() { resetPinUI('restore'); }

        function updatePinDots(count) {
            [0,1,2,3,4,5].forEach(i => {
                const dot = document.getElementById(`dot_${i}`);
                if (!dot) return;
                if (i < count)      { dot.classList.add('filled'); dot.style.opacity = '1'; }
                else if (i < 4)     { dot.classList.remove('filled'); dot.style.opacity = '1'; }
                else                { dot.classList.remove('filled'); dot.style.opacity = count >= i ? '1' : '0.3'; }
            });
            const confirmBtn = document.getElementById('pinConfirmBtn');
            if (count >= 4) {
                confirmBtn.style.display = 'block';
                confirmBtn.innerText = window._pinStep === 'confirm' ? 'Confirm Code →' :
                                       window._pinStep === 'restore' ? 'Restore →' : 'Continue →';
            } else { confirmBtn.style.display = 'none'; }
        }

        function pinPadPress(val) {
            if (val === '⌫') { window._pinEntry = window._pinEntry.slice(0, -1); updatePinDots(window._pinEntry.length); return; }
            if (window._pinEntry.length >= 6) return;
            window._pinEntry += val;
            updatePinDots(window._pinEntry.length);
        }

        async function submitPinEntry() {
            const entered = window._pinEntry;
            const msg = document.getElementById('pinMsg');
            if (entered.length < 4) { msg.innerText = '⚠️ Enter at least 4 digits'; msg.style.color = 'var(--warn)'; return; }

            if (window._pinStep === 'create') {
                window._pinFirst = entered; window._pinEntry = ''; window._pinStep = 'confirm';
                document.getElementById('pinTitle').innerText    = 'Confirm Backup Code';
                document.getElementById('pinSubtitle').innerHTML = 'Enter your Backup Code again to confirm.';
                setTimeout(() => { updatePinDots(0); msg.innerText = 'Re-enter your Backup Code'; msg.style.color = '#8e8e93'; }, 200);

            } else if (window._pinStep === 'confirm') {
                if (entered === window._pinFirst) {
                    msg.innerText = '🔍 Checking availability...'; msg.style.color = '#8e8e93';
                    const inUse = await checkCodeAvailability(entered);
                    if (inUse) {
                        msg.innerText = '';
                        const warningDiv = document.createElement('div');
                        warningDiv.style.cssText = `background:rgba(255,159,10,0.12);border:1px solid rgba(255,159,10,0.4);border-radius:10px;padding:14px;margin:0 0 16px 0;text-align:center;max-width:260px;`;
                        warningDiv.id = 'codeWarning';
                        warningDiv.innerHTML = `
                            <div style="color:#ff9f0a;font-weight:800;margin-bottom:6px;font-size:13px;">⚠️ Code Already In Use</div>
                            <div style="color:#8e8e93;font-size:11px;line-height:1.6;margin-bottom:12px;">
                                This Backup Code already has saved data.<br>Choose a different code or restore the existing backup instead.
                            </div>
                            <div style="display:flex;gap:8px;justify-content:center;">
                                <button onclick="dismissCodeWarning()" style="background:#333;border:1px solid #555;color:#fff;padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">Choose Different</button>
                                <button onclick="restoreExistingInstead('${entered}')" style="background:var(--accent);border:none;color:#fff;padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">Restore Instead</button>
                            </div>`;
                        const numpad = document.querySelector('#pinSetup > div[style*="grid-template-columns"]');
                        if (numpad) numpad.before(warningDiv);
                    } else {
                        msg.innerText = '✅ Backup Code confirmed!'; msg.style.color = 'var(--success)';
                        setTimeout(() => finalizePinSetup(entered), 600);
                    }
                } else {
                    msg.innerText = '❌ Codes did not match. Try again.'; msg.style.color = 'var(--danger)';
                    window._pinEntry = ''; window._pinFirst = ''; window._pinStep = 'create';
                    document.getElementById('pinTitle').innerText    = 'Set Up Cloud Backup';
                    document.getElementById('pinSubtitle').innerHTML = 'Create a 4-6 digit Backup Code to save your airports and settings to the cloud.';
                    setTimeout(() => { updatePinDots(0); msg.innerText = 'Enter 4-6 digits'; msg.style.color = '#8e8e93'; }, 1500);
                }

            } else if (window._pinStep === 'restore') {
                msg.innerText = '🔍 Looking up your backup...'; msg.style.color = '#8e8e93';
                const confirmBtn = document.getElementById('pinConfirmBtn');
                confirmBtn.disabled = true; confirmBtn.innerText = 'Checking...';
                try {
                    const res  = await fetch(`/api/settings?pin=${entered}`);
                    const data = await res.json();
                    if (data.found) {
                        msg.innerText = '✅ Backup found!'; msg.style.color = 'var(--success)';
                        setTimeout(() => finalizePinSetup(entered), 600);
                    } else {
                        msg.innerText = '❌ No backup found for this code.'; msg.style.color = 'var(--danger)';
                        window._pinEntry = ''; confirmBtn.disabled = false;
                        setTimeout(() => { updatePinDots(0); msg.innerText = 'Enter your Backup Code'; msg.style.color = '#8e8e93'; confirmBtn.innerText = 'Restore →'; }, 2000);
                    }
                } catch(e) {
                    msg.innerText = '⚠️ No connection. Check internet.'; msg.style.color = 'var(--warn)';
                    window._pinEntry = ''; confirmBtn.disabled = false; confirmBtn.innerText = 'Restore →';
                    setTimeout(() => { updatePinDots(0); msg.innerText = 'Enter your Backup Code'; msg.style.color = '#8e8e93'; }, 2000);
                }
            }
        }

        function dismissCodeWarning() {
            document.getElementById('codeWarning')?.remove();
            resetPinUI('create');
            const msg = document.getElementById('pinMsg');
            msg.innerText = '⚠️ Choose a different code'; msg.style.color = 'var(--warn)';
            setTimeout(() => { msg.innerText = 'Enter 4-6 digits'; msg.style.color = '#8e8e93'; }, 2500);
        }

        async function restoreExistingInstead(code) {
            document.getElementById('codeWarning')?.remove();
            const msg = document.getElementById('pinMsg');
            msg.innerText = '☁️ Restoring your backup...'; msg.style.color = 'var(--accent)';
            setTimeout(() => finalizePinSetup(code), 600);
        }

        async function finalizePinSetup(pin) {
            localStorage.setItem('efb_cloud_pin', pin);
            await EFB_DB.set('_efb_cloud_pin', pin);   // ← ADD THIS LINE
            await Storage.setMode('cloud');
            const restored = await cloudRestoreAll();
            document.getElementById('pinSetup').style.display    = 'none';
            document.getElementById('storageSetup').style.display = 'none';
            renderStorageModeUI();
            showToast(restored ? '☁️ Backup restored successfully!' : '✅ Cloud Backup activated!');
            initApp();
        }

        // ================================================================
        // 5. API USAGE MONITORING
        // ================================================================
        let apiStatsCache = null;

        async function openApiStatsModal() {
            const modal   = document.getElementById('apiStatsModal');
            const content = document.getElementById('apiStatsContent');
            modal.classList.add('active');
            content.innerHTML = `
                <div style="text-align:center;padding:40px;color:#8e8e93;">
                    <div style="font-size:32px;margin-bottom:12px;">🔐</div>
                    <div style="font-weight:700;margin-bottom:8px;color:#fff;">Admin Access Required</div>
                    <div style="font-size:12px;margin-bottom:20px;">Enter admin password to view usage statistics</div>
                    <input type="password" id="apiAdminPassword" placeholder="Password"
                           onkeypress="if(event.key==='Enter') fetchApiStats()"
                           style="background:#1c1c1e;border:1px solid #555;color:#fff;padding:12px;border-radius:8px;width:200px;font-size:14px;text-align:center;margin-bottom:12px;">
                    <br>
                    <button onclick="fetchApiStats()" style="background:var(--accent);border:none;color:#fff;padding:10px 24px;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">View Stats</button>
                </div>`;
        }

        function closeApiStatsModal() { document.getElementById('apiStatsModal').classList.remove('active'); }

        async function fetchApiStats() {
            const content       = document.getElementById('apiStatsContent');
            const passwordInput = document.getElementById('apiAdminPassword');
            const password      = passwordInput?.value;
            if (!password) { alert('Please enter password'); return; }
            content.innerHTML = `<div style="text-align:center;padding:40px;color:#8e8e93;"><div style="font-size:32px;margin-bottom:12px;">⏳</div><div>Loading statistics...</div></div>`;
            try {
                const res = await fetch('/api/api-stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (res.status === 401) {
                    content.innerHTML = `<div style="text-align:center;padding:40px;"><div style="font-size:32px;margin-bottom:12px;">❌</div><div style="color:var(--danger);font-weight:700;margin-bottom:16px;">Incorrect Password</div><button onclick="openApiStatsModal()" style="background:#333;border:1px solid #555;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:13px;">Try Again</button></div>`;
                    return;
                }
                const data = await res.json();
                apiStatsCache = data;
                renderApiStats(data);
            } catch (err) {
                content.innerHTML = `<div style="text-align:center;padding:40px;color:var(--danger);"><div style="font-size:32px;margin-bottom:12px;">⚠️</div><div>Error loading stats: ${err.message}</div></div>`;
            }
        }

        function renderApiStats(data) {
            const content = document.getElementById('apiStatsContent');
            const { date, keys, aggregate } = data;
            let html = `
                <div style="margin-bottom:24px;">
                    <div style="font-size:11px;color:#8e8e93;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Date: ${date} UTC</div>
                    <div style="background:rgba(10,132,255,0.1);border:1px solid rgba(10,132,255,0.3);border-radius:12px;padding:16px;">
                        <div style="font-size:13px;color:#8e8e93;margin-bottom:6px;">Total Usage Across All Keys</div>
                        <div style="font-size:28px;font-weight:800;color:#fff;margin-bottom:8px;">${aggregate.total_usage.toLocaleString()} <span style="font-size:16px;color:#8e8e93;">/ ${aggregate.total_limit.toLocaleString()}</span></div>
                        <div style="font-size:12px;color:#0a84ff;">${aggregate.total_remaining.toLocaleString()} requests remaining (${aggregate.percentage}% used)</div>
                    </div>
                </div>
                <div style="font-size:11px;color:#8e8e93;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;">Individual Key Breakdown</div>`;
            keys.forEach(key => {
                const barColor = key.percentage >= 95 ? 'var(--danger)' : key.percentage >= 80 ? 'var(--warn)' : 'var(--success)';
                html += `
                    <div style="background:#1c1c1e;border:1px solid #333;border-radius:10px;padding:14px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <div style="font-weight:700;color:#fff;">Key #${key.id}</div>
                            <div style="font-size:13px;color:${barColor};font-weight:700;">${key.percentage}%</div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:12px;color:#8e8e93;margin-bottom:6px;">
                            <span>${key.usage.toLocaleString()} used</span>
                            <span>${key.remaining.toLocaleString()} remaining</span>
                        </div>
                        <div style="height:6px;background:#222;border-radius:3px;overflow:hidden;">
                            <div style="height:100%;background:${barColor};width:${key.percentage}%;transition:width 0.3s ease;"></div>
                        </div>
                    </div>`;
            });
            html += `<div style="margin-top:24px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:11px;color:#555;line-height:1.6;">ℹ️ Stats reset daily at midnight UTC. Keys rotate automatically based on usage.</div>`;
            content.innerHTML = html;
        }

        async function updateApiQuickStats() {
            const label = document.getElementById('apiStatusLabel');
            if (!label) return;
            label.innerText = '✅ Active';
            label.style.color = 'var(--success)';
        }

        function toggleShowCode() {
            const display = document.getElementById('cloudPinDisplay');
            const btn     = document.getElementById('showCodeBtn');
            const pin     = localStorage.getItem('efb_cloud_pin') || '';
            if (btn.innerText === 'Show') {
                display.innerText = pin; btn.innerText = 'Hide';
                setTimeout(() => { display.innerText = '•'.repeat(pin.length); btn.innerText = 'Show'; }, 5000);
            } else { display.innerText = '•'.repeat(pin.length); btn.innerText = 'Show'; }
        }

        // ================================================================
        // 6. GLOBAL STATE
        // ================================================================
        let currentWind     = { dir: 0, spd: 0 };
        let currentMetar    = { temp: 15, alt: 1013, altUnit: 'hPa' };
        let stationData     = null;
        let stationSunTimes = null;
        let useMetric       = true;
        let tafDataCache    = null;
        let lastMetarObj    = null;
        let meteoDataCache  = null;
        let cityList        = [];
        let stationOffsetSec = 0;
        let showLocalSun     = false;

        const CLOUD_ICON_PATH = "M25 15C25 10.58 21.42 7 17 7C16.5 7 16 7.05 15.54 7.15C14.73 4.19 12.06 2 9 2C5.13 2 2 5.13 2 9C2 9.17 2 9.35 2.03 9.5C0.84 10.19 0 11.5 0 13C0 15.21 1.79 17 4 17H25C27.76 17 30 14.76 30 12C30 9.24 27.76 7 25 7V15Z";

        // ================================================================
        // 7. INITIALIZATION
        // ================================================================
        function toggleLegend(show) {
            const el = document.getElementById('legendModal');
            if (show) el.classList.add('active'); else el.classList.remove('active');
        }

        async function initApp() {
            const ready = await Storage.init();
            if (!ready) return;

            const mode = localStorage.getItem('efb_storage_mode');
            if (mode === 'cloud' && navigator.onLine) await cloudRestoreAll();

            renderStorageModeUI();
            updateApiQuickStats();
            initWorldClock();
            checkNightModeSaved();
            renderFavoritesSettings();
            renderHistory();
            await checkMultiDashboardEnabled();
            

            const savedCraft = localStorage.getItem('efb_craft');
            if (savedCraft) document.getElementById('craftPad').value = savedCraft;
            document.getElementById('craftPad').addEventListener('input', (e) => {
                localStorage.setItem('efb_craft', e.target.value);
            });

            const savedDefault = await Storage.get('efb_default_station');
            const inputField   = document.getElementById('defaultIcaoInput');
            if (savedDefault) {
                inputField.value = savedDefault;
                document.getElementById('icao').value = savedDefault;
                loadData();
            } else {
                document.getElementById('icao').value = '';
            }

            const savedXW   = await Storage.get('efb_min_xw');
            const savedCeil = await Storage.get('efb_min_ceil');
            if (savedXW)   document.getElementById('minXW').value   = savedXW;
            if (savedCeil) document.getElementById('minCeil').value = savedCeil;

            setInterval(updateClock, 1000);
        }

        // ================================================================
        // 8. BACKEND FETCH LAYER
        // ================================================================
        async function secureFetch(endpoint) {
            const cacheKey = `cache_${endpoint}`;
            const cached   = localStorage.getItem(cacheKey);
            const cachedObj = cached ? (() => { try { return JSON.parse(cached); } catch(e) { return null; } })() : null;

            // Fresh cache (< 10 min) → return immediately
            if (cachedObj && Date.now() - cachedObj.ts < 600000) {
                return cachedObj.data;
            }

            try {
                const res = await fetch(endpoint);
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const data = await res.json();
                localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data }));
                hideOfflineBanner();
                return data;
            } catch (err) {
                // Network failure — fall back to stale cache if available
                if (cachedObj) {
                    const ageMin = Math.round((Date.now() - cachedObj.ts) / 60000);
                    console.warn(`[Offline] Serving stale cache for ${endpoint} (${ageMin}m old)`);
                    showOfflineBanner(cachedObj.ts);
                    return cachedObj.data;
                }
                // No cache at all — throw so the caller can show an error
                throw err;
            }
        }

        // ================================================================
        // 9. CORE DATA LOGIC
        // ================================================================
        function quickLoad(code) { document.getElementById('icao').value = code; loadData(); }

        async function saveDefaultStation() {
            const input = document.getElementById('defaultIcaoInput');
            const val   = input.value.trim().toUpperCase();
            const msg   = document.getElementById('saveMsg');
            if (val.length >= 3) {
                await Storage.set('efb_default_station', val);
                msg.innerText = "✅ Saved!"; msg.style.color = "var(--success)";
                showToast(`✅ Default airport set to ${val}`);
                if (document.getElementById('icao').value === "") { document.getElementById('icao').value = val; loadData(); }
            } else { msg.innerText = "⚠️ Invalid ICAO"; msg.style.color = "var(--warn)"; }
            setTimeout(() => { msg.innerText = ""; }, 3000);
        }

        async function resetApp() {
            const mode = localStorage.getItem('efb_storage_mode');
            let message = "Reset all local settings?\n\n";
            if (mode === 'cloud') {
                message += "✅ Your Cloud Backup is NOT affected.\nYou can restore it anytime with your Backup Code.\n\nTo also delete cloud data, go to\nSettings → Delete Cloud Backup Data first.";
            } else { message += "⚠️ This cannot be undone."; }
            if (!confirm(message)) return;
            localStorage.clear();
            await new Promise((resolve) => {
                const req = indexedDB.deleteDatabase('efb_storage_v1');
                req.onsuccess = resolve; req.onerror = resolve;
            });
            showToast('🗑️ App reset complete');
            setTimeout(() => location.reload(), 1000);
        }

        function renderHistory() {
            const container = document.getElementById('recentHistoryRow');
            container.innerHTML = '';
            const favs    = getFavorites();
            const history = JSON.parse(localStorage.getItem('efb_history')) || [];
            favs.forEach(code => {
                const chip = document.createElement('div');
                chip.className = 'quick-chip fav';
                chip.innerText = '★ ' + code;
                chip.onclick = () => quickLoad(code);
                container.appendChild(chip);
            });
            history.filter(h => !favs.includes(h)).slice(0, 6).forEach(code => {
                const chip = document.createElement('div');
                chip.className = 'quick-chip';
                chip.innerText = code;
                chip.onclick = () => quickLoad(code);
                container.appendChild(chip);
            });
        }

        function addToHistory(icao) {
            let history = JSON.parse(localStorage.getItem('efb_history')) || [];
            history = history.filter(item => item !== icao);
            history.unshift(icao);
            if (history.length > 5) history.pop();
            localStorage.setItem('efb_history', JSON.stringify(history));
            renderHistory();
        }

        // ================================================================
        // 10. FAVORITES
        // ================================================================
        function getFavorites() {
            const local = localStorage.getItem('efb_favorites');
            try { return local ? JSON.parse(local) : []; } catch(e) { return []; }
        }

        async function addFavorite() {
            const input = document.getElementById('favInput');
            const code  = input.value.trim().toUpperCase();
            if (code.length < 3) return;
            let favs = getFavorites();
            if (!favs.includes(code)) {
                favs.push(code);
                await Storage.set('efb_favorites', favs);
                renderFavoritesSettings(); renderHistory();
                showToast(`✅ ${code} added to favorites`);
            }
            input.value = '';
        }

        async function removeFavorite(code) {
            let favs = getFavorites().filter(f => f !== code);
            await Storage.set('efb_favorites', favs);
            renderFavoritesSettings(); renderHistory();
            showToast(`🗑️ ${code} removed`);
        }

        function renderFavoritesSettings() {
            const list = document.getElementById('favSettingsList');
            const favs = getFavorites();
            list.innerHTML = '';
            if (favs.length === 0) {
                list.innerHTML = '<span style="color:var(--sub-text);font-size:12px;font-style:italic;">No favorites added.</span>';
                return;
            }
            favs.forEach(code => {
                const chip = document.createElement('div');
                chip.className = 'quick-chip fav';
                chip.innerHTML = `${code} <span class="chip-del" onclick="removeFavorite('${code}')">✕</span>`;
                list.appendChild(chip);
            });
        }

        // ================================================================
        // 11. GPS LOCATE
        // ================================================================
        function locateUser() {
            const btn = document.querySelector('.search-box button[onclick="locateUser()"]')
                     || document.querySelector('.search-box button');
            btn.innerHTML = '⏳';

            if (!navigator.geolocation) {
                showToast('⚠️ Geolocation not supported on this device');
                btn.innerHTML = '📍';
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                try {
                    // Search up to 150nm radius
                    const data = await secureFetch(
                        `/api/weather?type=near&station=${lat},${lon}&distance=150`
                    );

                    if (!data || data.length === 0) {
                        showToast('⚠️ No aviation weather stations found within 150nm');
                        return;
                    }

                    const nearest = data[0];
                    const icao    = nearest.station.icao;
                    const nm      = Math.round(nearest.nautical_miles);
                    const name    = nearest.station.name || nearest.station.city || icao;

                    document.getElementById('icao').value = icao;
                    loadData();

                    // Friendly toast with airport info and distance
                    showToast(`📍 Nearest: ${icao} — ${name} · ${nm}nm away`);

                    // If there are more results, log them quietly for debugging
                    if (data.length > 1) {
                        console.log(
                            `[GPS Locate] Found ${data.length} stations within 150nm:`,
                            data.slice(0, 5).map(d =>
                                `${d.station.icao} (${Math.round(d.nautical_miles)}nm)`
                            ).join(', ')
                        );
                    }

                } catch(e) {
                    console.error('GPS locate error:', e);
                    showToast('❌ Error searching for nearby stations — check connection');
                } finally {
                    btn.innerHTML = '📍';
                }

            }, (err) => {
                const msg = err.code === 1
                    ? '🔒 Location permission denied — enable in browser settings'
                    : '❌ GPS unavailable or timed out';
                showToast(msg);
                btn.innerHTML = '📍';
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000   // accept a cached position up to 60s old
            });
        }

        // ================================================================
        // 11b. LOADING SKELETONS
        // ================================================================
        function showLoadingSkeletons() {
            // Raw METAR skeleton
            document.getElementById('rawMetar').innerHTML = `
                <div class="skeleton" style="height:80px;"></div>`;
            
            // Sky section skeleton
            document.getElementById('skyLayersContainer').innerHTML = `
                <div class="skeleton-text" style="width:70%;"></div>
                <div class="skeleton-text" style="width:85%;margin-top:8px;"></div>
                <div class="skeleton-text" style="width:60%;margin-top:8px;"></div>`;
            
            // Flight rule bars skeleton
            document.getElementById('labelCeilVal').innerText = '--';
            document.getElementById('labelVisVal').innerText = '--';
            document.getElementById('gaugeCeil').style.width = '0%';
            document.getElementById('gaugeVis').style.width = '0%';
            document.getElementById('frMessage').innerText = 'Analyzing conditions...';
            
            // Value cards skeleton
            const cardIds = ['mWind', 'mVis', 'mCeil', 'mAlt', 'mTempC'];
            cardIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<div class="skeleton" style="height:18px;width:70%;"></div>';
            });
            
            // TAF skeleton
            document.getElementById('rawTaf').innerText = 'Loading forecast...';
            document.getElementById('tafBar').innerHTML = `
                <div class="skeleton" style="height:40px;flex:1;margin-right:4px;"></div>
                <div class="skeleton" style="height:40px;flex:1;margin-right:4px;"></div>
                <div class="skeleton" style="height:40px;flex:1;"></div>`;
            
            // NOTAM skeleton
            document.getElementById('notamList').innerHTML = `
                <div class="skeleton-card">
                    <div class="skeleton-text" style="width:90%;"></div>
                    <div class="skeleton-text" style="width:75%;"></div>
                </div>`;
        }
    
// ================================================================
        // 12. MAIN DATA LOADER
        // ================================================================
        async function loadData(force = false) {
            const icaoVal = document.getElementById('icao').value;
            if (!icaoVal) return;
            
            if (force) {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('cache_')) localStorage.removeItem(key);
                });
                console.log('[Force Refresh] API cache cleared');
            }
            
            const icao = icaoVal.toUpperCase();
            addToHistory(icao);
            document.getElementById('icao').blur();
            document.getElementById('linkSkyVector').href = `https://skyvector.com/airport/${icao}`;
            updateHeaderCat('Loading', '');
            
            // Show skeletons immediately for instant feedback
            showLoadingSkeletons();
            document.getElementById('nearList').innerHTML = '<span style="color:#555;font-size:12px;">Scanning…</span>';

            try {
                // ── PHASE 1: Station data (fastest, ~100ms) ──
                stationData = await secureFetch(`/api/weather?type=station&station=${icao}`);
                if (stationData._meta) console.log(`%c[AVWX] Station - Key #${stationData._meta.key_used}`, 'color:#0a84ff;font-weight:bold;');
                
                renderInfo(stationData);
                updateAudioSection(icao);
                
                // ── PHASE 2: Start slow tasks in background (don't block) ──
                if (stationData?.latitude != null && stationData?.longitude != null) {
                    findNearbyStations(stationData.latitude, stationData.longitude);
                    fetchMeteogram(stationData.latitude, stationData.longitude);
                } else {
                    document.getElementById('nearList').innerHTML =
                        '<span style="color:#555;font-size:12px;">No coordinates for this station.</span>';
                }
                
                // ── PHASE 3: Weather data in parallel - render each as it completes ──
                const weatherPromises = Promise.allSettled([
                    secureFetch(`/api/weather?type=metar&station=${icao}`),
                    secureFetch(`/api/weather?type=taf&station=${icao}`),
                    fetchNotamsFAA(icao)
                ]);
                
                // Process results as they arrive
                weatherPromises.then(([metarRes, tafRes, notamRes]) => {
                    
                    // METAR
                    if (metarRes.status === 'fulfilled' && !metarRes.value.error) {
                        const m = metarRes.value;
                        if (m._meta) console.log(`%c[AVWX] METAR - Key #${m._meta.key_used}`, 'color:#0a84ff;font-weight:bold;');
                        
                        lastMetarObj = m;
                        let dirVal = m.wind_direction?.value;
                        if (m.wind_direction?.repr === 'VRB' || (dirVal === null && m.wind_speed?.value > 0)) dirVal = 'VRB';
                        currentWind = { dir: dirVal === null ? 0 : dirVal, spd: m.wind_speed?.value || 0 };
                        let altVal = m.altimeter?.value || 1013;
                        let altUnit = altVal < 200 ? 'inHg' : 'hPa';
                        currentMetar = { temp: m.temperature?.value || 15, alt: altVal, altUnit };
                        
                        renderMetar(m);
                        renderSkyVisuals(m);
                        renderFlightRuleBar(m);
                        setupRunwaySelect();
                        
                        // Store for trend analysis
                        storeMetarForTrend(icao, m);
                        
                        const liveBtn = document.getElementById('btnFetchLive');
                        if (icao === 'KMHR') liveBtn.classList.remove('hidden'); 
                        else liveBtn.classList.add('hidden');
                    } else {
                        updateHeaderCat('N/A', 'cat-ifr');
                        document.getElementById('rawMetar').innerHTML = `
                            <div style="text-align:center;padding:20px 10px;">
                                <div style="color:var(--danger);font-weight:800;margin-bottom:15px;">METAR UNAVAILABLE</div>
                            </div>`;
                    }
                    
                    // TAF
                    if (tafRes.status === 'fulfilled') {
                        const tafData = tafRes.value;
                        if (tafData._meta) console.log(`%c[AVWX] TAF - Key #${tafData._meta.key_used}`, 'color:#0a84ff;font-weight:bold;');
                        renderTaf(tafData);
                    } else {
                        document.getElementById('rawTaf').innerText = 'No TAF available for this station.';
                    }
                    
                    // NOTAMs
                    if (notamRes.status === 'fulfilled') {
                        renderNotams(notamRes.value);
                    } else {
                        document.getElementById('notamList').innerHTML = 
                            '<div style="color:#555;font-style:italic;padding:8px;">No NOTAMs available.</div>';
                    }
                });

            } catch(e) {
                console.error('[loadData] Error:', e);
                updateHeaderCat('N/A', 'cat-ifr');
                const ic = document.getElementById('icao').value.toUpperCase();
                document.getElementById('rawMetar').innerHTML = `
                    <div style="text-align:center;padding:20px 10px;">
                        <div style="color:var(--danger);font-weight:800;margin-bottom:15px;">STATION DATA UNAVAILABLE</div>
                        <a href="https://metar-taf.com/${ic}" target="_blank" class="atc-btn" 
                           style="justify-content:center;background:var(--accent);border:none;color:#fff;">
                            <span>View on Metar-Taf.com ↗</span>
                        </a>
                    </div>`;
            }
        }

        // ================================================================
        // 13. NOTAMs
        // ================================================================
        function renderNotams(rawData) {
            const container = document.getElementById('notamList');

            // Handle both FAA format (array of objects) and legacy format
            let notams = [];
            if (Array.isArray(rawData)) {
                if (rawData.length === 0) { container.innerHTML = "No NOTAMs Found"; return; }

                // Detect FAA format: objects have a "text" or "traditional" string field
                if (rawData[0]?.text || rawData[0]?.traditional) {
                    // FAA aviationweather.gov format
                    notams = rawData.map(n => ({
                        raw:        n.traditional || n.text || '',
                        number:     n.notamNumber || '',
                        start:      n.startDate   || '',
                        end:        n.endDate      || '',
                        location:   n.icaoLocation || ''
                    }));
                } else {
                    // Legacy AVWX format: array of { raw, start_time, ... }
                    notams = rawData.map(n => ({
                        raw:   n.raw || '',
                        number:'',
                        start: n.start_time?.dt || '',
                        end:   '',
                        location: ''
                    }));
                }
            } else {
                container.innerHTML = "No NOTAMs Found";
                return;
            }

            // Classify
            const critical = [], warning = [], info = [];
            notams.forEach(n => {
                const raw = n.raw.toUpperCase();
                if (/(CLSD|CLOSED|U\/S|UNSERVICEABLE|FAIL|OTS|OUT OF SERVICE)/.test(raw))
                    critical.push(n);
                else if (/(OBST|OBSTACLE|WORK|WIP|TRIGGER|SNOW|ICE|DANGER|HAZARD|RESTRICTED|CRANE|LASER)/.test(raw))
                    warning.push(n);
                else
                    info.push(n);
            });

            const formatDate = (iso) => {
                if (!iso) return '';
                try {
                    const d = new Date(iso);
                    return `${d.getUTCDate().toString().padStart(2,'0')}/${(d.getUTCMonth()+1).toString().padStart(2,'0')} ${d.getUTCHours().toString().padStart(2,'0')}:${d.getUTCMinutes().toString().padStart(2,'0')}Z`;
                } catch(e) { return iso; }
            };

            const renderGroup = (list, title, color) => {
                if (list.length === 0) return '';
                return `
                    <div style="color:${color};font-weight:800;margin:14px 0 4px 0;font-size:11px;text-transform:uppercase;">
                        ${title} (${list.length})
                    </div>
                    ${list.map(n => `
                        <div style="margin-bottom:8px;border-left:3px solid ${color};background:rgba(255,255,255,0.03);border-radius:4px;padding:7px 8px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                <span style="color:${color};font-size:10px;font-weight:800;">${n.number || ''}</span>
                                <span style="color:#555;font-size:9px;">${formatDate(n.start)}${n.end ? ' → ' + formatDate(n.end) : ''}</span>
                            </div>
                            <div style="font-size:11px;font-family:'SF Mono',monospace;line-height:1.5;color:#ccc;white-space:pre-wrap;word-break:break-word;">
                                ${formatNotamText(n.raw)}
                            </div>
                        </div>`).join('')}`;
            };

            const html = renderGroup(critical, '⛔ CRITICAL', '#ff453a')
                       + renderGroup(warning,  '⚠️ CAUTION',  '#ff9f0a')
                       + renderGroup(info,     'ℹ️ INFO',      '#8e8e93');

            container.innerHTML = html ||
                '<div style="color:#555;font-style:italic;padding:8px;">No active NOTAMs.</div>';
        }

        // ================================================================
        // 13b. FAA NOTAM FETCH (aviationweather.gov — free, no key)
        // ================================================================
        async function fetchNotamsFAA(icao) {
            const url = `https://aviationweather.gov/api/data/notam?icaos=${icao}&format=json`;
            const cacheKey = `cache_faa_notam_${icao}`;

            // Check cache first (10 min)
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const c = JSON.parse(cached);
                if (Date.now() - c.ts < 600000) return c.data;
            }

            const res  = await fetch(url);
            if (!res.ok) throw new Error(`FAA NOTAM API: ${res.status}`);
            const data = await res.json();
            localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data }));
            return data;
        }
    
        // ================================================================
        // 14. AUDIO SECTION
        // ================================================================
        function updateAudioSection(icao) {
            const container   = document.getElementById('audioPlayerTarget');
            const label       = document.getElementById('audioLabel');
            const liveAtcBtn  = document.getElementById('btnLiveAtc');
            if (liveAtcBtn) {
                liveAtcBtn.href = `https://www.liveatc.net/search/?icao=${icao}`;
                liveAtcBtn.innerHTML = `<span>📡 LiveATC (${icao})</span><span>↗</span>`;
            }

            // Update Metar-Taf link with current airport
            const metarTafBtn = document.getElementById('btnMetarTaf');
            if (metarTafBtn) {
                metarTafBtn.href = `https://metar-taf.com/?hl=${icao}`;
                metarTafBtn.innerHTML = `<span>☁️ Metar-Taf.com (${icao})</span><span>↗</span>`;
            }

            // Stream configs: [ICAO, labelText, streams[]]
            const streamConfigs = {
                RCTP: { label: "RCTP LIVE STREAMS (TWATC)", streams: [
                    { type: "ATIS",        src: "https://stream.twatc.net/RCTP_ATIS",  color: "var(--accent)" },
                    { type: "ATC SCANNER", src: "https://stream.twatc.net/RCTP_Scan2", color: "var(--success)" }
                ]},
                RCSS: { label: "RCSS LIVE STREAMS", streams: [
                    { type: "ATIS",        src: "https://stream.twatc.net/RCSS_ATIS",  color: "var(--accent)" },
                    { type: "ATC SCANNER", src: "https://stream.twatc.net/RCSS_Scan2", color: "var(--success)" }
                ]},
                RCKH: { label: "RCKH LIVE STREAMS", streams: [
                    { type: "ATIS",        src: "https://stream.twatc.net/RCKH_ATIS",  color: "var(--accent)" },
                    { type: "ATC SCANNER", src: "https://stream.twatc.net/RCKH_Scan2", color: "var(--success)" }
                ]},
                RCMQ: { label: "RCMQ LIVE STREAMS", streams: [
                    { type: "ATIS", src: "https://stream.twatc.net/RCMQ_ATIS", color: "var(--accent)" }
                ]},
                RCBS: { label: "RCBS LIVE STREAMS", streams: [
                    { type: "ATIS", src: "https://stream.twatc.net/RCBS_ATIS", color: "var(--accent)" }
                ]},
                RCFN: { label: "RCFN LIVE STREAMS", streams: [
                    { type: "ATIS", src: "https://stream.twatc.net/RCFN_ATIS", color: "var(--accent)" }
                ]}
            };

            const cfg = streamConfigs[icao];
            if (cfg) {
                label.innerText = cfg.label;
                container.innerHTML = cfg.streams.map(s => `
                    <div style="margin-bottom:12px;">
                        <div class="m-label" style="color:${s.color};">${s.type}</div>
                        <audio controls style="width:100%;height:32px;border-radius:16px;">
                            <source src="${s.src}" type="audio/mpeg">
                        </audio>
                    </div>`).join('') +
                    `<div style="font-size:10px;color:#555;margin-top:8px;text-align:right;">Source: TWATC.net</div>`;
            } else {
                label.innerText = "AUDIO STREAMS";
                container.innerHTML = `<div style="color:var(--sub-text);font-size:13px;text-align:center;padding:10px 0;">No direct in-app stream available for ${icao}.<br><span style="font-size:11px;color:#555;">Use the LiveATC button below.</span></div>`;
            }
        }

        // ================================================================
        // 15. METEOGRAM
        // ================================================================
        async function fetchMeteogram(lat, lon) {
            const loader = document.getElementById('meteoLoading');
            loader.style.display = 'block'; loader.innerText = 'Loading...';
            meteoDataCache = null;
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,dewpoint_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m,weather_code,temperature_925hPa,windspeed_925hPa,winddirection_925hPa,temperature_850hPa,windspeed_850hPa,winddirection_850hPa,temperature_700hPa,windspeed_700hPa,winddirection_700hPa&wind_speed_unit=kn&forecast_days=1&timezone=auto`;
                const res  = await fetch(url);
                const data = await res.json();
                stationOffsetSec = data.utc_offset_seconds || 0;
                updateSunDisplay();
                if (data.hourly) {
                    meteoDataCache = data.hourly;
                    loader.style.display = 'none';
                    const loader2 = document.getElementById('meteoLoading2');
                    if (loader2) loader2.style.display = 'none';
                    setTimeout(() => {
                        drawMeteogram(meteoDataCache);
                        drawMeteogram2(meteoDataCache);
                    }, 50);
                    const now = new Date();
                    const idx = now.getUTCHours();
                    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    const fmtW = (d, s) => `${d}° / ${Math.round(s)}kt`;
                    const fmtT = t => `${Math.round(t)}°C`;
                    setEl('wind3k',  fmtW(data.hourly.winddirection_925hPa[idx], data.hourly.windspeed_925hPa[idx]));
                    setEl('temp3k',  fmtT(data.hourly.temperature_925hPa[idx]));
                    setEl('wind5k',  fmtW(data.hourly.winddirection_850hPa[idx], data.hourly.windspeed_850hPa[idx]));
                    setEl('temp5k',  fmtT(data.hourly.temperature_850hPa[idx]));
                    setEl('wind10k', fmtW(data.hourly.winddirection_700hPa[idx], data.hourly.windspeed_700hPa[idx]));
                    setEl('temp10k', fmtT(data.hourly.temperature_700hPa[idx]));
                }
            } catch(e) { console.error("Meteo Error:", e); loader.style.display = 'block'; loader.innerText = "⚠️ Model Data Unavailable"; }
        }

        function drawMeteogram(h) {
            const cvs = document.getElementById('meteoCanvas');
            const ctx = cvs.getContext('2d');
            const dpr  = window.devicePixelRatio || 1;
            const rect = cvs.getBoundingClientRect();
            cvs.width  = rect.width * dpr; cvs.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width, H = rect.height;
            const padding = { top: 40, bottom: 35, left: 15, right: 15 };
            ctx.clearRect(0, 0, W, H);
            const len = 24; const now = new Date();
            let minT = 100, maxT = -100;
            for (let i = 0; i < len; i++) { minT = Math.min(minT, h.temperature_2m[i], h.dewpoint_2m[i]); maxT = Math.max(maxT, h.temperature_2m[i], h.dewpoint_2m[i]); }
            minT -= 2; maxT += 2; const rangeT = maxT - minT;
            const getX = (i) => padding.left + (i / (len - 1)) * (W - padding.left - padding.right);
            const getY = (v) => H - padding.bottom - ((v - minT) / rangeT) * (H - padding.top - padding.bottom);
            const getWxIcon = (code) => {
                if (code <= 1) return '☀️'; if (code <= 3) return '⛅'; if (code <= 48) return '🌫️';
                if (code <= 57) return '🌧️'; if (code <= 67) return '☔'; if (code <= 77) return '❄️';
                if (code <= 82) return '⛈️'; if (code <= 99) return '⚡'; return '☁️';
            };
            // Vertical grid
            ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.lineWidth = 1; ctx.beginPath();
            for (let i = 0; i < len; i += 3) { const x = getX(i); ctx.moveTo(x, padding.top); ctx.lineTo(x, H - padding.bottom); }
            ctx.stroke();
            // Fog shading
            const stepX = (W - padding.left - padding.right) / (len - 1);
            for (let i = 0; i < len - 1; i++) {
                const spread = h.temperature_2m[i] - h.dewpoint_2m[i];
                const x = getX(i);
                ctx.beginPath();
                ctx.moveTo(x, getY(h.temperature_2m[i])); ctx.lineTo(x + stepX, getY(h.temperature_2m[i+1]));
                ctx.lineTo(x + stepX, getY(h.dewpoint_2m[i+1])); ctx.lineTo(x, getY(h.dewpoint_2m[i]));
                ctx.closePath(); ctx.fillStyle = spread < 2.0 ? 'rgba(255,69,58,0.25)' : 'rgba(255,204,0,0.05)'; ctx.fill();
            }
            // NOW line
            const nowUTCHour = now.getUTCHours() + (now.getUTCMinutes() / 60);
            let nowIndex = 0;
            if (h.time) {
                let smallest = 999;
                h.time.slice(0, len).forEach((t, i) => {
                    const d = new Date(t + 'Z');
                    const diff = Math.abs(d.getUTCHours() + (d.getUTCMinutes() / 60) - nowUTCHour);
                    if (diff < smallest) { smallest = diff; nowIndex = i; }
                });
            }
            const nowX = getX(nowIndex);
            ctx.save();
            const gradient = ctx.createLinearGradient(nowX - 12, 0, nowX + 12, 0);
            gradient.addColorStop(0, 'rgba(10,132,255,0)'); gradient.addColorStop(0.5, 'rgba(10,132,255,0.20)'); gradient.addColorStop(1, 'rgba(10,132,255,0)');
            ctx.fillStyle = gradient; ctx.fillRect(nowX - 12, padding.top, 24, H - padding.top - padding.bottom);
            ctx.strokeStyle = 'rgba(10,132,255,0.7)'; ctx.lineWidth = 1; ctx.setLineDash([3, 3]);
            ctx.beginPath(); ctx.moveTo(nowX, padding.top); ctx.lineTo(nowX, H - padding.bottom); ctx.stroke(); ctx.setLineDash([]);
            ctx.fillStyle = 'rgba(10,132,255,0.2)'; ctx.fillRect(nowX - 14, padding.top - 18, 28, 14);
            ctx.fillStyle = '#0a84ff'; ctx.font = '700 9px "SF Mono",monospace'; ctx.textAlign = 'center'; ctx.fillText('NOW', nowX, padding.top - 7);
            ctx.restore();
            if (window._meteoNowInterval) clearInterval(window._meteoNowInterval);
            window._meteoNowInterval = setInterval(() => {
                if (meteoDataCache) drawMeteogram(meteoDataCache);
            }, 60000);
            // Lines
            const drawLine = (arr, color, width) => {
                ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.lineJoin = 'round';
                for (let i = 0; i < len; i++) { const x = getX(i), y = getY(arr[i]); if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
                ctx.stroke();
            };
            drawLine(h.dewpoint_2m, '#0a84ff', 2); drawLine(h.temperature_2m, '#ff453a', 2);
            // Data Points
            ctx.textAlign = 'center';
            for (let i = 0; i < len; i += 3) {
                const x = getX(i);
                ctx.font = '14px sans-serif'; ctx.fillStyle = '#fff';
                ctx.fillText(getWxIcon(h.weather_code ? h.weather_code[i] : 3), x, padding.top - 15);
                const windDir = h.wind_direction_10m[i];
                const windSpd = Math.round(h.wind_speed_10m[i]);
                const windGust = Math.round(h.wind_gusts_10m[i]);
                ctx.save(); ctx.translate(x, H - 25); ctx.rotate((windDir + 180) * Math.PI / 180);
                ctx.beginPath(); ctx.moveTo(0, -8); ctx.lineTo(-5, 5); ctx.lineTo(0, 2); ctx.lineTo(5, 5); ctx.closePath();
                ctx.fillStyle = '#0a84ff'; ctx.fill(); ctx.restore();
                ctx.font = '700 11px "SF Mono",monospace';
                let spdText = `${windSpd}`;
                if (windGust > windSpd + 5) { spdText += `G${windGust}`; ctx.fillStyle = '#ff9f0a'; } else { ctx.fillStyle = '#fff'; }
                ctx.fillText(spdText, x, H - 10);
                ctx.fillStyle = '#666'; ctx.font = '10px sans-serif'; ctx.fillText(`${i}z`, x, H);
            }
        }

        // ================================================================
        // 16a. METAR TREND ANALYSIS
        // ================================================================
        function drawMeteogram2(h) {
                    // Draw meteogram on the weather-tab duplicate canvas
                    const cvs = document.getElementById('meteoCanvas2');
                    if (!cvs) return;
                    const ctx = cvs.getContext('2d');
                    const dpr  = window.devicePixelRatio || 1;
                    const rect = cvs.getBoundingClientRect();
                    if (!rect.width) return; // canvas not visible yet, skip
                    cvs.width  = rect.width * dpr; cvs.height = rect.height * dpr;
                    ctx.scale(dpr, dpr);
                    // Re-use the same drawing logic by temporarily swapping the canvas id
                    const orig = document.getElementById('meteoCanvas');
                    const origW = orig.width, origH = orig.height;
                    // Draw fresh on canvas2 by duplicating the draw call
                    // Simply call drawMeteogram but it targets meteoCanvas, so
                    // we copy the imagedata after
                    drawMeteogram(h);
                    const imgData = orig.getContext('2d').getImageData(0, 0, orig.width, orig.height);
                    cvs.width = orig.width; cvs.height = orig.height;
                    cvs.getContext('2d').putImageData(imgData, 0, 0);
                }
    
        function storeMetarForTrend(icao, metar) {
            try {
                const key = `metar_history_${icao}`;
                let history = JSON.parse(localStorage.getItem(key)) || [];
                
                // Store timestamp + key values
                const record = {
                    ts: Date.now(),
                    ceil: metar.ceiling?.value || 99999,
                    vis: metar.visibility?.value || 10,
                    windSpd: metar.wind_speed?.value || 0
                };
                
                history.unshift(record);
                
                // Keep last 24 hours only
                const dayAgo = Date.now() - 86400000;
                history = history.filter(h => h.ts > dayAgo).slice(0, 50);
                
                localStorage.setItem(key, JSON.stringify(history));
            } catch(e) {
                console.error('[Trend] Storage error:', e);
            }
        }

        function analyzeTrend(icao, param, currentValue) {
            try {
                const key = `metar_history_${icao}`;
                const history = JSON.parse(localStorage.getItem(key)) || [];
                
                if (history.length < 2) return null; // Not enough data
                
                // Find readings from ~1h and ~3h ago
                const now = Date.now();
                const oneHourAgo = history.find(h => now - h.ts >= 3300000 && now - h.ts <= 4200000); // 55-70min
                const threeHoursAgo = history.find(h => now - h.ts >= 10200000 && now - h.ts <= 11400000); // 170-190min
                
                const compareValue = oneHourAgo?.[param] || threeHoursAgo?.[param];
                if (!compareValue) return null;
                
                // Determine trend based on parameter type
                let improving = false;
                let threshold = 0;
                
                if (param === 'ceil') {
                    // Higher ceiling = better
                    threshold = 500; // 500ft change
                    improving = currentValue > compareValue + threshold;
                    const worsening = currentValue < compareValue - threshold;
                    if (improving) return 'improving';
                    if (worsening) return 'worsening';
                } else if (param === 'vis') {
                    // Higher visibility = better
                    threshold = 1; // 1 statute mile
                    improving = currentValue > compareValue + threshold;
                    const worsening = currentValue < compareValue - threshold;
                    if (improving) return 'improving';
                    if (worsening) return 'worsening';
                } else if (param === 'windSpd') {
                    // Lower wind = better
                    threshold = 5; // 5 knots
                    improving = currentValue < compareValue - threshold;
                    const worsening = currentValue > compareValue + threshold;
                    if (improving) return 'improving';
                    if (worsening) return 'worsening';
                }
                
                return 'steady';
                
            } catch(e) {
                console.error('[Trend] Analysis error:', e);
                return null;
            }
        }

        function getTrendBadge(trend) {
            if (!trend) return '';
            
            const icons = {
                improving: '↗',
                worsening: '↘',
                steady: '→'
            };
            
            const labels = {
                improving: 'Better',
                worsening: 'Worse',
                steady: 'Steady'
            };
            
            return `<span class="trend-badge trend-${trend}">${icons[trend]} ${labels[trend]}</span>`;
        }
    
        // ================================================================
        // 16b. METAR RENDERING
        // ================================================================
         function renderMetar(d) {
            const rawContainer = document.getElementById('rawMetar');
            const now = new Date(), metarTime = new Date(d.time.dt);
            const minAgo = Math.floor((now - metarTime) / 60000);
            rawContainer.innerHTML = formatRawMetar(d.raw);
            if (minAgo > 60) rawContainer.insertAdjacentHTML('beforeend', `<div style="margin-top:12px;padding:10px;background:rgba(255,69,58,0.1);border:1px solid var(--danger);border-radius:6px;text-align:center;"><div style="color:var(--danger);font-weight:800;font-size:12px;">⚠️ DATA OUTDATED (${minAgo}m old)</div></div>`);
            const rules = d.flight_rules;
            let css = 'cat-vfr';
            if (rules === 'MVFR') css = 'cat-mvfr'; if (rules === 'IFR') css = 'cat-ifr'; if (rules === 'LIFR') css = 'cat-lifr';
            updateHeaderCat(rules, css);
            
            // ── GET CURRENT ICAO FOR TREND ANALYSIS ──
            const icao = document.getElementById('icao').value.toUpperCase();
            
            // ── WIND with trend ──
            const windText = `${currentWind.dir.toString().padStart(3,'0')}° / ${currentWind.spd}kt`;
            const windTrend = analyzeTrend(icao, 'windSpd', currentWind.spd);
            document.getElementById('mWind').innerHTML = windText + getTrendBadge(windTrend);
            
            // ── VISIBILITY with trend ──
            const visText = d.visibility ? `${d.visibility.value} sm` : '--';
            const visTrend = analyzeTrend(icao, 'vis', d.visibility?.value || 10);
            document.getElementById('mVis').innerHTML = visText + getTrendBadge(visTrend);
            
            // ── CEILING with trend ──
            const c = d.clouds?.[0];
            const ceilText = c ? `${c.type} ${c.altitude.toString().padStart(3,'0')}` : "CLR";
            const ceilValue = c ? c.altitude * 100 : 99999; // Convert to feet AGL
            const ceilTrend = analyzeTrend(icao, 'ceil', ceilValue);
            document.getElementById('mCeil').innerHTML = ceilText + getTrendBadge(ceilTrend);
            
            // ── REST OF FUNCTION (unchanged) ──
            const alt = d.altimeter?.value;
            if (alt) {
                if (currentMetar.altUnit === 'hPa') { const inHg = (alt * 0.02953).toFixed(2); document.getElementById('mAlt').innerText = `Q${alt} / A${inHg}`; }
                else { const hPa = Math.round(alt * 33.8639); document.getElementById('mAlt').innerText = `Q${hPa} / A${alt.toFixed(2)}`; }
            }
            const t = d.temperature?.value, dew = d.dewpoint?.value;
            if (t != null) {
                document.getElementById('mTempC').innerText = `${t}°C / ${dew != null ? dew : '--'}°C`;
                document.getElementById('mTempF').innerText = `(${Math.round(t * 1.8 + 32)}°F)`;
                document.getElementById('mSpread').innerText = `Spread: ${(t - dew).toFixed(1)}°C`;
                
                // Calculate Relative Humidity using Magnus formula
                if (dew != null) {
                    const rh = Math.round(100 * Math.exp((17.625 * dew) / (243.04 + dew)) / Math.exp((17.625 * t) / (243.04 + t)));
                    document.getElementById('mHumidity').innerText = `RH: ${rh}%`;
                    
                    // Color code based on humidity level
                    const humidityEl = document.getElementById('mHumidity');
                    if (rh < 30) {
                        humidityEl.style.color = 'var(--warn)'; // Dry
                    } else if (rh > 80) {
                        humidityEl.style.color = 'var(--accent)'; // Very humid
                    } else {
                        humidityEl.style.color = 'var(--sub-text)'; // Normal
                    }
                } else {
                    document.getElementById('mHumidity').innerText = 'RH: --%';
                }
            }
            const ageEl = document.getElementById('mAge');
            ageEl.innerText = `${minAgo}m ago`;
            ageEl.style.color      = minAgo > 60 ? 'var(--danger)' : 'var(--sub-text)';
            ageEl.style.fontWeight = minAgo > 60 ? '700' : '400';
            mirrorToWeatherTab();

        }

        function renderSkyVisuals(m) {
            const container = document.getElementById('skyLayersContainer');
            container.innerHTML = '';
            if (!m.clouds || m.clouds.length === 0) { container.innerHTML = '<div class="sky-no-data">Sky Clear (SKC/CLR)</div>'; return; }
            const sorted = [...m.clouds].sort((a, b) => b.altitude - a.altitude);
            sorted.forEach(c => {
                const count = { FEW: 2, SCT: 4, BKN: 7, OVC: 8, VV: 8 }[c.type] || 0;
                let iconsHtml = '';
                for (let i = 0; i < count; i++) iconsHtml += `<svg class="sky-icon" viewBox="0 0 30 20"><path d="${CLOUD_ICON_PATH}"/></svg>`;
                const typeName = { FEW: 'Few', SCT: 'Scattered', BKN: 'Broken', OVC: 'Overcast', VV: 'Vert. Vis' }[c.type] || c.type;
                const layer = document.createElement('div'); layer.className = 'sky-layer';
                layer.innerHTML = `<div class="sky-icons-row">${iconsHtml}</div><div class="sky-layer-text">${typeName} ${c.altitude * 100}'</div>`;
                container.appendChild(layer);
            });
        }

        function renderFlightRuleBar(m) {
            let ceiling = 99999;
            const ceilLayer = m.clouds?.find(c => ['BKN','OVC','VV'].includes(c.type));
            if (ceilLayer) ceiling = ceilLayer.altitude * 100;
            let vis = m.visibility ? m.visibility.value : 10;

            const getStats = (val, type) => {
                let pct = 0, color = 'var(--success)';
                if (type === 'ceil') {
                    if (val < 500)  { pct = (val / 500) * 25; color = 'var(--lifr)'; }
                    else if (val < 1000) { pct = 25 + ((val - 500) / 500) * 25; color = 'var(--danger)'; }
                    else if (val < 3000) { pct = 50 + ((val - 1000) / 2000) * 25; color = 'var(--mvfr)'; }
                    else { pct = 75 + Math.min(1, (val - 3000) / 3000) * 25; }
                }
                if (type === 'vis') {
                    if (val < 1) { pct = (val / 1) * 25; color = 'var(--lifr)'; }
                    else if (val < 3) { pct = 25 + ((val - 1) / 2) * 25; color = 'var(--danger)'; }
                    else if (val < 5) { pct = 50 + ((val - 3) / 2) * 25; color = 'var(--mvfr)'; }
                    else { pct = 100; }
                }
                return { width: Math.max(5, pct) + '%', color };
            };

            const cStats = getStats(ceiling, 'ceil');
            const vStats = getStats(vis, 'vis');
            const ceilBar = document.getElementById('gaugeCeil'); ceilBar.style.width = cStats.width; ceilBar.style.backgroundColor = cStats.color;
            document.getElementById('labelCeilVal').innerText = ceiling === 99999 ? 'Unlimited' : `${ceiling} ft`;
            document.getElementById('labelCeilVal').style.color = cStats.color;
            const visBar  = document.getElementById('gaugeVis'); visBar.style.width  = vStats.width; visBar.style.backgroundColor = vStats.color;
            document.getElementById('labelVisVal').innerText = `${vis} sm`;
            document.getElementById('labelVisVal').style.color = vStats.color;
            const rule  = m.flight_rules;
            const msgEl = document.getElementById('frMessage');
            const msgs  = { VFR: ["Visual Flight Rules (Vis > 5sm & Ceil > 3000')", 'var(--success)'], MVFR: ["Marginal VFR (Ceil 1000-3000' or Vis 3-5sm)", 'var(--mvfr)'], IFR: ["Instrument Flight Rules (Ceil < 1000' or Vis < 3sm)", 'var(--danger)'], LIFR: ["Low IFR (Ceil < 500' or Vis < 1sm)", 'var(--lifr)'] };
            if (msgs[rule]) { msgEl.innerText = msgs[rule][0]; msgEl.style.color = msgs[rule][1]; }
        }

        // Calculate bearing from point A to point B
        function getBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            
            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) -
                      Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            
            let θ = Math.atan2(y, x);
            let bearing = (θ * 180 / Math.PI + 360) % 360;
            return Math.round(bearing);
        }
        
        // Convert bearing to cardinal direction
        function bearingToCardinal(bearing) {
            const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                          'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(bearing / 22.5) % 16;
            return dirs[index];
        }
    
        // Safe distance extractor — handles both AVWX and cached shapes
        function getNm(item) {
            if (item.nautical_miles != null) return item.nautical_miles;      // cached old shape
            if (item.distance?.value != null) return item.distance.value;     // AVWX live shape
            return 0;
        }


        let _nearbyModalData = null;

async function findNearbyStations(lat, lon) {
            console.log(`[Nearby] 🔍 Called with lat=${lat}, lon=${lon}`);
            
            const list = document.getElementById('nearList');
            if (!list) {
                console.error('[Nearby] ❌ Element #nearList not found!');
                return;
            }
            
            list.innerHTML = '<span style="color:#555;font-size:12px;">Scanning…</span>';
            
            try {
                const url = `/api/weather?type=near&station=${lat},${lon}&distance=150`;
                console.log(`[Nearby] 📡 Fetching: ${url}`);
                
                const data = await secureFetch(url);
                console.log('[Nearby] 📦 Raw API response:', data);
                
                // CRITICAL FIX: AVWX returns {0:{...}, 1:{...}, _meta:{...}}
                // Convert to array and filter out _meta
                let items;
                if (Array.isArray(data)) {
                    items = data;
                } else if (typeof data === 'object' && data !== null) {
                    // Object with numeric keys + _meta → convert to array
                    items = Object.values(data).filter(item => 
                        item && typeof item === 'object' && !item.hasOwnProperty('key_used')
                    );
                } else {
                    items = [];
                }
                
                console.log(`[Nearby] 📊 Extracted ${items.length} items`);
                if (items.length > 0) {
                    console.log('[Nearby] 🔬 First item:', items[0]);
                }
                
                const currentIcao = document.getElementById('icao').value.toUpperCase();
                console.log(`[Nearby] 🛫 Current airport: ${currentIcao}`);
                
                // Filter out current airport, sort by distance, take top 5
                const others = items
                    .filter(item => {
                        const icao = item.station?.icao || item.icao || '';
                        const keep = icao !== currentIcao;
                        if (!keep) console.log(`[Nearby] ⏭️  Skipping current airport: ${icao}`);
                        return keep;
                    })
                    .sort((a, b) => getNm(a) - getNm(b))
                    .slice(0, 5);
                
                console.log(`[Nearby] ✂️  After filter: ${others.length} stations`);
                others.forEach((item, i) => {
                    const icao = item.station?.icao || item.icao || '????';
                    const nm = getNm(item);
                    console.log(`[Nearby]   ${i+1}. ${icao} - ${nm}nm`);
                });
                
                list.innerHTML = '';
                
                if (others.length === 0) {
                    console.log('[Nearby] ⚠️  No nearby stations found');
                    list.innerHTML = '<span style="color:#555;font-size:12px;">No stations found within 150nm.</span>';
                    return;
                }
                
                others.forEach(item => {
                    const icao = item.station?.icao || item.icao || '????';
                    const nm   = Math.round(getNm(item));
                    
                    // Calculate bearing from current station to this one
                    const stn = item.station || item;
                    let bearingStr = '';
                    if (lat != null && lon != null && stn.latitude != null && stn.longitude != null) {
                        const bearing = getBearing(lat, lon, stn.latitude, stn.longitude);
                        const cardinal = bearingToCardinal(bearing);
                        bearingStr = ` · ${bearing}° (${cardinal})`;
                    }
                    
                    const btn = document.createElement('div');
                    btn.className = 'nearby-btn';
                    btn.innerHTML = `
                        <span>✈</span>
                        <span>${icao}</span>
                        <span style="color:var(--sub-text);font-size:10px;">${nm}nm${bearingStr}</span>`;
                    
                    btn.onclick = () => openNearbyModal(item);
                    list.appendChild(btn);
                });
                
                console.log('[Nearby] ✅ Rendered successfully - check UI!');
                
            } catch(e) {
                console.error('[Nearby] ❌ Error:', e);
                console.error('[Nearby] ❌ Stack:', e.stack);
                list.innerHTML = '<span style="color:#555;font-size:12px;">Failed to load nearby stations.</span>';
            }
        }

        async function openNearbyModal(item) {
            const stn  = item.station || item;
            const icao = stn.icao || '????';
            const nm   = Math.round(getNm(item));
            _nearbyModalData = { station: stn, nm };

            // Populate static fields immediately
            document.getElementById('nearModalIcao').innerText  = icao;
            document.getElementById('nearModalName').innerText  = stn.name || stn.city || '--';
            document.getElementById('nearModalDist').innerText  = `${nm} nm`;
            document.getElementById('nearModalElev').innerText  = stn.elevation_ft ? `${stn.elevation_ft} ft` : '--';
            document.getElementById('nearModalCoords').innerText =
                (stn.latitude != null && stn.longitude != null)
                    ? `${stn.latitude.toFixed(2)}, ${stn.longitude.toFixed(2)}`
                    : '--';

            const catEl = document.getElementById('nearModalCat');
            catEl.innerText = '--'; catEl.className = 'badge badge-cat';
            document.getElementById('nearModalWeather').innerHTML =
                '<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:8px 0;">' +
                '<span style="color:var(--accent);">⏳</span><span>Fetching current weather...</span></div>';

            document.getElementById('nearbyModal').classList.add('active');

            // Fetch METAR for preview
            try {
                const m = await secureFetch(`/api/weather?type=metar&station=${icao}`);
                if (m && !m.error) {
                    const rules  = m.flight_rules || '--';
                    const cssMap = { VFR:'cat-vfr', MVFR:'cat-mvfr', IFR:'cat-ifr', LIFR:'cat-lifr' };
                    catEl.innerText = rules;
                    catEl.className = 'badge badge-cat ' + (cssMap[rules] || '');

                    const wind = m.wind_direction?.repr === 'VRB'
                        ? `VRB / ${m.wind_speed?.value || 0}kt`
                        : `${String(m.wind_direction?.value ?? 0).padStart(3,'0')}° / ${m.wind_speed?.value || 0}kt`;
                    const vis   = m.visibility ? `${m.visibility.value} sm` : '--';
                    const ceil  = m.clouds?.[0] ? `${m.clouds[0].type} ${m.clouds[0].altitude * 100}'` : 'CLR';
                    const temp  = m.temperature?.value != null ? `${m.temperature.value}°C` : '--';
                    const alt   = m.altimeter?.value
                        ? (m.altimeter.value < 200 ? `A${m.altimeter.value.toFixed(2)}` : `Q${m.altimeter.value}`)
                        : '--';
                    const mins  = Math.floor((Date.now() - new Date(m.time?.dt)) / 60000);
                    const ageColor = mins > 60 ? 'var(--danger)' : 'var(--sub-text)';

                    document.getElementById('nearModalWeather').innerHTML = `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                            <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:8px;">
                                <div style="font-size:10px;color:var(--sub-text);margin-bottom:2px;text-transform:uppercase;">Wind</div>
                                <div style="font-size:14px;font-weight:700;color:var(--text);">${wind}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:8px;">
                                <div style="font-size:10px;color:var(--sub-text);margin-bottom:2px;text-transform:uppercase;">Visibility</div>
                                <div style="font-size:14px;font-weight:700;color:var(--text);">${vis}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:8px;">
                                <div style="font-size:10px;color:var(--sub-text);margin-bottom:2px;text-transform:uppercase;">Ceiling</div>
                                <div style="font-size:14px;font-weight:700;color:var(--text);">${ceil}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:8px;">
                                <div style="font-size:10px;color:var(--sub-text);margin-bottom:2px;text-transform:uppercase;">Temp · Alt</div>
                                <div style="font-size:13px;font-weight:700;color:var(--text);">${temp} · ${alt}</div>
                            </div>
                        </div>
                        <div style="font-size:10px;color:${ageColor};text-align:right;padding-top:4px;border-top:1px solid var(--border);">
                            ${mins > 60 ? '⚠️ ' : ''}Updated ${mins}m ago
                        </div>`;
                } else {
                    document.getElementById('nearModalWeather').innerHTML =
                        '<div style="color:var(--sub-text);text-align:center;padding:8px;">No weather data for this station.</div>';
                }
            } catch(e) {
                document.getElementById('nearModalWeather').innerHTML =
                    '<div style="color:var(--sub-text);text-align:center;padding:8px;">Could not load weather. Check connection.</div>';
            }
        }

        function closeNearbyModal() {
            document.getElementById('nearbyModal').classList.remove('active');
            _nearbyModalData = null;
        }

        function loadNearbyFromModal() {
            if (!_nearbyModalData) return;
            const icao = _nearbyModalData.station.icao;
            closeNearbyModal();
            document.getElementById('icao').value = icao;
            loadData();
        }

        // ================================================================
        // SUPPLEMENTARY AIRPORT DATA (aviationweather.gov)
        // ================================================================
        async function fetchAirportSupplementary(icao) {
            const cacheKey = `cache_aw_airport_${icao}`;
            const cached   = localStorage.getItem(cacheKey);
            if (cached) {
                const c = JSON.parse(cached);
                if (Date.now() - c.ts < 3600000) return c.data; // 1h cache
            }
            try {
                const res  = await fetch(`https://aviationweather.gov/api/data/airport?ids=${icao}&format=json`);
                if (!res.ok) return null;
                const arr  = await res.json();
                const data = Array.isArray(arr) ? arr[0] : null;
                if (!data) return null;
        
                // Parse comm frequencies out of the freqs string if present
                // awc returns a simple object; extract what's useful
                const result = {
                    comms: [],
                    runwayStr: data.runways || ''
                };
        
                // Some stations have a freqs field as a pipe-separated string
                if (data.freqs) {
                    const parts = data.freqs.split('|').filter(Boolean);
                    parts.forEach(p => {
                        const m = p.match(/([A-Z\/\s]+)\s+([\d.]+)/);
                        if (m) result.comms.push({ type: m[1].trim(), frequency: m[2] });
                    });
                }
        
                localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data: result }));
                return result;
            } catch(e) {
                console.warn('[AirportSupp] Failed:', e);
                return null;
            }
        }
    
        function renderInfo(d) {
            document.getElementById('infoName').innerText   = d.name;
            document.getElementById('infoLoc').innerText    = `${d.city || ''}, ${d.country || ''} (${d.icao})`;
            document.getElementById('infoCodes').innerText  = `${d.icao} / ${d.iata || '--'}`;
            document.getElementById('infoElev').innerText   = `${d.elevation_ft} ft`;
            document.getElementById('infoCoords').innerText = `${d.latitude.toFixed(4)}, ${d.longitude.toFixed(4)}`;
            const elev = d.elevation_ft, temp = currentMetar.temp;
            let qnhHpa = currentMetar.alt;
            if (currentMetar.altUnit === 'inHg') qnhHpa = currentMetar.alt * 33.8639;
            const pa      = Math.round(elev + (1013.25 - qnhHpa) * 30);
            const isaTemp = 15 - (2 * pa / 1000);
            const isaDev  = Math.round(temp - isaTemp);
            const da      = Math.round(pa + 120 * (temp - isaTemp));
            document.getElementById('calcPA').innerText  = `${pa} ft`;
            document.getElementById('calcDA').innerText  = `${da} ft`;
            document.getElementById('calcISA').innerText = `${isaDev >= 0 ? '+' : ''}${isaDev}°C`;
            checkDAWarning(da, elev);
            const fContainer = document.getElementById('freqContainer');
                        fContainer.innerHTML = '<div style="color:#555;font-size:12px;padding:4px;">Loading frequencies...</div>';
            
                        // Phone numbers
                        const phoneContainer = document.getElementById('atisPhones');
                        if (phoneContainer) {
                            phoneContainer.innerHTML = '<div style="color:#555;font-size:12px;padding:8px;">Loading...</div>';
                        }
            
                        // Fetch supplementary data from aviationweather.gov
                        fetchAirportSupplementary(d.icao).then(awData => {
                            // ── FREQUENCIES ──
                            fContainer.innerHTML = '';
                            const avwxFreqs = (d.frequencies || []).slice(0, 8);
                            const awFreqs   = awData?.comms || [];
            
                            const allFreqs = avwxFreqs.length > 0 ? avwxFreqs.map(f => ({
                                type: f.type, frequency: f.frequency
                            })) : awFreqs;
            
                            if (allFreqs.length > 0) {
                                allFreqs.slice(0, 9).forEach(f => {
                                    const card = document.createElement('div'); card.className = 'freq-card';
                                    card.innerHTML = `<div class="freq-type">${f.type || f.frequencyType || '--'}</div><div class="freq-val">${f.frequency || f.freq || '--'}</div>`;
                                    fContainer.appendChild(card);
                                });
                            } else {
                                fContainer.innerHTML = `
                                    <div style="grid-column:span 3;color:#555;font-size:12px;padding:8px;text-align:center;">
                                        No frequency data available.
                                        <a href="https://skyvector.com/airport/${d.icao}" target="_blank" 
                                           style="color:var(--accent);margin-left:6px;text-decoration:none;">
                                            View on SkyVector ↗
                                        </a>
                                    </div>`;
                            }
            
                            // ── ATIS/AWOS PHONES ──
                            if (phoneContainer) {
                                // Hardcoded Taiwan ATIS phone numbers (most reliable)
                                const twAtisPhones = {};
            
                                let phones = twAtisPhones[d.icao] || [];
            
                                // Also check AVWX communications field
                                if (phones.length === 0 && d.communications && Array.isArray(d.communications)) {
                                    phones = d.communications
                                        .filter(c => ['ATIS','AWOS','ASOS'].includes((c.type||'').toUpperCase()) && c.phone)
                                        .map(c => ({ type: c.type.toUpperCase(), phone: c.phone, freq: c.frequency ? `${c.frequency} MHz` : '' }));
                                }
            
                                if (phones.length > 0) {
                                    phoneContainer.innerHTML = phones.map(p => `
                                        <div class="phone-card">
                                            <div class="phone-label">${p.type}${p.freq ? ' · ' + p.freq : ''}</div>
                                            <a href="tel:${p.phone.replace(/[^\d+]/g,'')}" class="phone-number">
                                                📞 ${p.phone}
                                            </a>
                                        </div>`).join('');
                                } else {
                                    phoneContainer.innerHTML = `
                                        <div style="color:#555;font-size:12px;padding:8px;line-height:1.6;">
                                            No phone data available for ${d.icao}.<br>
                                            <a href="https://www.airnav.com/airport/${d.icao}" target="_blank" 
                                               style="color:var(--accent);text-decoration:none;">
                                                Check AirNav ↗
                                            </a>
                                        </div>`;
                                }
                            }
                        });
            
            updateSunDisplay();
            const sunEl = document.getElementById('infoSun');
            sunEl.style.cursor = "pointer"; sunEl.style.textDecoration = "underline"; sunEl.style.textDecorationColor = "#555";
            sunEl.title = "Tap to switch UTC / Local"; sunEl.onclick = toggleSunFormat;
            let helper = document.getElementById('sunHelper');
            if (!helper) {
                helper = document.createElement('div'); helper.id = 'sunHelper';
                helper.style.cssText = 'font-size:10px;color:var(--sub-text);margin-top:4px;font-style:italic;';
                sunEl.parentElement.appendChild(helper);
            }
            helper.innerText = "(Tap time to toggle UTC / Local)";
            const sData   = getSunTimes(d.latitude, d.longitude);
            const today   = new Date();
            const riseDate = new Date(today); riseDate.setUTCHours(sData.rawRise);
            const setDate  = new Date(today); setDate.setUTCHours(sData.rawSet);
            stationSunTimes = { sunrise: riseDate, sunset: setDate };
            if (tafDataCache && tafDataCache.length > 0) {
                updateTafSkyGradient(new Date(tafDataCache[0].start_time.dt), new Date(tafDataCache[tafDataCache.length-1].end_time.dt));
            }
        }

        function checkDAWarning(da, elev) {
            const daEl = document.getElementById('calcDA');
            if (da > elev + 2000) { daEl.style.color = "var(--warn)"; daEl.innerHTML = `${da} ft ⚠️`; }
            else { daEl.style.color = "var(--text)"; }
        }
    </script>

<script>
        // ================================================================
        // 17. RUNWAY SETUP & WIND ROSE
        // ================================================================
        function setupRunwaySelect() {
            const sel = document.getElementById('rwySelect');
            sel.innerHTML = '';
            const mv = stationData.magnetic_variation || 0;
            const windMag = currentWind.dir - mv;
            let bestRwy = null, maxHW = -999;
            (stationData.runways || []).forEach(r => {
                sel.add(new Option(`RWY ${r.ident1}`, r.ident1));
                sel.add(new Option(`RWY ${r.ident2}`, r.ident2));
                const h1  = parseInt(r.ident1.replace(/\D/g, '')) * 10;
                const hw1 = Math.cos((windMag - h1) * (Math.PI / 180)) * currentWind.spd;
                if (hw1 > maxHW) { maxHW = hw1; bestRwy = r.ident1; }
            });
            if (bestRwy) sel.value = bestRwy;
            else if (stationData.runways.length > 0) sel.value = stationData.runways[0].ident1;
            drawWindRose();
            renderRunwaysComplex();
        }

        function drawWindRose() {
            const weatherTabActive = document.getElementById('tab-weather')?.classList.contains('active');
            const canvasId = weatherTabActive ? 'windRose2' : 'windRose';
            const canvas   = document.getElementById(canvasId);
            const ctx      = canvas.getContext('2d');
            const w = 140, h = 140, cx = 70, cy = 70, r = 54;
            const rwyIdent = document.getElementById('rwySelect').value;

            // Color palette
            const cyanBlue  = '#00d2ff';
            const northRed  = '#ff3333';
            const rwyBg     = '#000000';
            const rwyDash   = '#ffffff';
            const textCalm  = '#32d74b';
            const textVrb   = '#ff9f0a';

            ctx.clearRect(0, 0, w, h);

            // Compass ring
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2 * Math.PI);
            ctx.strokeStyle = cyanBlue; ctx.lineWidth = 2; ctx.stroke();

            // Compass labels
            ctx.font = '800 12px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = northRed; ctx.fillText('N', cx, cy - r + 14);
            ctx.fillStyle = cyanBlue;
            ctx.fillText('E', cx + r - 14, cy);
            ctx.fillText('S', cx, cy + r - 14);
            ctx.fillText('W', cx - r + 14, cy);

            const mv      = stationData?.magnetic_variation || 0;
            const safeDir = (currentWind.dir === 'VRB') ? 0 : currentWind.dir;
            const windMag = safeDir - mv;

            // Runway strip
            if (rwyIdent) {
                const rwyHdg = parseInt(rwyIdent.replace(/\D/g, '')) * 10;
                const rwyRad = (rwyHdg - 90) * (Math.PI / 180);
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(rwyRad);
                const rwyLen = r * 1.7, rwyW = 22;
                ctx.fillStyle = rwyBg; ctx.strokeStyle = 'rgba(0,210,255,0.3)'; ctx.lineWidth = 1;
                ctx.fillRect(-rwyLen / 2, -rwyW / 2, rwyLen, rwyW);
                ctx.strokeRect(-rwyLen / 2, -rwyW / 2, rwyLen, rwyW);
                // Centerline dashes
                ctx.fillStyle = rwyDash;
                const dashCount = 5, dashW = 12, dashH = 2;
                const totalDashSpan = rwyLen * 0.85;
                const gap = (totalDashSpan - (dashCount * dashW)) / (dashCount - 1);
                let currentX = -totalDashSpan / 2;
                for (let i = 0; i < dashCount; i++) { ctx.fillRect(currentX, -dashH / 2, dashW, dashH); currentX += dashW + gap; }
                ctx.restore();

                // Wind components
                const diff  = (windMag - rwyHdg) * (Math.PI / 180);
                const hw    = Math.round(Math.cos(diff) * currentWind.spd);
                const xw    = Math.round(Math.sin(diff) * currentWind.spd);
                const vHW   = document.getElementById('valHW');
                const vXW   = document.getElementById('valXW');
                if (currentWind.spd === 0) {
                    vHW.innerText = "Calm"; vHW.style.color = textCalm; vXW.innerText = "Calm";
                } else if (currentWind.dir === 'VRB') {
                    vHW.innerText = "VRB"; vHW.style.color = textVrb; vXW.innerText = "VRB";
                } else {
                    vHW.innerText = hw >= 0 ? `${hw}kt Head` : `${Math.abs(hw)}kt Tail`;
                    vHW.style.color = hw < 0 ? 'var(--danger)' : 'var(--success)';
                    vXW.innerText = `${Math.abs(xw)}kt ${xw >= 0 ? 'R' : 'L'}`;
                }
                checkMins();
            }

            // Wind status / arrow
            ctx.font = '800 16px "SF Mono",monospace'; ctx.shadowColor = 'rgba(0,0,0,0.8)'; ctx.shadowBlur = 4;
            if (currentWind.spd === 0) {
                ctx.fillStyle = textCalm; ctx.fillText("CALM", cx, cy);
            } else if (currentWind.dir === 'VRB') {
                ctx.fillStyle = textVrb; ctx.fillText("VRB", cx, cy);
                ctx.beginPath(); ctx.arc(cx, cy, 25, 0, 2 * Math.PI);
                ctx.strokeStyle = textVrb; ctx.lineWidth = 1; ctx.setLineDash([4, 4]); ctx.stroke(); ctx.setLineDash([]);
            } else {
                const windRad = (windMag + 90) * (Math.PI / 180);
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(windRad);
                const halfLen = 30;
                // Source triangle on ring
                ctx.beginPath(); ctx.moveTo(-r - 4, 0); ctx.lineTo(-r - 14, -5); ctx.lineTo(-r - 14, 5); ctx.closePath();
                ctx.fillStyle = cyanBlue; ctx.fill();
                // Arrow shaft
                ctx.beginPath(); ctx.moveTo(-halfLen, 0); ctx.lineTo(halfLen, 0);
                ctx.strokeStyle = cyanBlue; ctx.lineWidth = 3; ctx.stroke();
                // Arrow head
                ctx.beginPath(); ctx.moveTo(halfLen, 0); ctx.lineTo(halfLen - 10, -6); ctx.lineTo(halfLen - 10, 6); ctx.closePath();
                ctx.fillStyle = cyanBlue; ctx.fill();
                ctx.restore();
            }
        }

        function drawWindRoseOnCanvas(canvasId) {
            const orig = document.getElementById('rwySelect');
            const copy = document.getElementById('rwySelect2');
            if (copy && orig) copy.value = orig.value;
            const saved = document.getElementById('toggleMultiDashboard');
            // Temporarily point drawWindRose to the right canvas
            const temp = { checked: canvasId === 'windRose2' };
            if (saved) { const prev = saved.checked; saved.checked = temp.checked; drawWindRose(); saved.checked = prev; }
        }
    
        function renderRunwaysComplex() {
            const container = document.getElementById('runwayListComplex');
            container.innerHTML = '';
            const d = stationData; if (!d || !d.runways) return;
            const magVar         = d.magnetic_variation || 0;
            const safeWindDir = (currentWind.dir === 'VRB') ? 0 : currentWind.dir;
            const windMagDir = safeWindDir - magVar;
            const userLimitXW    = parseFloat(localStorage.getItem('efb_min_xw')) || 999;

            d.runways.forEach((r) => {
                const dimStr   = useMetric ? `${Math.round(r.length_ft * 0.3048)}m` : `${r.length_ft}'`;
                const rwy1Hdg  = parseInt(r.ident1.replace(/\D/g, '')) * 10;
                const diffRad  = (windMagDir - rwy1Hdg) * (Math.PI / 180);
                const hw       = Math.round(Math.cos(diffRad) * currentWind.spd);
                const xw       = Math.round(Math.sin(diffRad) * currentWind.spd);
                const absXW    = Math.abs(xw);
                const isExceeded = absXW > userLimitXW;
                const rowOpacity = isExceeded ? '0.7' : '1';
                const warnBadge  = isExceeded ? `<span style="background:var(--danger);color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:8px;font-weight:800;">⚠️ LIMIT (${userLimitXW}kt)</span>` : '';
                const color1 = hw >= 0 ? 'var(--success)' : 'var(--danger)';
                const color2 = hw < 0  ? 'var(--success)' : 'var(--danger)';
                const div = document.createElement('div'); div.className = 'rwy-complex';
                if (isExceeded) div.style.border = '1px solid var(--danger)';
                div.innerHTML = `
                    <div class="rc-header" style="opacity:${rowOpacity}">
                        <div class="rc-idents"><span style="color:${color1}">${r.ident1}</span> / <span style="color:${color2}">${r.ident2}</span>${warnBadge}</div>
                        <div class="rc-dims">${dimStr}</div>
                    </div>
                    <div class="rc-strip" style="opacity:${rowOpacity}">
                        <div class="rc-id-v">${r.ident1}</div>
                        <div class="rc-data">
                            <div class="wind-comp" style="color:${color1}"><span style="font-weight:700;">${Math.abs(hw)}kt</span><span>${hw >= 0 ? '⬆' : '⬇'}</span></div>
                            <div class="wind-comp" style="margin-left:12px;color:#0a84ff;"><span style="font-weight:700;${isExceeded ? 'color:var(--danger);' : ''}">${absXW}kt</span><span>${xw >= 0 ? '➡' : '⬅'}</span></div>
                        </div>
                        <div class="rc-id-v" style="transform:rotate(0deg);">${r.ident2}</div>
                    </div>`;
                container.appendChild(div);
            });
        }

        // ================================================================
        // 18. TAF RENDERING
        // ================================================================
        function renderTaf(d) {
            // Raw TAF text
            document.getElementById('rawTaf').innerText = d.raw || "No TAF Data";
            
            // Issued + Expiry times
            const issuedEl = document.getElementById('tafIssued');
            if (d.time && d.forecast && d.forecast.length > 0) {
                const issued = new Date(d.time.dt);
                const expiry = new Date(d.forecast[d.forecast.length - 1].end_time.dt);
                const now = new Date();
                
                const issuedStr = `${issued.getUTCDate().toString().padStart(2,'0')}/${(issued.getUTCMonth()+1).toString().padStart(2,'0')} ${issued.getUTCHours().toString().padStart(2,'0')}:${issued.getUTCMinutes().toString().padStart(2,'0')}Z`;
                
                const remainMs = expiry - now;
                const remainHrs = Math.floor(remainMs / 3600000);
                const remainMins = Math.floor((remainMs % 3600000) / 60000);
                
                let timeLeftStr = '';
                if (remainMs > 0) {
                    if (remainHrs > 0) {
                        timeLeftStr = `${remainHrs}h ${remainMins}m left`;
                    } else if (remainMins > 0) {
                        timeLeftStr = `${remainMins}m left`;
                    } else {
                        timeLeftStr = 'Expiring soon';
                    }
                } else {
                    timeLeftStr = '⚠️ EXPIRED';
                }
                
                const expiryColor = remainMs < 1800000 ? 'var(--warn)' : 'var(--sub-text)';  // warn if <30min
                
                issuedEl.innerHTML = `
                    <span>Issued: ${issuedStr}</span>
                    <span style="color:${expiryColor};margin-left:12px;">⏱ ${timeLeftStr}</span>
                `;
            } else {
                issuedEl.innerText = '--';
            }
            tafDataCache = d.forecast;
            const bar  = document.getElementById('tafBar');
            const axis = document.getElementById('tafAxis');
            bar.innerHTML = ''; axis.innerHTML = '';
            document.getElementById('tafDetail').classList.add('hidden');
            if (!d.forecast || d.forecast.length === 0) return;
            const startT = new Date(d.forecast[0].start_time.dt);
            const endT   = new Date(d.forecast[d.forecast.length - 1].end_time.dt);
            const totalDur = endT - startT;
            const now    = new Date();

            if (now >= startT && now <= endT) {
                const p      = ((now - startT) / totalDur) * 100;
                const needle = document.getElementById('tafNeedle');
                needle.style.display = 'block';
                needle.style.left    = `${p}%`;
                needle.style.cursor  = 'pointer';
                needle.dataset.utc   = now.toISOString();
            }

            d.forecast.forEach((f, index) => {
                const block = document.createElement('div'); block.className = 'taf-block'; block.style.flex = "1";
                let col = '#555';
                if (f.flight_rules === 'VFR')  col = 'var(--success)';
                if (f.flight_rules === 'MVFR') col = 'var(--mvfr)';
                if (f.flight_rules === 'IFR')  col = 'var(--danger)';
                block.style.backgroundColor = col; block.innerText = f.type;
                block.onclick = () => showTafDetail(index, col);
                bar.appendChild(block);
                if (index % 2 === 0) {
                    const s   = new Date(f.start_time.dt);
                    const lbl = document.createElement('div'); lbl.className = 'taf-axis-lbl'; lbl.style.flex = "2";
                    lbl.innerText = `${s.getUTCHours()}z`; axis.appendChild(lbl);
                }
            });
            if (stationSunTimes) updateTafSkyGradient(startT, endT);
            mirrorToWeatherTab();

        }

        function toggleTafNeedleTooltip() {
            const tooltip   = document.getElementById('tafNeedleTooltip');
            if (!tooltip) return;
            const isVisible = tooltip.classList.contains('visible');
            if (isVisible) { tooltip.classList.remove('visible'); return; }
            const now    = new Date();
            const utcStr = now.toLocaleTimeString('en-GB', { timeZone: 'UTC', hour: '2-digit', minute: '2-digit', hour12: false });
            let localStr = '--:--', localLabel = 'Local';
            if (stationOffsetSec !== 0) {
                const localDate = new Date(now.getTime() + (stationOffsetSec * 1000));
                localStr  = localDate.toLocaleTimeString('en-GB', { timeZone: 'UTC', hour: '2-digit', minute: '2-digit', hour12: false });
                const offsetHrs = stationOffsetSec / 3600;
                localLabel = `UTC${offsetHrs >= 0 ? '+' : ''}${offsetHrs}`;
            }
            tooltip.innerHTML = `
                <div style="color:#ff453a;font-weight:800;margin-bottom:3px;font-size:10px;">NOW</div>
                <div style="color:#fff;">${utcStr} <span style="color:#8e8e93;">UTC</span></div>
                <div style="color:#0a84ff;">${localStr} <span style="color:#8e8e93;">${localLabel}</span></div>`;
            tooltip.classList.add('visible');
            setTimeout(() => tooltip.classList.remove('visible'), 3000);
        }

        function showTafDetail(index, color) {
            const f = tafDataCache[index], card = document.getElementById('tafDetail');
            card.style.borderLeftColor = color; card.classList.remove('hidden');
            const s = new Date(f.start_time.dt), e = new Date(f.end_time.dt);
            document.getElementById('tdTime').innerText  = `${s.getUTCHours()}z ➔ ${e.getUTCHours()}z`;
            document.getElementById('tdType').innerText  = f.type;
            document.getElementById('tdWind').innerText  = `${f.wind_direction?.value || 'VRB'}° / ${f.wind_speed?.value || 0}kt`;
            document.getElementById('tdVis').innerText   = f.visibility ? `${f.visibility.value} sm` : 'P6SM';
            document.getElementById('tdWx').innerText    = f.wx_codes ? f.wx_codes.map(x => x.repr).join(' ') : 'NSW';
            let cStr = 'SKC';
            if (f.clouds && f.clouds.length > 0) cStr = f.clouds.map(c => `${c.type}${c.altitude.toString().padStart(3, '0')}`).join(' ');
            document.getElementById('tdCloud').innerText = cStr;
        }

        function updateTafSkyGradient(startT, endT) {
            if (!stationSunTimes || !startT || !endT) return;
            const getH = (d) => d.getUTCHours() + (d.getUTCMinutes() / 60);
            const sr = getH(stationSunTimes.sunrise), ss = getH(stationSunTimes.sunset);
            const cNight = "#0f172a", cDay = "#0ea5e9", cDawn = "#f97316";
            const stops = [], totalDur = endT - startT;
            let curr = new Date(startT);
            while (curr <= endT) {
                const hh = getH(curr), pct = ((curr - startT) / totalDur) * 100;
                const isDay = (hh >= sr && hh < ss);
                let color = isDay ? cDay : cNight;
                if (Math.abs(hh - sr) < 0.8 || Math.abs(hh - ss) < 0.8) color = cDawn;
                stops.push(`${color} ${pct.toFixed(1)}%`); curr.setMinutes(curr.getMinutes() + 30);
            }
            document.getElementById('tafSkyStrip').style.background = `linear-gradient(to right, ${stops.join(', ')})`;
        }

        // ================================================================
        // 19. WORLD CLOCK
        // ================================================================
        async function initWorldClock() {
            if (shouldBackupCities() && navigator.onLine) {
                const cloudCities = await Storage.get('efb_cities_v47');
                if (cloudCities && Array.isArray(cloudCities)) {
                    cityList = cloudCities;
                    localStorage.setItem('efb_cities_v47', JSON.stringify(cityList));
                    return;
                }
            }
            const stored = localStorage.getItem('efb_cities_v47');
            if (stored) {
                cityList = JSON.parse(stored);
            } else {
                cityList = [
                    { n: "Taipei",   icao: "RCTP", z: "Asia/Taipei" },
                    { n: "New York", icao: "KJFK", z: "America/New_York" },
                    { n: "London",   icao: "EGLL", z: "Europe/London" }
                ];
                localStorage.setItem('efb_cities_v47', JSON.stringify(cityList));
            }
        }

        function updateClock() {
            const now = new Date();
            const mainEl = document.getElementById('zuluTimeMain');
            const offsetEl = document.getElementById('zuluTimeOffset');
            
            if (!mainEl || !offsetEl) return;
            
            if (showLocalTime && stationData?.latitude && meteoDataCache) {
                // LOCAL time at the searched airport
                const offsetSec = stationOffsetSec || 0;
                const localTime = new Date(now.getTime() + (offsetSec * 1000));
                const timeStr = `${localTime.getUTCHours().toString().padStart(2,'0')}:${localTime.getUTCMinutes().toString().padStart(2,'0')}`;
                mainEl.innerText = timeStr;
                
                const offsetHrs = Math.round(offsetSec / 3600);
                const sign = offsetHrs >= 0 ? '+' : '';
                offsetEl.innerText = `LOCAL`;
                offsetEl.style.color = 'var(--accent)';
            } else {
                // ZULU time (UTC)
                const zuluStr = `${now.getUTCHours().toString().padStart(2,'0')}:${now.getUTCMinutes().toString().padStart(2,'0')}Z`;
                mainEl.innerText = zuluStr;
                
                // Show UTC offset for current airport if available
                if (stationData?.latitude && meteoDataCache) {
                    const offsetSec = stationOffsetSec || 0;
                    const offsetHrs = Math.round(offsetSec / 3600);
                    if (offsetHrs === 0) {
                        offsetEl.innerText = 'UTC';
                    } else {
                        const sign = offsetHrs > 0 ? '+' : '';
                        offsetEl.innerText = `UTC${sign}${offsetHrs}`;
                    }
                } else {
                    offsetEl.innerText = 'UTC';
                }
                offsetEl.style.color = 'var(--sub-text)';
            }

            // World clock updates (existing code)
            if (document.getElementById('tab-world').classList.contains('active')) {
                const container = document.getElementById('worldContainer');
                container.innerHTML = '';
                cityList.forEach((c, index) => {
                    const timeStr = now.toLocaleTimeString('en-GB', { timeZone: c.z, hour: '2-digit', minute: '2-digit', hour12: false });
                    const cityDate = new Date(now.toLocaleString('en-US', { timeZone: c.z }));
                    const utcDate = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
                    const diffHrs = Math.round((cityDate - utcDate) / 3600000);
                    let offsetLabel = diffHrs === 0 ? "UTC" : (diffHrs > 0 ? `UTC +${diffHrs}` : `UTC ${diffHrs}`);
                    const card = document.createElement('div'); card.className = 'clock-card';
                    card.innerHTML = `
                        <div class="clock-left">
                            <div class="clock-diff">${offsetLabel} ${c.icao ? '• ' + c.icao : ''}</div>
                            <div class="clock-city">${c.n}</div>
                        </div>
                        <div style="display:flex;align-items:center;">
                            <div class="clock-time">${timeStr}</div>
                            <button class="clock-del-btn" onclick="removeCity(${index})">✕</button>
                        </div>`;
                    container.appendChild(card);
                });
            }
        }

        async function savecitiesToCloud() { await Storage.set('efb_cities_v47', cityList); }

        async function promptWorldClockBackup() {
            const mode = localStorage.getItem('efb_storage_mode');
            if (mode !== 'cloud') return;
            if (localStorage.getItem('efb_worldclock_backup_asked')) return;
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed;bottom:max(80px,env(safe-area-inset-bottom)+50px);left:50%;transform:translateX(-50%);background:#1c1c1e;border:1px solid #38383a;color:#fff;padding:14px 16px;border-radius:14px;font-size:13px;z-index:9999;width:90%;max-width:320px;box-shadow:0 8px 24px rgba(0,0,0,0.5);animation:slideUpFade 0.3s ease-out;`;
            toast.id = 'worldClockBackupToast';
            toast.innerHTML = `
                <div style="font-weight:700;margin-bottom:6px;">☁️ Back Up World Clock?</div>
                <div style="font-size:12px;color:#8e8e93;margin-bottom:12px;line-height:1.5;">Save your cities to your Cloud Backup so they restore on any device.</div>
                <div style="display:flex;gap:8px;">
                    <button onclick="declineWorldClockBackup()" style="flex:1;background:#333;border:1px solid #555;color:#8e8e93;padding:8px;border-radius:8px;font-size:12px;cursor:pointer;">No Thanks</button>
                    <button onclick="enableWorldClockBackup()" style="flex:1;background:var(--accent);border:none;color:#fff;padding:8px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">Yes, Back Up</button>
                </div>`;
            document.body.appendChild(toast);
        }

        function declineWorldClockBackup() {
            localStorage.setItem('efb_worldclock_backup_asked', 'declined');
            document.getElementById('worldClockBackupToast')?.remove();
            showToast('👍 Cities saved locally only');
        }

        async function enableWorldClockBackup() {
            localStorage.setItem('efb_worldclock_backup_asked', 'enabled');
            localStorage.setItem('efb_worldclock_backup', 'true');
            document.getElementById('worldClockBackupToast')?.remove();
            await savecitiesToCloud();
            showToast('☁️ Cities backed up!');
        }

        function shouldBackupCities() { return localStorage.getItem('efb_worldclock_backup') === 'true'; }

        async function addCustomCity() {
            const input = document.getElementById('newCityInput');
            const val   = input.value.trim().toUpperCase();
            if (!val) return;
            
            const btn = document.getElementById('btnAddCity');
            btn.innerText = "⏳";
            btn.disabled = true;
            
            try {
                console.log(`[World Clock] Searching for: ${val}`);
                
                // Try AVWX search API
                const res = await secureFetch(`/api/weather?type=search&station=${val}`);
                console.log('[World Clock] Search result:', res);
                
                // Handle various response shapes
                let station;
                if (Array.isArray(res)) {
                    station = res.length > 0 ? res[0] : null;
                } else if (res && typeof res === 'object') {
                    // Check if it's {0: {...}, 1: {...}} format
                    const items = Object.values(res).filter(item => 
                        item && typeof item === 'object' && item.icao
                    );
                    station = items.length > 0 ? items[0] : res;
                } else {
                    station = res;
                }
                
                if (!station || !station.latitude || !station.longitude) {
                    throw new Error("Airport not found in database");
                }
                
                console.log('[World Clock] Station found:', station);
                
                // Get timezone from Open-Meteo
                const tzRes = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${station.latitude}&longitude=${station.longitude}&current=temperature_2m&timezone=auto`
                );
                
                if (!tzRes.ok) throw new Error("Timezone API failed");
                
                const tzData = await tzRes.json();
                console.log('[World Clock] Timezone data:', tzData);
                
                if (!tzData.timezone) {
                    throw new Error("Could not determine timezone");
                }
                
                const cityName = station.city || station.name || station.icao;
                const newCity = { 
                    n: cityName, 
                    icao: station.icao, 
                    z: tzData.timezone 
                };
                
                // Check for duplicates
                const exists = cityList.some(c => c.icao === station.icao);
                if (exists) {
                    showToast(`⚠️ ${station.icao} already in list`);
                    input.value = '';
                    return;
                }
                
                cityList.push(newCity);
                localStorage.setItem('efb_cities_v47', JSON.stringify(cityList));
                
                if (shouldBackupCities()) { 
                    await savecitiesToCloud(); 
                    showToast(`✅ ${cityName} added & backed up`); 
                } else { 
                    promptWorldClockBackup(); 
                }
                
                input.value = '';
                updateClock();
                
            } catch(e) { 
                console.error('[World Clock] Error:', e);
                showToast(`❌ Could not add ${val}. Try a valid ICAO code.`);
            } finally {
                btn.innerText = "Add";
                btn.disabled = false;
            }
        }

        async function removeCity(index) {
            if (confirm("Delete this city?")) {
                cityList.splice(index, 1);
                localStorage.setItem('efb_cities_v47', JSON.stringify(cityList));
                if (shouldBackupCities()) await savecitiesToCloud();
                updateClock();
            }
        }

        // ================================================================
        // 19b. ZULU TIME TOGGLE
        // ================================================================
        let showLocalTime = false;

        function toggleTimeDisplay() {
            if (!stationData?.latitude || !meteoDataCache) {
                showToast('⚠️ Search an airport first');
                return;
            }
            showLocalTime = !showLocalTime;
            updateClock();
            
            // Visual feedback
            const badge = document.getElementById('zuluTime');
            badge.style.transform = 'scale(0.95)';
            setTimeout(() => { badge.style.transform = 'scale(1)'; }, 100);
        }
    
        // ================================================================
        // 20. TOOLS — PERSONAL MINIMUMS & E6B
        // ================================================================
        function checkMins() {
            const xwVal   = document.getElementById('minXW').value;
            const ceilVal = document.getElementById('minCeil').value;
            const resDiv  = document.getElementById('minsResult');
            const card    = document.getElementById('minsCard');
            const banner  = document.getElementById('minBanner');
            if (xwVal === '' || ceilVal === '') {
                resDiv.innerText = "SET LIMITS"; resDiv.style.backgroundColor = "#333"; resDiv.style.color = "#aaa";
                card.style.borderLeftColor = "#555"; banner.className = 'hidden'; return;
            }
            const limitXW   = parseFloat(xwVal);
            const limitCeil = parseFloat(ceilVal);
            Storage.set('efb_min_xw', limitXW); Storage.set('efb_min_ceil', limitCeil);
            if (!currentMetar || !stationData) { resDiv.innerText = "LOAD DATA"; return; }
            const rwyIdent = document.getElementById('rwySelect').value;
            let actualXW = 0;
            if (rwyIdent) {
                const mv     = stationData.magnetic_variation || 0;
                const rwyHdg = parseInt(rwyIdent.replace(/\D/g, '')) * 10;
                const diff   = (currentWind.dir - mv - rwyHdg) * (Math.PI / 180);
                actualXW     = Math.abs(Math.sin(diff) * currentWind.spd);
            }
            let actualCeil = 9999;
            if (lastMetarObj?.clouds) {
                const cl = lastMetarObj.clouds.find(c => ['BKN','OVC','VV'].includes(c.type));
                if (cl) actualCeil = cl.altitude * 100;
            }
            if (actualXW > limitXW || actualCeil < limitCeil) {
                resDiv.innerText = "NO-GO ⛔"; resDiv.style.backgroundColor = "var(--danger)"; resDiv.style.color = "#fff";
                card.style.borderLeftColor = "var(--danger)"; banner.className = '';
                banner.innerText = `⚠️ NO-GO: ${actualXW > limitXW ? 'X-WIND' : 'CEILING'} EXCEEDED`;
            } else {
                resDiv.innerText = "GO ✅"; resDiv.style.backgroundColor = "var(--success)"; resDiv.style.color = "#000";
                card.style.borderLeftColor = "var(--success)"; banner.className = 'hidden';
            }
        }

        function calcE6B() {
            const uQnh  = document.getElementById('unitQnh').value;
            const uTemp = document.getElementById('unitTemp').value;
            document.getElementById('e6bQnh').placeholder  = (uQnh === 'inhg') ? "29.92" : "1013";
            document.getElementById('e6bTemp').placeholder = (uTemp === 'f') ? "59" : "15";
            document.getElementById('e6bDew').placeholder  = (uTemp === 'f') ? "50" : "10";

            let alt     = parseFloat(document.getElementById('e6bAlt').value) || 0;
            let ias     = parseFloat(document.getElementById('e6bIas').value) || 0;
            let rawQnh  = parseFloat(document.getElementById('e6bQnh').value);
            let rawTemp = parseFloat(document.getElementById('e6bTemp').value);
            let rawDew  = parseFloat(document.getElementById('e6bDew').value);

            if (isNaN(rawQnh))  rawQnh  = (uQnh === 'inhg') ? 29.92 : 1013;
            if (isNaN(rawTemp)) rawTemp = (uTemp === 'f') ? 59 : 15;

            let qnhHpa = uQnh === 'inhg' ? rawQnh * 33.8639 : rawQnh;
            let tempC  = uTemp === 'f' ? (rawTemp - 32) * 5/9 : rawTemp;
            let dewC   = isNaN(rawDew) ? null : (uTemp === 'f' ? (rawDew - 32) * 5/9 : rawDew);

            const pa      = alt + (1013.25 - qnhHpa) * 30;
            const isaTemp = 15 - (2 * (pa / 1000));
            const da      = pa + 120 * (tempC - isaTemp);
            const tas     = ias * (1 + ((alt / 1000) * 0.02));
            let cloudBase = "--", freezingLvl = "--";
            if (dewC !== null) { cloudBase = `${Math.round(((tempC - dewC) / 2.5) * 1000)} ft`; }
            if (tempC > 0) { freezingLvl = `${Math.round(alt + (tempC / 2) * 1000)} ft`; } else { freezingLvl = "Surface"; }

            document.getElementById('resDA').innerText    = `${Math.round(da)} ft`;
            document.getElementById('resTAS').innerText   = `${Math.round(tas)} kt`;
            document.getElementById('resCloud').innerText = cloudBase;
            document.getElementById('resFrz').innerText   = freezingLvl;
            const daEl = document.getElementById('resDA');
            daEl.style.color = da > alt + 2000 ? "var(--warn)" : "var(--accent)";
        }

        // ================================================================
        // 21. COCKPIT TIMER
        // ================================================================
        let fuelInterval  = null;
        let fuelSeconds   = 1800;
        let fuelStartValue = 1800;
        let isFuelRunning = false;

        function setFuelTime(minutes) {
            if (isFuelRunning) toggleFuelTimer();
            fuelStartValue = minutes * 60; fuelSeconds = fuelStartValue;
            updateFuelDisplay();
            document.querySelectorAll('#btnFuel15,#btnFuel30,#btnFuel45,#btnFuel60').forEach(b => b.classList.remove('active-fuel'));
            document.getElementById(`btnFuel${minutes}`)?.classList.add('active-fuel');
            resetFuelVisuals();
        }

        function toggleFuelTimer() {
            const btn = document.getElementById('btnFuelStart');
            if (isFuelRunning) {
                clearInterval(fuelInterval); isFuelRunning = false;
                btn.innerText = "RESUME"; btn.style.background = "var(--warn)";
            } else {
                isFuelRunning = true; btn.innerText = "PAUSE"; btn.style.background = "var(--mvfr)";
                fuelInterval = setInterval(() => {
                    if (fuelSeconds > 0) { fuelSeconds--; updateFuelDisplay(); }
                    else { clearInterval(fuelInterval); isFuelRunning = false; fuelAlert(); }
                }, 1000);
            }
        }

        function resetFuelTimer() {
            clearInterval(fuelInterval); isFuelRunning = false;
            fuelSeconds = fuelStartValue; resetFuelVisuals(); updateFuelDisplay();
        }

        function resetFuelVisuals() {
            document.getElementById('btnFuelStart').innerText = "START";
            document.getElementById('btnFuelStart').style.background = "var(--success)";
            document.getElementById('fuelCard').style.background = "var(--card-bg)";
            document.getElementById('fuelDisplay').style.color = "var(--text)";
        }

        function updateFuelDisplay() {
            const m = Math.floor(fuelSeconds / 60).toString().padStart(2, '0');
            const s = (fuelSeconds % 60).toString().padStart(2, '0');
            document.getElementById('fuelDisplay').innerText = `${m}:${s}`;
        }

        function fuelAlert() {
            document.getElementById('fuelCard').style.background = "var(--danger)";
            document.getElementById('fuelDisplay').innerText = "CHECK";
            document.getElementById('fuelDisplay').style.color = "#fff";
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
        }

        // ================================================================
        // 22. SUN TIMES (NOAA Algorithm)
        // ================================================================
        function getSunTimes(lat, lon) {
            const date = new Date();
            const lw   = -lon * Math.PI / 180;
            const phi  = lat * Math.PI / 180;
            const d    = Math.floor(date.getTime() / 86400000) - 10957.5;
            const M    = (357.5291 + 0.98560028 * d) * Math.PI / 180;
            const C    = (1.9148 * Math.sin(M) + 0.0200 * Math.sin(2 * M) + 0.0003 * Math.sin(3 * M)) * Math.PI / 180;
            const L    = (M + C + 102.9372 * Math.PI / 180 + Math.PI) % (2 * Math.PI);
            const sinDec = 0.39779 * Math.sin(L);
            const dec    = Math.asin(sinDec);
            const cosDec = Math.sqrt(1 - sinDec * sinDec);
            const y  = Math.tan(23.4397 * Math.PI / 180 / 2);
            const yy = y * y;
            const J_time = (yy * Math.sin(2 * L) - 2 * 0.01671 * Math.sin(M) + 4 * 0.01671 * yy * Math.sin(M) * Math.cos(2 * L) - 0.5 * yy * yy * Math.sin(4 * L) - 1.25 * 0.01671 * 0.01671 * Math.sin(2 * M)) * 180 / Math.PI * 4;
            const cosH = (Math.sin(-0.833 * Math.PI / 180) - Math.sin(phi) * Math.sin(dec)) / (Math.cos(phi) * cosDec);
            if (cosH > 1 || cosH < -1) return { sunrise: "--:--", sunset: "--:--", rawRise: 0, rawSet: 0 };
            const H            = Math.acos(cosH) * 180 / Math.PI;
            const noonUTC      = 720 - 4 * lon - J_time;
            const riseMinutes  = noonUTC - H * 4;
            const setMinutes   = noonUTC + H * 4;

            function fmt(minutesUTC) {
                if (isNaN(minutesUTC)) return "--:--";
                let ts = new Date();
                ts.setUTCHours(0); ts.setUTCMinutes(0); ts.setUTCSeconds(0);
                let timeStamp = ts.getTime() + (minutesUTC * 60 * 1000);
                if (showLocalSun) timeStamp += (stationOffsetSec * 1000);
                const finalDate = new Date(timeStamp);
                const str = finalDate.toLocaleTimeString('en-GB', { timeZone: 'UTC', hour: '2-digit', minute: '2-digit', hour12: false });
                return str + (showLocalSun ? 'L' : 'Z');
            }
            return { sunrise: fmt(riseMinutes), sunset: fmt(setMinutes), rawRise: riseMinutes / 60, rawSet: setMinutes / 60 };
        }

        function toggleSunFormat() { showLocalSun = !showLocalSun; updateSunDisplay(); }

        function updateSunDisplay() {
            if (!stationData) return;
            const s = getSunTimes(stationData.latitude, stationData.longitude);
            document.getElementById('infoSun').innerText = `🌅 ${s.sunrise}  🌇 ${s.sunset}`;
        }

        // ================================================================
        // 23. FORMATTING HELPERS
        // ================================================================
        function formatRawMetar(rawText) {
            if (!rawText) return "";
            let html = rawText;
            html = html.replace(/(G\d{2,3}KT)/g, '<span style="color:var(--danger);font-weight:800;">$1</span>');
            html = html.replace(/(\s)(M?(\d\/\d|[0-2]))(SM)/g, '$1<span style="color:var(--lifr);font-weight:800;">$2$4</span>');
            html = html.replace(/(VV\d{3}|OVC00[0-4])/g, '<span style="color:var(--danger);font-weight:800;">$1</span>');
            html = html.replace(/(\s)(\+?\w*TS\w*|\+RA|\+SN|SQ|FC)(\s|$)/g, '$1<span style="color:var(--warn);font-weight:800;">$2</span>$3');
            return html;
        }

        function formatNotamText(raw) {
            if (!raw) return "";
            let h = raw;
            h = h.replace(/\b(CLSD|CLOSED|U\/S|UNSERVICEABLE)\b/g, '<span class="n-crit">$1</span>');
            h = h.replace(/\b(OBST|OBSTACLE|WORK|WIP|DANGER|CAUTION|FUGRO)\b/g, '<span class="n-warn">$1</span>');
            h = h.replace(/\b(RWY|TWY|RUNWAY|TAXIWAY|APRON|TWR)\b/g, '<span class="n-bold">$1</span>');
            return h;
        }

        // ================================================================
        // 24. UI HELPERS
        // ================================================================
        function toggleNightMode() {
            document.body.classList.toggle('cockpit-dark');
            const isDark = document.body.classList.contains('cockpit-dark');
            const btn    = document.getElementById('btnNightMode');
            btn.innerHTML = isDark ? "<span>⚪ Day Mode</span>" : "<span>🔴 Cockpit Night Mode</span>";
            btn.style.borderColor = isDark ? "#fff" : "var(--danger)";
            localStorage.setItem('efb_night_mode', isDark ? 'true' : 'false');
            if (document.getElementById('rwySelect').value) drawWindRose();
        }

        function checkNightModeSaved() { if (localStorage.getItem('efb_night_mode') === 'true') toggleNightMode(); }

        function setTab(name) {
                    document.querySelectorAll('.view-section').forEach(el => {
                        el.classList.remove('active');
                        el.style.display = '';
                    });
                    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
                    const targetSection = document.getElementById('tab-' + name);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                        targetSection.classList.add('active');
                    }
                    document.querySelectorAll('.tab').forEach(t => {
                        if (t.getAttribute('onclick')?.includes("'" + name + "'")) t.classList.add('active');
                    });
                    if (name === 'world') updateClock();
                    if (name === 'taf' && meteoDataCache) setTimeout(() => drawMeteogram(meteoDataCache), 50);
                }

        async function checkMultiDashboardEnabled() {
                    const enabled = await Storage.get('efb_multi_dashboard_enabled', false);
                    const toggle = document.getElementById('toggleMultiDashboard');
                    if (toggle) toggle.checked = !!enabled;
                    applyDashboardMode(!!enabled);
                    if (enabled) {
                        await loadMultiAirports();
                        if (multiRefreshInterval) clearInterval(multiRefreshInterval);
                        if (multiAirports.length > 0) {
                            multiRefreshInterval = setInterval(refreshMultiData, 300000);
                        }
                    }
                }
        
                async function toggleMultiDashboard() {
                    const toggle = document.getElementById('toggleMultiDashboard');
                    const enabled = toggle?.checked || false;
                    await Storage.set('efb_multi_dashboard_enabled', enabled);
                    applyDashboardMode(enabled);
                    if (enabled) {
                        setTab('dashboard');
                        await loadMultiAirports();
                        showToast('📊 Dashboard enabled');
                        if (!multiRefreshInterval && multiAirports.length > 0) {
                            multiRefreshInterval = setInterval(refreshMultiData, 300000);
                        }
                    } else {
                        setTab('metar');
                        if (multiRefreshInterval) {
                            clearInterval(multiRefreshInterval);
                            multiRefreshInterval = null;
                        }
                        showToast('Dashboard disabled');
                    }
                }
    
        function applyDashboardMode(enabled) {
            const tabMetar     = document.getElementById('tabMetar');
            const tabTaf       = document.getElementById('tabTaf');
            const tabDashboard = document.getElementById('tabDashboard');
            const tabWeather   = document.getElementById('tabWeather');
        
            if (enabled) {
                tabMetar?.classList.add('hidden');
                tabTaf?.classList.add('hidden');
                tabDashboard?.classList.remove('hidden');
                tabWeather?.classList.remove('hidden');
            } else {
                tabMetar?.classList.remove('hidden');
                tabTaf?.classList.remove('hidden');
                tabDashboard?.classList.add('hidden');
                tabWeather?.classList.add('hidden');
            }
        }
        
        function switchWeatherPane(pane) {
            const metarPane = document.getElementById('weather-metar-pane');
            const tafPane   = document.getElementById('weather-taf-pane');
            const pillMetar = document.getElementById('pillMetar');
            const pillTaf   = document.getElementById('pillTaf');
            if (!metarPane || !tafPane) return;
        
            if (pane === 'taf') {
                metarPane.style.display = 'none';
                tafPane.style.display   = '';
                pillMetar?.classList.remove('active');
                pillTaf?.classList.add('active');
                if (meteoDataCache) setTimeout(() => drawMeteogram(meteoDataCache, true), 50);
            } else {
                tafPane.style.display   = 'none';
                metarPane.style.display = '';
                pillTaf?.classList.remove('active');
                pillMetar?.classList.add('active');
            }
        }
        
        // Mirror all METAR/TAF render calls to the weather tab duplicates
        function mirrorToWeatherTab(m) {
            const enabled = document.getElementById('toggleMultiDashboard')?.checked;
            if (!enabled) return;
        
            // Mirror simple text fields
            const mirrors = [
                ['mWind','mWind2'], ['mVis','mVis2'], ['mCeil','mCeil2'],
                ['mAlt','mAlt2'], ['mTempC','mTempC2'], ['mTempF','mTempF2'],
                ['mAge','mAge2'], ['mSpread','mSpread2'], ['mHumidity','mHumidity2'],
                ['rawMetar','rawMetar2'], ['rawTaf','rawTaf2'],
                ['frMessage','frMessage2'], ['labelCeilVal','labelCeilVal2'],
                ['labelVisVal','labelVisVal2'], ['tafIssued','tafIssued2'],
                ['notamList','notamList2']
            ];
            mirrors.forEach(([orig, copy]) => {
                const o = document.getElementById(orig);
                const c = document.getElementById(copy);
                if (o && c) { c.innerHTML = o.innerHTML; c.style.cssText = o.style.cssText; }
            });
        
            // Mirror gauge widths and colors
            const gauges = [['gaugeCeil','gaugeCeil2'],['gaugeVis','gaugeVis2']];
            gauges.forEach(([orig, copy]) => {
                const o = document.getElementById(orig);
                const c = document.getElementById(copy);
                if (o && c) { c.style.width = o.style.width; c.style.backgroundColor = o.style.backgroundColor; }
            });
        
            // Mirror sky layers
            const sky1 = document.getElementById('skyLayersContainer');
            const sky2 = document.getElementById('skyLayersContainer2');
            if (sky1 && sky2) sky2.innerHTML = sky1.innerHTML;
        
            // Mirror nearby list
            const n1 = document.getElementById('nearList');
            const n2 = document.getElementById('nearList2');
            if (n1 && n2) n2.innerHTML = n1.innerHTML;
        
            // Mirror runway select
            const r1 = document.getElementById('rwySelect');
            const r2 = document.getElementById('rwySelect2');
            if (r1 && r2) { r2.innerHTML = r1.innerHTML; r2.value = r1.value; }
        
            // Mirror AWOS button
            const b1 = document.getElementById('btnFetchLive');
            const b2 = document.getElementById('btnFetchLive2');
            if (b1 && b2) { b2.className = b1.className; }
        
            // Mirror TAF detail card
            const tafFields = [['tdTime','tdTime2'],['tdType','tdType2'],
                               ['tdWind','tdWind2'],['tdVis','tdVis2'],
                               ['tdWx','tdWx2'],['tdCloud','tdCloud2'],
                               ['tafBar','tafBar2'],['tafAxis','tafAxis2'],
                               ['tafSkyStrip','tafSkyStrip2']];
            tafFields.forEach(([orig, copy]) => {
                const o = document.getElementById(orig);
                const c = document.getElementById(copy);
                if (o && c) { c.innerHTML = o.innerHTML; c.style.cssText = o.style.cssText; }
            });
        
            // Mirror wind rose values
            ['valHW','valXW'].forEach(id => {
                const o = document.getElementById(id);
                const c = document.getElementById(id + '2');
                if (o && c) { c.innerHTML = o.innerHTML; c.style.color = o.style.color; }
            });
        
            // Redraw wind rose on weather tab canvas
            const r2sel = document.getElementById('rwySelect2');
            if (r2sel) drawWindRoseOnCanvas('windRose2');
        }
    
        function updateHeaderCat(status, colorClass) {
            const badge = document.getElementById('headerCat');
            badge.innerText = status; badge.className = 'badge badge-cat ' + colorClass;
        }

        function toggleClearBtn() {
            const val = document.getElementById('icao').value;
            document.getElementById('clearBtn').style.display = val ? 'block' : 'none';
        }

        function clearSearch() {
            document.getElementById('icao').value = '';
            document.getElementById('icao').focus();
            toggleClearBtn();
        }

        // ================================================================
        // 25. AWOS MODAL
        // ================================================================
        function openAwosModal() {
            const modal  = document.getElementById('awosModal');
            const iframe = document.getElementById('awosFrame');
            if (!modal || !iframe) { console.error('AWOS modal elements not found'); return; }
            modal.classList.add('active');
            iframe.srcdoc = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-family:-apple-system,sans-serif;flex-direction:column;gap:16px;"><div style="width:40px;height:40px;border:3px solid #333;border-top-color:#0a84ff;border-radius:50%;animation:spin 1s linear infinite;"></div><div style="color:#8e8e93;font-size:13px;">Loading KMHR Live Sensor...</div><style>@keyframes spin{to{transform:rotate(360deg);}}</style></div>`;
            fetch('/api/awos')
                .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); })
                .then(html => { iframe.srcdoc = html; })
                .catch(error => {
                    iframe.srcdoc = `<div style="padding:40px 20px;text-align:center;font-family:-apple-system,sans-serif;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;"><div style="font-size:48px;">⚠️</div><div style="font-size:18px;font-weight:700;">Unable to Load Live Sensor</div><div style="color:#8e8e93;font-size:13px;max-width:280px;">${error.message}<br><br>The KMHR sensor website may be offline or unreachable.</div><a href="http://kmhr.awosnet.com/text.php" target="_blank" style="background:#0a84ff;color:#fff;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;font-size:14px;margin-top:8px;">Open KMHR.net Directly ↗</a></div>`;
                });
        }

        function closeAwosModal() {
            const modal = document.getElementById('awosModal');
            modal.classList.remove('active');
            setTimeout(() => { document.getElementById('awosFrame').srcdoc = ''; }, 300);
        }

        // ================================================================
        // 26. TOAST & OFFLINE BANNER
        // ================================================================
        function showToast(message, duration = 3000) {
            document.querySelector('.toast-msg')?.remove();
            const toast = document.createElement('div');
            toast.className = 'toast-msg'; toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }

        function retryOnline() {
            if (navigator.onLine) { loadData(true); hideOfflineBanner(); }
        }

        function showOfflineBanner(ts) {
            const ageMin = Math.round((Date.now() - ts) / 60000);
            const ageStr = ageMin < 1  ? 'just now'
                         : ageMin < 60 ? `${ageMin}m ago`
                         : `${Math.round(ageMin / 60)}h ago`;

            const banner = document.getElementById('offlineBanner');
            if (!banner) return;

            banner.innerHTML = `
                <span>⚡ OFFLINE MODE</span>
                <span style="margin:0 8px;opacity:0.3;">|</span>
                <span>Showing cached data · ${ageStr}</span>
                <span style="margin-left:8px;background:rgba(0,0,0,0.25);padding:2px 10px;border-radius:10px;font-size:10px;">
                    ${navigator.onLine ? 'Tap to refresh ↻' : 'No connection'}
                </span>`;

            banner.classList.remove('hidden');

            const zuluEl = document.getElementById('zuluTime');
            if (zuluEl) zuluEl.style.borderLeft = '3px solid #ff9f0a';
        }

        function hideOfflineBanner() {
            const banner = document.getElementById('offlineBanner');
            if (banner) banner.classList.add('hidden');
            const zuluEl = document.getElementById('zuluTime');
            if (zuluEl) zuluEl.style.borderLeft = '';
        }

        window.addEventListener('online', () => {
            hideOfflineBanner(); showToast('✅ Back online');
            if (localStorage.getItem('efb_storage_mode') === 'cloud') cloudRestoreAll();
        });
        window.addEventListener('offline', () => { showOfflineBanner(Date.now()); });

        // ================================================================
        // 26b. CLIPBOARD FUNCTIONS
        // ================================================================
        async function copyMetar() {
            const element = document.getElementById('rawMetar');
            const text = element.innerText?.trim();
            if (!text || text.includes('Select an airport') || text.length < 10) {
                showToast('⚠️ No METAR to copy'); return;
            }
            
            try {
                await navigator.clipboard.writeText(text);
                showToast('✅ METAR copied');
            } catch(e) {
                // Fallback for older browsers or iOS
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('✅ METAR copied');
            }
        }

        async function copyTaf() {
            const element = document.getElementById('rawTaf');
            if (!element) return;
            
            const text = element.innerText || element.textContent;
            
            if (!text || text === '--' || text === 'Loading forecast...') {
                showToast('⚠️ No TAF to copy');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(text);
                showToast('✅ TAF copied');
            } catch(e) {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('✅ TAF copied');
            }
        }
    
        // ================================================================
        // 27. LAUNCH ANIMATION & STARTUP
        // ================================================================
        function runLaunchAnimation() {
            return new Promise((resolve) => {
                const screen = document.getElementById('launchScreen');
                if (!screen) { resolve(); return; }
                setTimeout(() => {
                    screen.classList.add('fade-out');
                    setTimeout(() => { screen.style.display = 'none'; resolve(); }, 800);
                }, 3600);
            });
        }

        async function checkCodeAvailability(code) {
            try {
                const res  = await fetch(`/api/settings?pin=${code}`);
                const data = await res.json();
                return data.found;
            } catch(e) { return false; }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                runLaunchAnimation(),
                new Promise(r => setTimeout(r, 100))
            ]);
            initApp();
        // Add this once, after DOMContentLoaded:
        window.addEventListener('resize', () => {
            if (meteoDataCache) drawMeteogram(meteoDataCache);
        });
            
        });

        // ================================================================
        // 27b. SWIPE NAVIGATION
        // ================================================================
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;

        function getTabOrder() {
            const enabled = document.getElementById('toggleMultiDashboard')?.checked;
            if (enabled) return ['dashboard', 'weather', 'info', 'atc', 'world', 'tools', 'settings', 'help'];
            return ['metar', 'taf', 'info', 'atc', 'world', 'tools', 'settings', 'help'];
        }
        function handleSwipe() {
            const swipeThreshold = 80;  // Minimum swipe distance
            const verticalThreshold = 50; // Maximum vertical movement
            
            const horizontalDiff = touchStartX - touchEndX;
            const verticalDiff = Math.abs(touchStartY - touchEndY);
            
            // Ignore if vertical scroll (not a horizontal swipe)
            if (verticalDiff > verticalThreshold) return;
            
            // Ignore if swipe too short
            if (Math.abs(horizontalDiff) < swipeThreshold) return;
            
            // Get current active tab
            const currentTab = document.querySelector('.view-section.active')?.id.replace('tab-', '');
            if (!currentTab) return;
            
            const tabOrder = getTabOrder();
            const currentIndex = tabOrder.indexOf(currentTab);
            if (currentIndex === -1) return;
            
            let newIndex;
            
            if (horizontalDiff > 0) {
                newIndex = (currentIndex + 1) % tabOrder.length;
            } else {
                newIndex = (currentIndex - 1 + tabOrder.length) % tabOrder.length;
            }
            
            setTab(tabOrder[newIndex]);
            
            // Visual feedback
            const newTab = document.getElementById(`tab-${tabOrder[newIndex]}`);
            if (newTab) {
                newTab.style.animation = 'none';
                setTimeout(() => {
                    newTab.style.animation = '';
                }, 10);
            }
        }

        // Only enable swipe on touch devices
        if ('ontouchstart' in window) {
            document.addEventListener('touchstart', e => {
                // Ignore if touching an input, button, or scrollable element
                const target = e.target;
                if (target.tagName === 'INPUT' || 
                    target.tagName === 'BUTTON' || 
                    target.tagName === 'SELECT' ||
                    target.closest('.metar-grid') ||
                    target.closest('.raw-text') ||
                    target.closest('canvas')) {
                    return;
                }
                
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            document.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });
        }

        // ================================================================
        // 28. MULTI-AIRPORT DASHBOARD
        // ================================================================
        let multiAirports = [];
        let multiDataCache = {};
        let multiRefreshInterval = null;

        async function loadMultiAirports() {
            // Try cloud first, then local
            const cloudData = await Storage.get('efb_multi_airports');
            const localData = localStorage.getItem('efb_multi_airports');
            
            if (cloudData && Array.isArray(cloudData)) {
                multiAirports = cloudData;
            } else if (localData) {
                multiAirports = JSON.parse(localData);
            } else {
                multiAirports = [];
            }
            renderMultiDashboard();
            
            // Auto-refresh every 5 minutes
            if (multiRefreshInterval) clearInterval(multiRefreshInterval);
            if (multiAirports.length > 0) {
                refreshMultiData();
                multiRefreshInterval = setInterval(refreshMultiData, 300000);
            }
        }

        async function saveMultiAirports() {
            localStorage.setItem('efb_multi_airports', JSON.stringify(multiAirports));
            await Storage.set('efb_multi_airports', multiAirports);
        }

        async function addMultiAirport() {
            const input = document.getElementById('multiAddInput');
            const icao = input.value.trim().toUpperCase();
            
            if (!icao || icao.length !== 4) {
                showToast('⚠️ Enter a valid 4-letter ICAO code');
                return;
            }
            
            if (multiAirports.includes(icao)) {
                showToast('⚠️ Already tracking ' + icao);
                return;
            }
            
            if (multiAirports.length >= 8) {
                showToast('⚠️ Maximum 8 airports');
                return;
            }
            
            multiAirports.push(icao);
            saveMultiAirports();
            input.value = '';
            
            renderMultiDashboard();
            fetchMultiAirportData(icao);
            
            if (!multiRefreshInterval) {
                multiRefreshInterval = setInterval(refreshMultiData, 300000);
            }
        }

        function removeMultiAirport(icao) {
            multiAirports = multiAirports.filter(i => i !== icao);
            delete multiDataCache[icao];
            saveMultiAirports();
            renderMultiDashboard();
            
            if (multiAirports.length === 0 && multiRefreshInterval) {
                clearInterval(multiRefreshInterval);
                multiRefreshInterval = null;
            }
        }

        async function fetchMultiAirportData(icao) {
            try {
                const metar = await secureFetch(`/api/weather?type=metar&station=${icao}`);
                if (metar && !metar.error) {
                    multiDataCache[icao] = {
                        metar: metar,
                        fetchTime: Date.now()
                    };
                    renderMultiCard(icao);
                }
            } catch(e) {
                console.error(`[Multi] Error fetching ${icao}:`, e);
            }
        }

        async function refreshMultiData() {
            console.log('[Multi] Refreshing all airports...');
            for (const icao of multiAirports) {
                await fetchMultiAirportData(icao);
            }
        }

        function renderMultiDashboard() {
            const grid = document.getElementById('multiGrid');
            
            if (multiAirports.length === 0) {
                grid.innerHTML = '<div class="multi-loading">Add airports above to start tracking</div>';
                return;
            }
            
            grid.innerHTML = multiAirports.map(icao => {
                const cached = multiDataCache[icao];
                if (!cached) {
                    return `
                        <div class="multi-card">
                            <div class="multi-header">
                                <div class="multi-icao">${icao}</div>
                                <div class="multi-remove" onclick="event.stopPropagation(); removeMultiAirport('${icao}')">×</div>
                            </div>
                            <div class="multi-loading">Loading...</div>
                        </div>`;
                }
                
                return renderMultiCardHTML(icao, cached);
            }).join('');
        }

        function renderMultiCard(icao) {
            const cached = multiDataCache[icao];
            if (!cached) return;
            
            const cardEl = document.querySelector(`[data-icao="${icao}"]`);
            if (cardEl) {
                cardEl.outerHTML = renderMultiCardHTML(icao, cached);
            } else {
                renderMultiDashboard();
            }
        }

        function renderMultiCardHTML(icao, cached) {
            const m = cached.metar;
            const rules = m.flight_rules || 'UNKN';
            const rulesColor = {
                VFR: 'var(--success)',
                MVFR: 'var(--mvfr)',
                IFR: 'var(--danger)',
                LIFR: 'var(--lifr)'
            }[rules] || '#555';
            const rulesBg = {
                VFR: 'var(--success)',
                MVFR: 'var(--mvfr)',
                IFR: 'var(--danger)',
                LIFR: 'var(--lifr)'
            }[rules] || '#555';
        
            const ageMin = Math.floor((Date.now() - new Date(m.time.dt)) / 60000);
            const ageColor = ageMin > 60 ? 'var(--danger)' : 'var(--sub-text)';
            const rawMetar = m.raw || 'No raw data';
        
            return `
                <div class="multi-card" data-icao="${icao}" onclick="loadMultiAirport('${icao}')">
                    <div class="multi-header">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div class="multi-icao">${icao}</div>
                            <div style="background:${rulesBg};color:${rules==='VFR'?'#000':'#fff'};font-size:11px;font-weight:900;padding:3px 9px;border-radius:5px;letter-spacing:0.5px;">${rules}</div>
                        </div>
                        <div class="multi-remove" onclick="event.stopPropagation(); removeMultiAirport('${icao}')">×</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.04);border-radius:6px;padding:10px 10px 8px;font-family:'SF Mono',monospace;font-size:12px;color:#e0e0e0;line-height:1.6;word-break:break-all;white-space:pre-wrap;margin-top:6px;">${formatRawMetar(rawMetar)}</div>
                    <div class="multi-age" style="color:${ageColor};margin-top:6px;">${ageMin > 60 ? '⚠️ ' : ''}${ageMin}m ago · Tap to load full data</div>
                </div>`;
        }

        function loadMultiAirport(icao) {
            document.getElementById('icao').value = icao;
            loadData();
            const enabled = document.getElementById('toggleMultiDashboard')?.checked;
            setTab(enabled ? 'weather' : 'metar');
            showToast(`Loading ${icao}...`);
        }
    
    </script>
</body>
</html>
